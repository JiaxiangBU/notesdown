--- 
title: "A Minimal Book Example"
author: "黄湘云"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
geometry: margin=1.18in
documentclass: ctexbook
bibliography: [book.bib, packages.bib]
biblio-style: apalike
lof: yes
lot: yes
graphics: yes
tables: yes
link-citations: yes
colorlinks: yes
classoption: "hyperref, a4paper, UTF8, zihao = -4, linespread = 1.3"
description: "This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook."
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = TRUE,
  # cache = TRUE,
  out.width = "70%",
  fig.align = 'center',
  fig.width = 6,
  fig.asp = 0.618,  # 1 / phi
  fig.show = "hold"
)
```

\mainmatter

# 前言 {#preface}

This is a _sample_ book written in **Markdown**. You can use anything that Pandoc's Markdown supports, e.g., a math equation $a^2 + b^2 = c^2$.

The **bookdown** package can be installed from CRAN or Github:

```{r eval=FALSE}
install.packages("bookdown")
# or the development version
# devtools::install_github("rstudio/bookdown")
```

Remember each Rmd file contains one and only one chapter, and a chapter is defined by the first-level heading `#`.

To compile this example to PDF, you need XeLaTeX. You are recommended to install TinyTeX (which includes XeLaTeX): <https://yihui.name/tinytex/>.

Pandoc\index{Pandoc} and Hugo\index{Hugo}

## 配色

```{r color-pakages}
Pkgs <- c(
  "colorspace", "scales", "palr", "colortools", "colormap", "colormap",
  "dichromat", "yarrr", "colorRamps", "ColorPalette","pals"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) install.packages(setdiff(Pkgs, .packages(TRUE)))
```

彩带

```{r}
# 代码来自 ?rainbow_hcl
pal <- function(colorname, border = "light gray", ...){
	n <- length(colorname)
	plot(0, 0, type="n", xlim = c(0, 1), ylim = c(0, 1),
		axes = FALSE, ...)
	rect(0:(n-1)/n, 0, 1:n/n, 1, col = colorname, border = border)
}
```


早些时候我在统计之都论坛上发帖 -- R语言绘图用调色板大全 <https://d.cosx.org/d/419378-r>

阐述色理 HCL RGB CMYK 
Adobe RGB  sRGB   P3广色域  
2K 4K 5K  视网膜屏  普清  高清 超高清 全高清 显示器 
打印机  照相机 

为什么需要这么多颜色模式

知道颜色模式及其之间的转化
颜色空间及其区别 HCL and HSV color spaces
基于网页、人眼、打印机使用不同的颜色模式为何

君子爱色，取之有道：有些人功力深厚，黑白灰几乎打遍天下无敌手，如科波拉执导的《教父》、沃卓斯基执导的《黑客帝国》等等，但我还是要说，好色乃人之本性也，花花世界，岂能都是法印眼中的白骨！
《红楼梦》里，芍药丛中，桃花树下，滴翠亭边，栊翠庵里，处处都是湘云、黛玉、宝钗、妙玉留下的赞歌。情景融合，王扶林，周汝昌 李耀宗

- 君子爱色，取之有道

哪里可以获取颜色

grDevices [@R-base] colorspace [@R-colorspace] RColorBrewer [@R-RColorBrewer]
基本够用

取之有道 拿人家的颜色 一定要记得引用啊，我这里要是还有哪里没有引用到的一定要提出来

18个R包 所谓降龙十八掌 要想降住色魔，非得十八掌不可


- 颜色空间

确定一种颜色，我们需要知道 色相 饱和度 明度 颜色的三个属性， 

### RGB

红(red)、绿(green)、蓝(blue)是三原色

```r
rgb(red, green, blue, alpha, names = NULL, maxColorValue = 1)
```

函数参数说明：

- __red, blue, green, alpha__ 取值范围[0,M]，M 是 *maxColorValue*
- __names__ 字符向量，给这组颜色值取名
- __maxColorValue__ 红，绿，蓝三色范围的最大值 

The colour specification refers to the standard sRGB colorspace (IEC
standard 61966).

rgb 产生一种颜色，如 `rgb(255, 0, 0, maxColorValue = 255)` 的颜色是 `"#FF0000"` ，这是一串16进制数，每两个一组，那么一组有 $16^2 = 256$ 种组合，整个一串有 $256^3 = 16777216$ 种组合，这就是RGB表达的所有颜色。用色轮示意，如图 \@ref(fig:RGBwheel)

```{r RGBwheel,fig.cap="RGB 色轮"}
op <- par(mar=c(0,0,0,0))
n <- 1000
pie(rep(1,times = n),labels = "", col = rainbow(n), border = FALSE)
par(op)
```

```{r custom,fig.cap="colorRampPalette自制调色板"}
# colorRampPalette自制调色板
op <- par(mfrow = c(3, 1),mar = c(0.1, 0.1, 0.5, 0.1),xaxs = "i", yaxs = "i")
n <- 1000
mycolors <- colorRampPalette(c("blue", "orangeRed"))(n)
barplot(rep(1, times = n), col = mycolors, border = mycolors, axes = FALSE)
box()
mycolors <- colorRampPalette(c("darkgreen", "yellow", "orangered"))(n)
barplot(rep(1, times = n), col = mycolors, border = mycolors, axes = FALSE)
box()
mycolors <- colorRampPalette(c("blue", "white", "darkgreen", "yellow", "orangered"), bias = 1.2)(n)
barplot(rep(1, times = n), col = mycolors, border = mycolors, axes = FALSE)
box()
par(op)
```

### HSL

色相饱和度亮度 hue–saturation–luminance (HSL)

### HSV 

Create a vector of colors from vectors specifying hue, saturation and value.	色相饱和度值

```r	
hsv(h = 1, s = 1, v = 1, alpha)
```

This function creates a vector of colors corresponding to the given values in HSV space.
rgb and rgb2hsv for RGB to HSV conversion;


hsv函数通过设置色调、饱和度和亮度获得颜色，三个值都是0-1的相对量

```{r,fig.cap="色相、饱和度和亮度"}
op <- par(mfcol = c(11, 121), mar = c(0, 0, 0, 0), xaxs = "i", yaxs = "i")
x <- seq(0, 10) / 10
ndx <- expand.grid(x, x, x)
mycolor <- hsv(ndx[, 3], ndx[, 2], ndx[, 1])
for (i in 1:nrow(ndx)) {
  barplot(1, col = mycolor[i], border = mycolor[i], axes = FALSE)
}
par(op)
```

RGB HSV HSL 都是不连续的颜色空间，缺点

### HCL 

基于感知的颜色空间替代RGB颜色空间

通过指定色相(hue)，色度(chroma)和亮度(luminance/lightness)，创建一组（种）颜色

```r			
hcl(h = 0, c = 35, l = 85, alpha, fixup = TRUE)
```

函数参数说明：

- __h__ 颜色的色调，取值范围为[0,360]，0、120、240分别对应红色、绿色、蓝色

- __c__ 颜色的色度，其上界取决于色调和亮度

- __l__ 颜色的亮度，取值范围[0,100]，给定色调和色度，只有一部分子集可用

- __alpha__ 透明度，取值范围[0,1]，0 和1分别表示透明和不透明

This function corresponds to polar coordinates in the CIE-LUV color space


### CMYK

印刷三原色：青 (cyan)、品红 (magenta)、黄 (yellow)

- 颜色模式转化

`col2rgb` 、`rgb2hsv` 和 `rgb` 函数 [@R-base] 
`hex2RGB` 函数 [@R-colorspace] 
*col2hcl*函数 [@R-scales] 
*col2HSV*  [@R-colortools]
*col2hex* [@R-palr]

这里应该有个思维导图

```{r,echo=TRUE}
col2rgb("lightblue")  # color to  RGB
scales::col2hcl("lightblue") # color to HCL
palr::col2hex("lightblue") # color to HEX
colortools::col2HSV("lightblue") # color to HSV
```

```{r,echo=TRUE}
rgb(173,216,230,maxColorValue = 255) # RGB to HEX
colorspace::hex2RGB("#ADD8E6")  # HEX to RGB
rgb(.678,.847,.902,maxColorValue = 1) # RGB to HEX
rgb2hsv(173,216,230,maxColorValue = 255) # RGB to HSV
```

选色为什么这么难

```{r problem,fig.cap="源起",fig.height=12}
op <- par(mar = c(1, 2, 1, 0), mfrow = c(4, 2))
set.seed(1234)
barplot(sample(seq(8), 8, replace = FALSE), col = palette(), border = "white")
set.seed(1234)
barplot(sample(seq(8), 8, replace = FALSE), col = heat.colors(8), border = "white")
set.seed(1234)
barplot(sample(seq(8), 8, replace = FALSE), col = gray.colors(8), border = "white")
set.seed(1234)
barplot(sample(seq(8), 8, replace = FALSE), col = "lightblue", border = "white")
barplot(seq(8), col = gray.colors(8), border = "white")
barplot(seq(8), col = "lightblue", border = "white")
barplot(sample(seq(8), 8, replace = FALSE), col = colorspace::sequential_hcl(8), border = "white")
barplot(sample(seq(8), 8, replace = FALSE),
  col = colorspace::diverge_hcl(8, h = c(130, 43), c = 100, l = c(70, 90)), border = "white"
)
par(op)
```


黑西装、黑领带和白衬衫，让人一下子想到了电影《黑客帝国》，构建了整幅画轴，黑领带换黑领结和红玫瑰，转而又想到电影《教父》的主角维托$\cdot$唐$\cdot$科莱昂，黑白灰就占了电影的主色调。这么素的颜色怎么就能这么丰富呢？这就是配色的技艺了！


色相与阴影相比是无关紧要的，色相对于标记和分类很有用，但表示（精细的）空间数据或形状的效果较差。颜色是改善图形的好工具，但糟糕的配色方案 (color schemes) 可能会导致比灰度调色板更差的效果。[@meteorological2009]


黑、白、灰，看似有三种颜色，其实只有一种颜色，黑和白只是灰色的两极，那么如何设置灰色梯度，使得人眼比较好区分它们呢？这样获得的调色板适用于什么样的绘图环境呢？

R预置的灰色有224种，挑出其中的调色板

```{r,echo=TRUE}
grep( "^gr(a|e)y" , grep("gr(a|e)y" , colors() ,value = TRUE),value = TRUE,invert = TRUE)
```

```{r gray1,fig.width=8,fig.height=1.5,fig.cap="灰度调色板"}
gray_colors <- paste0(rep(c("slategray", "darkslategray"), each = 4), seq(4))
op <- par(mar = c(0, 0, 2, 0))
pal(gray_colors, main = toString(gray_colors), cex.main = .9)
par(op)
```

gray 与 grey 是一样的，类似 color 和 colour 的关系，可能是美式和英式的差别，且看

```{r,echo=TRUE}
all.equal( col2rgb( paste0("gray",seq(100) ) ), col2rgb( paste0( "grey", seq(100) ) ) )
```

`gray100` 代表白色，`gray0` 代表黑色，提取灰色调色板，去掉首尾部分是必要的

```{r gray2,echo=TRUE,fig.width=8,fig.height=2,fig.cap="提取10种灰色做调色板"}
op <- par(mfrow = c(2,1), mar=c(0,0,2,0))
n <- 10 # 提取 n 种灰色
pal(paste0("gray", round( seq( from = 29, to = 89, length.out = n ) ) ), main = "custom color palette")
pal(gray.colors(10, start = .3, end = .9), main = "gray.colors function")
par(op)
```

比较 viridis 和 Spectral 两块调色板，如图 \@ref(fig:pickcolor) 所示，可见 Spectral 的可识别性高些

```{r pickcolor,fig.width=12,fig.height=5,out.width="100%",fig.cap="viridis 和 Spectral对比"}
dat <- as.data.frame(cbind(rep(1948 + seq(12), each = 12), rep(seq(12), 12), AirPassengers))
colnames(dat) <- c("year", "month", "passengers")
library(ggplot2)
library(colormap)
library(gridExtra)
viridis <- ggplot(data = dat, aes(as.factor(year), as.factor(month))) +
  geom_point(pch = 15, size = 8, aes(color = passengers)) +
  scale_color_colormap(colormap = colormaps$viridis) +
  labs(x = "Year", y = "Month", colour = "Passengers") +
  theme_minimal()
Spectral <- ggplot(data = dat, aes(as.factor(year), as.factor(month))) +
  geom_point(aes(colour = passengers), pch = 15, size = 8) +
  scale_colour_distiller(palette = "Spectral") +
  labs(x = "Year", y = "Month", colour = "Passengers") +
  theme_minimal()
grid.arrange(viridis, Spectral, ncol = 2)
```

再举栗子，图\@ref(fig:faithfuld)是正负例对比，其中好在哪里呢？这张图要表达美国黄石国家公园的老忠实泉间歇喷发的时间规律，那么好的标准就是层次分明，以突出不同颜色之间的时间差异。这个差异，还要看起来不那么费眼睛，越一目了然越好。

```{r faithfuld,fig.cap="美国黄石国家公园的老忠实泉"}
erupt <- ggplot(faithfuld, aes(waiting, eruptions, fill = density)) +
  geom_raster() +
  scale_x_continuous(NULL, expand = c(0, 0)) +
  scale_y_continuous(NULL, expand = c(0, 0)) +
  theme(legend.position = "none")
erupt1 <- erupt + scale_fill_gradientn(colours = gray.colors(7))
erupt2 <- erupt + scale_fill_distiller(palette = "Spectral")
erupt3 <- erupt + scale_fill_gradientn(colours = terrain.colors(7))
erupt4 <- erupt + scale_fill_colormap(colormap = colormaps$RdBu)
grid.arrange(erupt1, erupt2, erupt3, erupt4, ncol = 2)
```

RColorBrewer 包 提供了有序 (Sequential) 、定性 (Qualitative) 和发散 (Diverging)  三类调色板，一般来讲，分别适用于连续或有序分类变量、无序分类变量、两类分层对比变量的绘图。再加上强大的 ggplot2 包内置的对颜色处理的函数，如 `scale_alpha_*` 、 `scale_colour_*` 和 `scale_fill_*` 等，详见：

```{r,echo=TRUE}
ls("package:ggplot2",pattern = "scale_col(ou|o)r_")
ls("package:ggplot2",pattern = "scale_fill_")
```


除之前提到的 grDevices 包[@R-base] 、colorspace 包 [@R-colorspace]和 RColorBrewer 包 [@R-RColorBrewer] 之外，此处还收录 yarrr 包[@R-yarrr] 、dichromat 包[@R-dichromat] 、colormap 包[@R-colormap]、viridis 包[@R-viridis]、pals 包[@R-pals] 、ColorPalette 包[@R-ColorPalette]、colorRamps包 [@R-colorRamps]、colortools包[@R-colortools] ，此外还有 palr 包[@R-palr] 就不一一收录了

```{r palettes,fig.height=5.5,fig.width=6,fig.cap="grDevices调色板1"}
# 代码来自 ?palettes
demo.pal <-
  function(n, border = if (n < 32) "light gray" else NA,
           main = paste("color palettes: alpha = 1,  n=", n),
           ch.col = c("rainbow(n, start=.7, end=.1)", "heat.colors(n)",
                      "terrain.colors(n)", "topo.colors(n)",
                      "cm.colors(n)","gray.colors(n, start = 0.3, end = 0.9)"))
{
    nt <- length(ch.col)
    i <- 1:n; j <- n / nt; d <- j/6; dy <- 2*d
    plot(i, i+d, type = "n", axes = FALSE, ylab = "",xlab = "", main = main)
    for (k in 1:nt) {
        rect(i-.5, (k-1)*j+ dy, i+.4, k*j,
             col = eval(parse(text = ch.col[k])), border = border)
        text(2*j,  k * j + dy/4, ch.col[k])
    }
}
n <- if(.Device == "postscript") 64 else 16
# Since for screen, larger n may give color allocation problem
op <- par(mar=c(0,0,2,0))
demo.pal(n)
par(op)
```

```{r democolors,fig.width=8,fig.height=11,fig.align='center',fig.cap="grDevices调色板2"}
op <- par(mfrow =c(33,1),mar=c(0,0,.8,0))
 for( i in seq(32)) {
	  pal( colors()[ (1+20*(i-1)) : (20*i) ] ,main = paste(1+20*(i-1),"to", 20*i))
}
pal( colors()[ 641 : 657 ], main = "641 to 657") 
par(op)
```


```{r ColorPalette,fig.width=8,fig.height=3,fig.cap="ColorPalette调色板"}
library(ColorPalette)
op <- par(mfrow=c(4,1),mar=c(0,0,2,0))
pal(generateMonochromaticColors("lightblue", 16),main = "generateMonochromaticColors")
pal(complementColors("lightblue", 16),main = "complementColors")
pal(tetradicColors("lightblue",16),main = "tetradicColors")
pal(triadicColors("lightblue",16), main = "triadicColors")
par(op)
```

```{r colorRamps,fig.width=8,fig.height=4,fig.cap="colorRamps调色板"}
library(colorRamps)
op <- par(mfrow=c(6,1),mar=c(0,0,2,0))
n <- 16
pal(matlab.like(n),main = "matlab.like")
pal(matlab.like2(n),main = "matlab.like2")
pal(blue2green2red(n),main = "blue2green2red")
pal(primary.colors(n), main = "primary.colors")
pal(ygobb(n), main = "ygobb")
pal(rgb.tables(n), main = "rgb.tables")
par(op)
```

```{r viridis,fig.width=8,fig.height=3,fig.cap="viridis调色板"}
library(viridisLite)
library(viridis)
n <- 16
op <- par(mfrow=c(4,1),mar=c(0,0,2,0))
pal(viridis_pal(alpha = 1, begin = 0, end = 1, option = "A")(n), main = "magma")
pal(viridis_pal(alpha = 1, begin = 0, end = 1, option = "B")(n), main = "inferno")
pal(viridis_pal(alpha = 1, begin = 0, end = 1, option = "C")(n), main = "plasma")
pal(viridis_pal(alpha = 1, begin = 0, end = 1, option = "D")(n), main = "viridis")
par(op)
```


```{r pals1,fig.width=8,fig.height=8,fig.cap="pals调色板1",message=FALSE,eval=FALSE}
op <- par(mfrow=c(2,1),mar=c(0,3,2,0))
library(pals)
pals::pal.bands(coolwarm, parula, ocean.haline, cubicl, kovesi.rainbow,
          ocean.phase, brewer.paired(12), stepped,
          main="Colormap suggestions")

# Qualtitative
pals::pal.bands(brewer.accent(8), brewer.dark2(8), brewer.paired(12), brewer.pastel1(9),
          brewer.pastel2(8), brewer.set1(9), brewer.set2(8), brewer.set3(10),
          labels=c("brewer.accent", "brewer.dark2", "brewer.paired", "brewer.pastel1",
                   "brewer.pastel2", "brewer.set1", "brewer.set2", "brewer.set3"),
          main="Brewer qualitative")
par(op)
```

```{r pals2,fig.width=8,fig.height=8,fig.cap="pals调色板2",message=FALSE,eval=FALSE}
op <- par(mfrow=c(2,1),mar=c(0,3,2,0))
# Sequential
pals::pal.bands(brewer.blues, brewer.bugn, brewer.bupu, brewer.gnbu, brewer.greens,
          brewer.greys, brewer.oranges, brewer.orrd, brewer.pubu, brewer.pubugn,
          brewer.purd, brewer.purples, brewer.rdpu, brewer.reds, brewer.ylgn,
          brewer.ylgnbu, brewer.ylorbr, brewer.ylorrd,
          main="Brewer sequential")

# Diverging
pals::pal.bands(brewer.brbg, brewer.piyg, brewer.prgn, brewer.puor, brewer.rdbu,
          brewer.rdgy, brewer.rdylbu, brewer.rdylgn, brewer.spectral,
          main="Brewer diverging")
par(op)
```

```{r colortools1,fig.width=6,fig.height=6,fig.cap="colortools调色板1"}
colortools::pals()
```

```{r colortools2,fig.width=6,fig.height=6,results='hide',fig.cap="colortools调色板2"}
colortools::wheel(colortools::pals("fish")[1], bg = "white")
```


```{r colorspace,fig.width=8,fig.height=8,fig.cap="colorspace调色板"}
library(colorspace)
## a few useful diverging HCL palettes
op <- par(mar = c(0,0,2,0), mfrow = c(16, 2))

pal(diverge_hcl(16), main = "diverging HCL palettes")
pal(diverge_hcl(16, h = c(246, 40), c = 96, l = c(65, 90)))
pal(diverge_hcl(16, h = c(130, 43), c = 100, l = c(70, 90)))
pal(diverge_hcl(16, h = c(180, 70), c = 70, l = c(90, 95)))

pal(diverge_hcl(16, h = c(180, 330), c = 59, l = c(75, 95)))
pal(diverge_hcl(16, h = c(128, 330), c = 98, l = c(65, 90)))
pal(diverge_hcl(16, h = c(255, 330), l = c(40, 90)))
pal(diverge_hcl(16, c = 100, l = c(50, 90), power = 1))

## sequential palettes
pal(sequential_hcl(16), main= "sequential palettes")
pal(heat_hcl(16, h = c(0, -100), l = c(75, 40), c = c(40, 80), power = 1))
pal(terrain_hcl(16, c = c(65, 0), l = c(45, 95), power = c(1/3, 1.5)))
pal(heat_hcl(16, c = c(80, 30), l = c(30, 90), power = c(1/5, 1.5)))

## compare base and colorspace palettes
## (in color and desaturated)
## diverging red-blue colors
pal(diverge_hsv(16), main = "diverging red-blue colors")
pal(diverge_hcl(16, c = 100, l = c(50, 90)))
pal(desaturate(diverge_hsv(16)))
pal(desaturate(diverge_hcl(16, c = 100, l = c(50, 90))))

## diverging cyan-magenta colors
pal(cm.colors(16), main = "diverging cyan-magenta colors")
pal(diverge_hcl(16, h = c(180, 330), c = 59, l = c(75, 95)))
pal(desaturate(cm.colors(16)))
pal(desaturate(diverge_hcl(16, h = c(180, 330), c = 59, l = c(75, 95))))

## heat colors
pal(heat.colors(16), main = "heat colors")
pal(heat_hcl(16))
pal(desaturate(heat.colors(16)))
pal(desaturate(heat_hcl(16)))

## terrain colors
pal(terrain.colors(16), main = "terrain colors")
pal(terrain_hcl(16))
pal(desaturate(terrain.colors(16)))
pal(desaturate(terrain_hcl(16)))

pal(rainbow_hcl(16, start = 30, end = 300), main = "dynamic")
pal(rainbow_hcl(16, start = 60, end = 240), main = "harmonic")
pal(rainbow_hcl(16, start = 270, end = 150), main = "cold")
pal(rainbow_hcl(16, start = 90, end = -30), main = "warm")

par(op)
```

```{r RColorBrewer,fig.height=8,fig.cap="RColorBrewer调色板"}
op <- par(mar=c(0,4,0,0))
RColorBrewer::display.brewer.all()
par(op)
```

```{r yarrr, fig.width = 8, fig.height = 7,fig.cap="yarrr调色板"}
yarrr::piratepal(palette = "all")
```

```{r dichromat,fig.height=4,fig.width=6,fig.cap="dichromat调色板适用于色盲人群"}
library(dichromat) 
op <- par(mar=c(0,0,2,0),mfrow = c(9,2))
for(i in seq(17)){
	pal(colorschemes[[i]], main =  names(colorschemes)[i])
} 
par(op)
```

```{r colormap,fig.width=10,fig.height=12,results='hide',fig.align='center',fig.cap="colormap调色板"}
library(colormap)
color_map <- function(colorname, border = "light gray"){ 
	col <- colormap_pal(colormap=colorname)(25)
	n <- length(col)
	plot(0, 0, type="n", xlim = c(0, 1), ylim = c(0, 1),
		axes = FALSE, xlab = "", ylab = "")
	rect(0:(n-1)/n, 0, 1:n/n, 1, col = col, border = border)
	text(.5,.5,labels = colorname)
}
op <- par(mfrow = c(22,2),mar = c(0, 0, 1, 0))
invisible( lapply(unlist(colormaps),color_map) )
par(op)
```

## 读图

导入 SVG 格式的图片, rsvg [@R-rsvg] 批量转化 svg 文件为 pdf 文件

```{r rsvg, eval = (!"webp" %in% .packages(TRUE))}
install.packages(c("webp","rsvg"), dependencies = TRUE)
```

```r
library(rsvg)
tmp <- "figure/Ink" # svgs 存放目录
input_paths <- paste0(tmp, "/", list.files(tmp))
output_paths <- paste0("figure/pdf", "/", gsub("svg", "pdf", list.files(tmp)))

for (i in seq(length(list.files(tmp)))) {
  rsvg_pdf(input_paths[i], file = output_paths[i])
}
```

pdftools [@R-pdftools] 文本提取，渲染和转化 PDF 文档

```{r, eval= (!"pdftools" %in% .packages(TRUE))}
install.packages("pdftools")
```


magick 的简单使用

```{r, eval= (!"magick" %in% .packages(TRUE))}
install.packages("magick")
```

插入 Inkscape 图标，如图

```{r inkscape-logo, eval = knitr::is_latex_output(),fig.cap="Inkscape 图标"}
library(magick)
magick::image_read_svg(path = "figures/inkscape.svg")
```

`r if (knitr::is_html_output()) '
![](figures/inkscape.svg)'
`

安装依赖库

```bash
sudo apt-get update && sudo apt-get install -y libgsl-dev libdieharder-dev
```

安装并加载 RDieHarder 包

```{r}
if (!"RDieHarder" %in% list.files(.libPaths())) install.packages("RDieHarder")
library(RDieHarder) # 加载
```

RDieHarder [@R-RDieHarder] 由 Dirk Eddelbuettel 开发，将 Robert G. Brown 的工作介绍给 R 用户

```{r}
if (!"purrr" %in% list.files(.libPaths())) install.packages("purrr")
library(purrr)
dieharderGenerators() %>% head
```

```{r}
dieharderTests() %>% head
```


```{r run-length-hist, fig.cap='游程直方图', fig.showtext=TRUE}
set.seed(2018) 
n <- 2^24
x <- runif(n,0,1)
delta <- 0.01
len <- diff(c(0,which(x < delta),n+1))-1
ylim <- seq( 0, 1800, by = 300)
xlim <- seq( 0, 100, by = 20)
p <- hist(len[len < 101], breaks = -1:100+0.5, plot = FALSE)
par(mar = c(2,2,.5,.5))
plot(p, xlab = '间距', ylab = '频数', axes = FALSE, 
     col = "lightblue", border = "white", main = "")	 
axis( 1, labels = xlim, at = xlim, las = 1) # x 轴
axis( 2, labels = ylim, at = ylim, las = 0) # y 轴
box(col="gray")
# 添加线性回归线
xx <- seq.int(from = 0, to = 100, by = 1)
xy <- p$counts
options(digits = 2)
fit <- lm(xy~xx)
abline(fit, col = 'red')
b = coef(fit)
# mtext(paste0( "Y = ", paste0(paste0(b[1], b[2]),"x") ), side = 3, cex = 2)
```


## 字体

字体设置包括自定义中文字体、英文字体和数学公式。

### showtext 

下载和安装 showtext 包[@Qiu2015]，下载并加载思源字体

```{r font-setup, eval= (!"showtext" %in% .packages(TRUE))}
install.packages("showtext",dependencies = TRUE)
library(showtext)
# Install Source Han Sans/Serif font (by default Simplified Chinese)
font_install(source_han_serif("CN")) # 思源宋体
font_install(source_han_sans("CN"))  # 思源黑体
```

showtext 包可以调用系统字体，图\@ref(fig:demo-ggplot2)使用5号思源宋体，英文和数字使用 serif 字体。详细的使用文档可以看 [showtext 的开发页面](https://github.com/yixuan/showtext)

```{r demo-ggplot2, fig.showtext = TRUE,fig.cap="showtext包处理图里的中文"}
library(ggplot2)
ggplot(iris, aes(Sepal.Length, Sepal.Width)) +
  geom_point(aes(colour = Species)) +
  scale_colour_brewer(palette = "Set1") +
  labs(
    title = "鸢尾花数据的散点图",
    x = "萼片长度", y = "萼片宽度", colour = "鸢尾花类别"
  ) +
  theme_minimal(base_size = 10.54, base_family = "source-han-serif-cn") +
  theme(
    legend.text = element_text(family = "serif", size = 10.54),
    axis.text = element_text(family = "serif", size = 10.54)
    )
```

用 ggplot2 画个简单地图，地图数据在 mapdata 包 [@R-mapdata]

```{r install-spatial, eval = (!"mapproj" %in% .packages(TRUE))}
install.packages(c("maps", "mapdata", "mapproj"), dependencies = TRUE)
```

如图 \@ref(fig:map-Fiji-earthquake) 所示

```{r map-Fiji-earthquake, fig.showtext=TRUE,fig.cap="斐济地震带"}
library(maps)
library(mapdata)
FijiMap <- map_data("worldHires", region = "Fiji")
ggplot(FijiMap, aes(x = long, y = lat)) +
  geom_map(map = FijiMap, aes(map_id = region), size = .2) +
  geom_point(data = quakes, aes(x = long, y = lat, colour = mag), pch = 16) +
  xlim(160, 195) +
  scale_colour_distiller(palette = "Spectral") +
  scale_y_continuous(breaks = (-18:18) * 5) +
  coord_map("ortho", orientation = c(-10, 180, 0)) +
  labs(colour = "震级", x = "经度", y = "纬度", title = "斐济地震带") +
  theme_minimal() +
  theme(
    title = element_text(family = "source-han-sans-cn"),
    axis.title = element_text(family = "source-han-serif-cn"),
    legend.title = element_text(family = "source-han-sans-cn"),
    legend.position = c(1, 0), legend.justification = c(1, 0)
  )
```

用 base plot 画地图，如图 \@ref(fig:maps-unemp-plot) 所示

```{r maps-unemp-plot, fig.cap="2009年美国各城镇失业率",fig.width=8,fig.height=6}
library(mapproj) 	
data(unemp)
data(county.fips)
colors <- c("#F1EEF6", "#D4B9DA", "#C994C7", "#DF65B0", "#DD1C77", "#980043")
unemp$colorBuckets <- as.numeric(cut(unemp$unemp, c(0, 2, 4, 6, 8, 10, 100)))
leg.txt <- c("<2%", "2-4%", "4-6%", "6-8%", "8-10%", ">10%")
cnty.fips <- county.fips$fips[match(map("county", plot=FALSE)$names,
                                    county.fips$polyname)]
colorsmatched <- unemp$colorBuckets[match(cnty.fips, unemp$fips)]
op <- par(mar=c(0,0,2,0))
# draw map
map("county", col = colors[colorsmatched], fill = TRUE, resolution = 0,
    lty = 0, projection = "polyconic")
map("state", col = "white", fill = FALSE, add = TRUE, lty = 1, lwd = 0.2,
    projection="polyconic")
title("unemployment by county, 2009")
legend("top", leg.txt, horiz = TRUE, fill = colors)
par(op)  
```

### xkcd

这篇文章主要使用 ggplot2 包[@Wickham2016]绘图，为了好玩我们还使用 xkcd 字体，先下载和加载 xkcd 包[@R-xkcd]，它提供一个 gg 风格的图层`theme_xkcd()`

```{r xkcd-setup, eval=(!"xkcd" %in% .packages(TRUE))}
install.packages("xkcd",dependencies = TRUE)
```

下载和注册 xkcd 字体

```{r download-xkcd, eval= (!'xkcd' %in% extrafont::fonts())}
download.file("http://simonsoftware.se/other/xkcd.ttf",
  dest = "xkcd.ttf", mode = "wb"
)
system("mkdir ~/.fonts")
system("cp xkcd.ttf ~/.fonts")
library(extrafont)
font_import(pattern = "[X/x]kcd", prompt = FALSE)
if (.Platform$OS.type != "unix") {
  ## Register fonts for Windows bitmap output
  loadfonts(device = "win")
} else {
  loadfonts() # 加载字体
}
fonts() # 查看可用的字体
```

图 `r ifelse(knitr::is_html_output(),'\\@ref(fig:xkcd-demo)','\\@ref(fig:xkcd-embed)') ` 是一个简单使用 xkcd 字体的例子

```{r xkcd-demo, fig.cap = "xkcd 风的图", eval = knitr::is_html_output()}
# pdf(file = 'figures/xkcd.pdf',width = 6,height = 4)
library(xkcd)
ggplot(aes(mpg, wt), data = mtcars) + geom_point() +
    theme_xkcd()
# dev.off()
# embed_fonts("figures/xkcd.pdf", outfile = "figures/xkcd_embed.pdf")
```

```{r xkcd-embed,fig.cap = "xkcd 风的图", eval= knitr::is_latex_output(), echo=FALSE}
knitr::include_graphics("figures/xkcd_embed.pdf")
```

### fontcm

安装 fontcm 包[@R-fontcm]处理数学公式，下载 fontcm 包^[<https://github.com/wch/fontcm>] 和相关字体

```{r download-fontcm, eval=(!"fontcm" %in% .packages(TRUE))}
library(extrafont)
install.packages("fontcm",dependencies = TRUE)
# 或 font_install('fontcm') 
loadfonts() # 加载字体
```

使用 fontcm 包，一个小 demo 如下

```{r fontcm-demo,fig.cap="默认风格与fontcm",dev='png'}
library(fontcm)
p <- qplot(c(1, 5), c(1, 5)) +
  xlab("Made with CM fonts") + ylab("Made with CM fonts") +
  ggtitle("Made with CM fonts")
# Equation
eq <- "italic(sum(frac(1, n*'!'), n==0, infinity) ==
       lim(bgroup('(', 1 + frac(1, n), ')')^n, n %->% infinity))"
# Without the new fonts
p1 <- p + annotate("text", x = 3, y = 3, parse = TRUE, label = eq) # fig 1
# With the new fonts
p2 <- p + annotate("text",
  x = 3, y = 3, parse = TRUE,
  family = "CM Roman", label = eq
) +
  theme(
    text = element_text(size = 16, family = "CM Roman"),
    axis.title.x = element_text(face = "italic"),
    axis.title.y = element_text(face = "bold")
  ) # fig 2
library(gridExtra)
grid.arrange(p1,p2, nrow = 1, ncol = 2)
```

保存成图片

```r
pdf(file = 'figures/ggplot_cm.pdf',width = 8,height = 4)
grid.arrange(p1,p2, nrow = 1, ncol = 2)
dev.off()
```

使用 ghostscript 嵌入数学字体，最终效果如图\@ref(fig:fontcm-ggplot)所示，

```{r embed,eval=FALSE}
# Embed the fonts
embed_fonts("figures/ggplot_cm.pdf", outfile = "figures/ggplot_cm_embed.pdf")
```
```{r fontcm-ggplot, echo=FALSE,fig.cap="fontcm 处理数学公式"}
knitr::include_graphics("figures/ggplot_cm_embed.png")
```


## 软件信息

系统安装的 R 包有：

```{r}
.packages(TRUE)
```

R 软件运行环境：

```{r}
devtools::session_info()
```


```{r include=FALSE}
# automatically create a bib database for R packages
knitr::write_bib(c(
  .packages(TRUE)
), "packages.bib")
```
