# 安装软件 {#install-softwares}

一些 repos 

```bash
sudo apt-add-repository -y "deb https://mirrors.tuna.tsinghua.edu.cn/CRAN/bin/linux/ubuntu trusty-cran35/"
sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys E084DAB9

sudo add-apt-repository ppa:marutter/c2d4u3.5
sudo add-apt-repository -y "ppa:marutter/rrutter3.5"
sudo add-apt-repository -y "ppa:opencpu/jq"
sudo add-apt-repository -y "ppa:ubuntugis/ppa"
sudo add-apt-repository -y "ppa:kirillshkrogalev/ffmpeg-next"
sudo apt-add-repository -y "ppa:opencpu/imagemagick"
sudo apt-add-repository -y "ppa:ubuntugis/ubuntugis-unstable"
sudo apt-add-repository -y "ppa:octave/stable"
sudo apt-add-repository -y "ppa:ubuntu-toolchain-r/test"
sudo add-apt-repository -y ppa:git-core/ppa

sudo add-apt-repository --remove ppa:ubuntu-toolchain-r/test
```

## R 

在 Ubuntu/Debian 系统上安装最新开发版，请看 <https://cran.r-project.org/bin/linux/debian/index.html>

```bash
sudo apt-add-repository -y "deb http://cran.rstudio.com/bin/linux/ubuntu `lsb_release -cs`/"
sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys E084DAB9
sudo apt-get update
sudo apt-get install r-base-dev
```

R 自3.5以来出现大的不同

```bash
sudo apt-add-repository -y "deb https://cloud.r-project.org/bin/linux/ubuntu bionic-cran35/"
# 或者就近的镜像站点
sudo apt-add-repository -y "deb https://mirrors.tuna.tsinghua.edu.cn/CRAN/bin/linux/ubuntu bionic-cran35/"
# 必须导入 key 
sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys E084DAB9
sudo apt-get update
sudo apt-get install r-base r-base-dev
# 添加二进制编译好的R包仓库，有些R包依赖复杂，编译时间长
# R 3.5.0 系列 二进制 R 包
sudo add-apt-repository ppa:marutter/c2d4u3.5
sudo apt-get update
```

查询 PATH 环境变量包含的软件路径

```{r}
strsplit(Sys.getenv("PATH"),split = .Platform$path.sep) %>% unlist
```

Windows 下安装指导见《R语言忍者秘笈》的第二章^[<https://bookdown.org/yihui/r-ninja/setup.html>]

推荐没事多翻翻官网 [FAQ 文档](https://mirrors.tuna.tsinghua.edu.cn/CRAN/doc/FAQ/R-FAQ.html) 以及6本自带的手册

* **An Introduction to R** (R-intro) includes information on data types, programming elements, statistical modeling and graphics. This document is based on the **Notes on S-PLUS** by Bill Venables and David Smith.
    + 介绍数据类型，编程基础，统计模型和图形
* **Writing R Extensions** (R-exts) currently describes the process of creating R add-on packages, writing R documentation, R’s system and foreign language interfaces, and the R API.
    + 描述创建扩展包、写R包文档的过程，介绍 R 系统，外部语言接口以及 R 的API
* **R Data Import/Export** (R-data) is a guide to importing and exporting data to and from R.
    + 从 R 导入和导出数据
* **The R Language Definition** (R-lang), a first version of the *Kernighan & Ritchie of R*, explains evaluation, parsing, object oriented programming, computing on the language, and so forth.
    + 介绍 R 语言程序设计，解释计算、解析、面向对象编程以及计算
* **R Installation and Administration** (R-admin).
    + R 安装和管理
* **R Internals** (R-ints) is a guide to R’s internal structures. (Added in R 2.4.0.)
    + R 内部结构指南

Hadley Wickham 正在写文档介绍 [Documentation for R's internal C API](https://github.com/hadley/r-internals)

- 从源码编译 R 的需求在哪呢？

1. 爱折腾的极客：玩配置，学习 make 相关工具和 Linux 世界的依赖
2. 追求性能：如 [LFS 支持](http://users.suse.com/~aj/linux_lfs.html) 和 [Intel MKL 加速](http://dirk.eddelbuettel.com/blog/2018/04/15/#018_mkl_for_debian_ubuntu)
3. 环境限制：CentOS 6/7 或者红帽系统，自带的 R 版本比较落后
4. 微软提供的一套 MSR （这里不需要编译）

现在很多东西都讲究 docker 化，直接往 CentOS 系统上编译安装最新版 R 会越来越少，这里给个例子，在 docker 内安装 R 和扩展包，Dockerfile 的内容如下

```{r docker-file}
cat(readLines("Dockerfile", encoding = "UTF-8") ,sep = "\n")
```

这种方式可以安装到最新版的 R，同时省去了自己配置安装过程中的麻烦，只是系统自带的 texlive 还是比较旧，如何安装 tlmgr 管理器，安装新的 TeX 包到之前的位置值得考虑，主要目的是为中文的 R Markdown 文档服务。

Pandoc 提供的 LaTeX 文类，是希望用户在 YAML 指定 CJKmainfont 等，显式地安装系统中文字体供使用，楷体和宋体，文泉驿黑体都是系统自带的。要我说可以用思源黑体和宋体，或者自己拷贝一份中文字体到 `~/.fonts` 然后刷新，就是添加这样一段代码，这种做法使用最广

```
RUN mkdir ~/.fonts \
  && curl -o ~/.fonts/Inconsolata-Bold.ttf https://raw.githubusercontent.com/google/fonts/master/ofl/inconsolata/Inconsolata-Bold.ttf \
  && curl -o ~/.fonts/Inconsolata-Regular.ttf https://raw.githubusercontent.com/google/fonts/master/ofl/inconsolata/Inconsolata-Regular.ttf \
  && fc-cache -fv ~/.fonts \
```

文泉驿字体

```
wqy-unibit-fonts wqy-microhei-fonts wqy-zenhei-fonts
```

* 安装 Microsoft R Open <https://mran.microsoft.com/documents/rro/installation#revorinst-lin>
* 安装 Machine Learning Server
    + [在线安装](https://docs.microsoft.com/en-us/machine-learning-server/install/machine-learning-server-linux-install)
    + [离线安装](https://docs.microsoft.com/en-us/machine-learning-server/install/machine-learning-server-linux-offline)

	
 https://cran.r-project.org/bin/linux/debian/index.html

1. 设置路径

```bash
mkdir -p ~/svn/R
export RTOP=~/svn/R
export REPOS=https://svn.r-project.org/R
```

2. 同步远程开发版代码

```bash
cd $RTOP
svn co $REPOS/trunk r-devel/source
mkdir $RTOP/r-devel/build
```

3. 下一次只需同步源码仓

```bash
cd $RTOP/r-devel/source
svn up
```

4. 推荐级别的 R 包源码

```bash
cd $RTOP/r-devel/source/tools
./rsync-recommended
```

5. configure 准备编译

```bash
cd $RTOP/r-devel/build
../source/configure
```

6. 编译检查

```bash
make
make check
make pdf
make info
```

7. 建立快捷方式

```bash
cd /usr/local/bin
ln -s /$RTOP/r-devel/build/bin/R R-devel
ln -s /$RTOP/r-devel/build/bin/Rscript Rscript-devel
```


	
## GCC 

CentOS 7 默认版本是 gcc-4.8.5

```bash
sudo yum install centos-release-scl-rh
sudo yum install devtoolset-4-gcc devtoolset-4-gcc-c++
source /opt/rh/devtoolset-4/enable

options(BioC_mirror="https://mirrors.tuna.tsinghua.edu.cn/bioconductor")
options("repos" = c(CRAN="https://mirrors.tuna.tsinghua.edu.cn/CRAN/"))

# gcc 4.8.2
rpm --import http://linuxsoft.cern.ch/cern/slc6X/x86_64/RPM-GPG-KEY-cern
wget -O /etc/yum.repos.d/slc6-devtoolset.repo http://linuxsoft.cern.ch/cern/devtoolset/slc6-devtoolset.repo
sudo yum install devtoolset-2-toolchain
sudo yum install devtoolset-2-gcc  devtoolset-2-gcc-c++
source /opt/rh/devtoolset-2/enable
```

## Python

Python 版本和位置

```r
Sys.which("python")
system2("python", args = "--version", stderr = TRUE)
```

升级 Python

```bash
sudo add-apt-repository ppa:fkrull/deadsnakes-python2.7  
sudo apt-get update  
```

可用的 python 模块

```python
help('modules')
```

## Lapack

编译 lapack 以及 lapacke，这一步比较麻烦，首先当然是进入 lapack-3.7.1 文件夹，然后根据平台的特点，将 INSTALL 目录下对应的 make.inc.XXX 复制一份到 lapack-3.7.1目录下，并命名为 make.inc, 这里我复制的是 INSTALL/make.inc.gfortran，因为我这里用的是 gfortran 编译器。 
因为 lapack 以来于 blas 库，所以需要对 lapack-3.7.1/Makefile 做如下修改

```bash
#lib: lapacklib tmglib
lib: blaslib variants lapacklig tmglib
```

再执行

```bash
make       # 编译所有的 lapack 文件    
cd lapacke # 进入 lapacke 文件夹，这个文件夹包含 lapack 的 C 语言接口文件    
make       # 编译 lapacke    
cp include/*.h /usr/local/include # 将 lapacke 的头文件复制到系统头文件目录    
cd ..                 # 返回到 lapack-3.7.1 目录    
cp *.a /usr/local/lib # 将生成的所有库文件复制到系统库目录 
```


## Octave {#octave}

Octave 官网 <http://www.gnu.org/software/octave/>

```bash
sudo apt-add-repository -y ppa:octave/stable
sudo apt-get update
sudo apt-get install -y octave
```

安装指南分别有

- MacOS <https://wiki.octave.org/Octave_for_macOS>
- Windows <http://wiki.octave.org/Octave_for_Microsoft_Windows>
- Debian <https://wiki.octave.org/Octave_for_Debian_systems>

查看安装的版本

```r
Sys.which("octave")
system("octave --version")
```


## Pandoc {#pandoc}

在 Pandoc 的开发仓库 GitHub 上下载 deb 包^[<https://github.com/jgm/pandoc/releases>] 

```bash
sudo apt-get install gdebi-core
sudo gdebi pandoc-2.2.2.1-1-amd64.deb
```

## RStudio {#rstudio}

安装 RStudio 或者 RStudio Server 请看官网介绍

-  <https://www.rstudio.com/products/rstudio/download/>
-  <http://docs.rstudio.com/ide/server-pro/>

在 RStudio 官网^[<https://www.rstudio.com/products/rstudio/download/>] 下载最新的 RStudio 桌面版/服务器版 

```bash
wget https://download2.rstudio.org/rstudio-server-1.1.456-amd64.deb
sudo gdebi rstudio-server-1.1.456-amd64.deb
```

设置 rstudio server 端口，在文件 `/etc/rstudio/rserver.conf` 下，设置

```
www-port=8080
```

获取机器的 IP 地址，如 192.168.106.3

```bash
ip addr
```

修改 rserver.conf 文件后需要重启才会生效，重启 rstudio server

```bash
sudo rstudio-server stop
sudo rstudio-server start
```

从本地浏览器登陆 RStudio Server 网址 <http://192.168.106.3:8080/>

http://docs.rstudio.com/ide/server-pro/

## Calibre {#calibre}

将 epub 转化为 mobi 格式

```bash
sudo -v && wget -nv -O- https://download.calibre-ebook.com/linux-installer.sh | sudo sh /dev/stdin
```

## HUGO {#hugo}

在开发仓库下载最新发布的 deb 文件

<https://github.com/gohugoio/hugo/releases>

```bash
wget https://github.com/gohugoio/hugo/releases/download/v0.45/hugo_0.45_Linux-64bit.deb
sudo gdebi hugo_0.45_Linux-64bit.deb
```

## zsh {#zsh}


Zshell 是一个比 bash 更好用的终端

在 CentOS/Fedora 下

```bash
sudo yum update && sudo yum -y install zsh git
sh -c "$(curl -fsSL https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh)"
```

## TinyTeX {#tinytex}

- Travis 安装

益辉通过 Travis 每天更新 TinyTeX，我们下载这个版本

```bash
curl -fLo /tmp/texlive.tar.gz https://travis-bin.yihui.name/tinytex.tar.gz
```

下载文件到指定位置

```bash
curl https://xran.yihui.name/.gitconfig -o ~/.gitconfig
```

解压到当前用户的根目录

```bash
tar xzf /tmp/tinytex.tar.gz -C ~ .TinyTeX
```

修改 .bashrc 文件将 TinyTeX 的位置添加到系统路径里

```bash
export PATH=/$HOME/.TinyTeX/bin/x86_64-linux:$PATH
```

更新 .bashrc 使得修改生效

```bash
source .bashrc
```

更新 TeX 包和 tlmgr 管理器

```bash
tlmgr update --all --self
```

安装一些 TeX 包支持中文文档编译

```bash
tlmgr install ctex fandol
```

已安装的字体

```{r,eval=is_on_travis}
font_db <- base::system("fc-list :lang=en-us | sort", intern = TRUE)
font_name <- unique(do.call(rbind,strsplit(font_db,split = ":"))[,2])
substr(font_name, 2, nchar(font_name))
```

```{r}
tinytex::tl_pkgs()
capabilities()
extSoftVersion()
names(pdfFonts())
rmarkdown::pandoc_version()
```

- Windows 下安装

```r
tinytex::install_tinytex(dir = "D:/TinyTeX", force = T,
repository = "https://mirrors.tuna.tsinghua.edu.cn/CTAN/systems/texlive/tlnet")
```

[TinyTeX 安装日志](https://github.com/XiangyunHuang/ISCGwR/files/2226468/TinyTeX.log)

- Ubuntu 下安装

安装指导来自 docker 镜像 rocker/verse 的 [dockerfile](https://hub.docker.com/r/rocker/verse/~/dockerfile/)

```bash
wget "https://travis-bin.yihui.name/texlive-local.deb"
dpkg -i texlive-local.deb
rm texlive-local.deb
apt-get update
apt-get install -y default-jdk ghostscript \
        libbz2-dev libicu-dev liblzma-dev \
        libhunspell-dev libmagick++-dev librdf0-dev \
        libv8-dev libjq-dev qpdf texinfo \
        ssh xz-utils libssh2-dev

wget -qO- \
    "https://github.com/yihui/tinytex/raw/master/tools/install-unx.sh" | sh -s - --admin --no-path
```

## Ubuntu 14.04.5

```bash
# 启用网络
sudo vi /etc/network/interfaces
# 添加
auto eth1
iface eth1 inet dhcp

# 重启 网络
# sudo service network-manager restart
sudo /etc/init.d/networking restart

# 重启虚拟机

# 设置源仓
wget https://tuna.moe/oh-my-tuna/oh-my-tuna.py
sudo python oh-my-tuna.py --global

# 安装确认 openssh-server 服务
sudo apt install openssh-server
sudo /etc/init.d/ssh start
ps -aux | grep ssh
```

## CentOS 7


- 配置网络

```bash
sudo vi /etc/sysconfig/network-scripts/ifcfg-enp0s3
sudo vi /etc/sysconfig/network-scripts/ifcfg-enp0s8
```

自动获取IP，只需将 ONBOOT=no 改为 ONBOOT=yes，然后重启网络

```bash
sudo service network restart
```

然后更新 yum  

```bash
sudo yum update 
sudo yum groupinstall "Development Tools" 
```

删除之前的内核

```bash
rpm -qa | grep kernel
sudo yum remove kernel-3.10.0-693.el7.x86_64
```

配置 VBox 的网卡2的网络为 仅主机(Host-Only)网络,网卡1的配置不变 

```bash
sudo systemctl stop firewalld # 关闭防火墙 
sudo systemctl disable firewalld.service # 禁止启动
```

查看防火墙和 sshd 状态

```bash
sudo firewall-cmd --state #查看默认防火墙状态
sudo systemctl status sshd 
```

虚拟机能 ping 通主机，主机不能 ping 通虚拟机，原因是 VirtualBox Host-Only Network #3 与虚拟机 ip 不在同一网段，修改 VirtualBox Host-Only Network #3 的配置为自动获取

### R

```bash
sudo yum install epel-release
sudo yum install -y R
```

R 包默认存放目录添加写权限，其他 R 包 放 site-library

```bash
sudo chmod -R +777 /usr/lib64/R/library
```

安装一些依赖

```bash
sudo yum install -y libcurl-devel openssl-devel libssh2-devel \
   libgit2-devel libxml2-devel \
   ImageMagick-c++-devel librsvg2-devel tcl-devel tk-devel \
   readline-devel v8-314-devel libXmu libXmu-devel \
   mesa-libGLU mesa-libGLU-devel libicu-devel
```  

- 安装 R 包

```r
install.packages(c(
   'curl', 'openssl', 'git2r', 'xml2', 
   'devtools', 'ggplot2', 'magick', 'rsvg', 'bookdown'
))
```

### zsh

```bash
sudo yum update && sudo yum -y install zsh curl wget deltarpm
sh -c "$(curl -fsSL https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh)"
```


查看文件夹大小

```bash
du -h -d 1
```

### RStudio Server

```bash
wget https://download2.rstudio.org/rstudio-server-rhel-1.1.456-x86_64.rpm
sudo yum install rstudio-server-rhel-1.1.456-x86_64.rpm
```

- 配置 rstudio

如果是自己编译安装 R，就需要手动这一步

```bash
sudo vi /etc/rstudio/rserver.conf 
# 添加一行 
rsession-which-r=/usr/local/bin/R
```

- rstudio 手册
http://docs.rstudio.com/ide/server-pro/

- 可用的字体

CentOS 下 repo 中常见字体名字

将 Windows 下的字体拷贝到 CentOS 系统上

- 下载 R 源码包

```bash
wget https://mirrors.tuna.tsinghua.edu.cn/CRAN/src/base/R-3/R-3.5.1.tar.gz
tar -xzvf R-3.5.1.tar.gz
```

```bash
tlmgr install inconsolata ctex l3kernel l3packages \
   ms zapfding fancyvrb booktabs
```

### compile 

配置 R 的命令

```bash
./configure --enable-R-shlib --enable-byte-compiled-packages \
  --enable-BLAS-shlib --enable-memory-profiling 

make 
sudo make install
```

使用 OpenBLAS  `--with-blas="-lgoto2"`

```bash
./configure --enable-R-shlib --enable-byte-compiled-packages \
  --enable-BLAS-shlib --enable-memory-profiling \
  --with-blas="-lopenblas" 
```

```bash  
sudo yum install pango pango-devel pcre pcre-devel pcre2 pcre2-devel
```

安装 texinfo 编译手册

```bash
wget https://ftp.gnu.org/gnu/texinfo/texinfo-6.5.tar.gz

tar -xzf texinfo-6.5.tar.gz
cd texinfo-6.5
./configure
make 
sudo make install

wget https://ftp.gnu.org/gnu/texinfo/texinfo.tex

cp texinfo.tex ~/R-devel/doc/manual

cp ~/texinfo-6.5/doc/txi-en.tex   ~/R-devel/doc/manual
```

- 安装 sf

```bash
sudo yum install netcdf-devel hdf5-devel armadillo-devel \
    freexl-devel unixODBC-devel geos-devel \
    gdal-devel proj-devel proj-epsg proj-nad \
    geos-devel udunits2-devel fftw fftw-devel gcc-objc gcc-objc++
```

- 配置 rgdal

```bash
./configure --with-armadillo=yes
make 
sudo make install
```

安装 Git

```bash
wget https://centos7.iuscommunity.org/ius-release.rpm
sudo yum localinstall ius-release
sudo yum update && sudo yum install git2u
```

安装 JAGS

```bash
wget http://download.opensuse.org/repositories/home:/cornell_vrdc/CentOS_7/home:cornell_vrdc.repo
sudo yum install jags4 jags4-devel
```

```r
install.packages('rjags')
```

安装 texlive/tinytex

从这里安装 https://github.com/FluidityProject/yum-centos7-texlive


```bash
sudo yum install perl-Digest-MD5
```

卸载 texlive

```bash
sudo yum remove texlive-\*
```

安装字体

```bash
sudo yum install levien-inconsolata-fonts texlive-inconsolata texlive-fandol texlive-ctex
```
```bash
tlmgr install ctex ms ulem xecjk environ trimspaces \
  zhnumber fandol xltxtra realscripts
```

```bash
## Use tinytex for LaTeX installation
wget -qO- "https://yihui.name/gh/tinytex/tools/install-unx.sh" | sh -s - --admin --no-path 
sudo mv ~/.TinyTeX /opt/TinyTeX 
sudo /opt/TinyTeX/bin/*/tlmgr path add 
tlmgr install inconsolata tex ae parskip listings 
sudo /opt/TinyTeX/bin/*/tlmgr path add 
```

```r
Rscript -e "tinytex::r_texmf()" 
options(bitmapType = 'cairo')
```

```bash
tlmgr install ctex ms ulem xecjk environ trimspaces \
  zhnumber fandol xltxtra realscripts \
  times helvetic courier
```  

## 安装 Fedora 27 {#fedora}

先从 [清华开源镜像站](https://mirrors.tuna.tsinghua.edu.cn/) 下载 Fedora 镜像 `Fedora-Server-netinst-x86_64-27-1.6.iso` 启动 VBox 分配硬件资源后

```{r,fig.cap='安装 Fedora 迷你版',echo=FALSE}
knitr::include_graphics(path = 'figures/04n-Fedora-Mini.png')
```

设置 `root` 账户密码，创建新账户 `cloud2016`

```{r,fig.cap='配置账户',echo=FALSE}
knitr::include_graphics(path = 'figures/04n-Fedora-Install.png')
```

等待直到内核安装配置完成

```{r,fig.cap='安装完成',echo=FALSE}
knitr::include_graphics(path = 'figures/04n-Fedora-Kernel.png')
```

默认在线安装的 Fedora 迷你版， 网络已经配置好， 系统各组件也是最新的， 此时包含的软件列表如下：

```bash
yum list installed
```

[迷你 Fedora 默认安装软件列表](https://github.com/XiangyunHuang/ISCGwR/files/2228186/miniFedoraPackagesList.log)

> 安装了最新版 Fedora 后，系统仓库自带的软件都是比较新的版本，可以直接安装

```bash
sudo yum install openssh-server epel-release
sudo yum install -y ImageMagick-c++-devel librsvg2-devel \
 gdal-devel proj-devel proj-epsg proj-nad geos-devel udunits2-devel \
 glibc-headers libreadline6-devel readline-devel libXt-devel \
 tcl tcl-devel tclx tk tk-devel mesa-libGLU mesa-libGLU-devel bzip2-devel \ 
 libcurl-devel openssl-devel libssh2-devel libxml2-devel v8-314-devel \
 pkg-config wget perl-Digest-MD5 fontconfig  
```

```bash
sudo yum install gdal-devel proj-devel \
  proj-epsg proj-nad geos-devel udunits2-devel
```

```r
install.packages("udunits2",configure.args='--with-udunits2-include=/usr/include/udunits2')   
install.packages("sf") 
```

使用 Fedora 最新版系统或者 Rocker 提供的 Docker 镜像，不然需要手动编译安装 GEOS^[<http://trac.osgeo.org/geos>] 和 gdal^[<http://trac.osgeo.org/gdal>]，CentOS 自带的包版本太低，不够 **sf** 包使用，这就是新手面临的痛点。CentOS 仓库自带的依赖库版本有点低，需要手动安装高版本，安装 rgdal 包没有问题，而 sf 包目前处于一种活跃开发状态，且是空间数据分析的新标准，使用的都是新版本的依赖库。


### 安装 TinyTeX {#fedora-tinytex}

从最初的命令行开始

```bash
wget -qO- "https://github.com/yihui/tinytex/raw/master/tools/install-unx.sh" | sh
```

由于 Fedora 27 自带的 texlive 功能比较全，TinyTeX 变成可选项，默认安装目录为 `~/.TinyTeX`

```bash
yum install perl-Digest-MD5
```

```r
devtools::install_github('yihui/tinytex')
tinytex::install_tinytex(TRUE, repository = 'http://mirrors.tuna.tsinghua.edu.cn/CTAN/systems/texlive/tlnet')
# tinytex::install_tinytex(force = TRUE) # 若之前安装过 TinyTeX
```

修改 .bashrc

```bash
PATH=/home/cloud2016/.TinyTeX/bin/x86_64-linux:$PATH; export PATH
MANPATH=/home/cloud2016/.TinyTeX/texmf-dist/doc/man:$MANPATH; export MANPATH
INFOPATH=/home/cloud2016/.TinyTeX/texmf-dist/doc/man:$INFOPATH; export INFOPATH
```

使环境变量设置生效

```bash
source ~/.bashrc
```

安装常用 tex 包，主要处理中文和代码字体

```bash
tlmgr install fontspec ctex tex inconsolata \
      cjk zhnumber fandol xecjk environ ulem trimspaces \
      sourcesanspro sourcecodepro appendix \
      zhspacing metalogo realscripts xltxtra \
      times helvetic courier inconsolata
```

还需要安装一些 TeX 包，才能编译出中文 PDF 文档

```bash
tlmgr install ctex ms ulem xecjk environ trimspaces \
  zhnumber fandol xltxtra realscripts
```

`.Rprofile` 设置如下

```r
Sys.setenv(PATH = "/home/cloud2016/.TinyTeX/bin/x86_64-linux:
/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin" )
options( bitmapType = 'cairo' )
```

查看 R 进程信息

```r
sessionInfo()
```

```
R version 3.4.3 (2017-11-30)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Fedora 27 (Twenty Seven)

Matrix products: default
BLAS: /usr/local/lib64/R/lib/libRblas.so
LAPACK: /usr/local/lib64/R/lib/libRlapack.so

locale:
 [1] LC_CTYPE=zh_CN.UTF-8       LC_NUMERIC=C
 [3] LC_TIME=zh_CN.UTF-8        LC_COLLATE=zh_CN.UTF-8
 [5] LC_MONETARY=zh_CN.UTF-8    LC_MESSAGES=zh_CN.UTF-8
 [7] LC_PAPER=zh_CN.UTF-8       LC_NAME=C
 [9] LC_ADDRESS=C               LC_TELEPHONE=C
[11] LC_MEASUREMENT=zh_CN.UTF-8 LC_IDENTIFICATION=C

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base

loaded via a namespace (and not attached):
[1] compiler_3.4.3 tools_3.4.3    tinytex_0.2.3
```

### 安装 RStudio {#fedora-rstudio}

以管理员账户登录系统，下载安装 RStudio Server 开源版本

```bash
wget https://download2.rstudio.org/rstudio-server-rhel-1.1.383-x86_64.rpm
sudo yum install --nogpgcheck rstudio-server-rhel-1.1.383-x86_64.rpm
```

RStudio Server 不能以 root 账户登录，下面新建账户

```bash
adduser cloud2016 # 添加用户
passwd cloud2016  # 用户密码设为 cloud
whereis sudoers   # 查找文件位置
chmod -v u+w /etc/sudoers # 给文件 sudoers 添加写权限
vim /etc/sudoers # 添加 cloud2016 管理员权限
chmod -v u-w /etc/sudoers # 收回权限
```


## Docker {#docker}

Docker 相比虚拟机占用资源少，拉起来就可以用，虚拟机还需要各种环境配置，很多与R有关的项目现在都提供Docker镜像，大大方便了开发人员和数据分析师。当然 docker 的环境隔离性，对主机系统侵入小，即使挂了，再拉起来也就是了，安全性和可靠性高。

基于 The Rocker Project^[<https://www.rocker-project.org/>] 快速构建数据分析环境，[Rocker项目](https://github.com/rocker-org/rocker) 站在 [Debian](https://www.debian.org/) 和 [R](https://www.r-project.org/) 的肩膀上，在 [Docker](https://www.docker.com/)内配置众多数据分析和开发的工具，免去用户手动配置的复杂性。此事非有心者不能为之 ，因为需费时费力找寻依赖库，编译 R 包，还要尽可能地给 Docker 镜像减负，以便部署。如果想抢先试水的赶快去 Rocker 项目主页。

- 由 Dirk Eddelbuettel 等人担纲的 Rocker 项目， [项目主页](https://github.com/rocker-org/rocker) 和 [Docker镜像](https://hub.docker.com/u/rocker/) 
- Wei-Chen Chen 等人的大数据编程项目 Programming with Big Data in R， [项目主页](https://rbigdata.github.io/) 和 [Docker 镜像](https://hub.docker.com/u/rbigdata/) 
- [非常详细的docker笔记](http://m.blog.csdn.net/sdgihshdv/article/details/75142367) 
- Dockerfile <https://docs.docker.com/develop/develop-images/dockerfile_best-practices/>
- build <https://docs.docker.com/engine/reference/builder/#usage>

其它容器相关项目有

* Singularity
    + <https://github.com/bwlewis/r-and-singularity>
    + <http://singularity.lbl.gov/>
* Kubernetes
    + Kubernetes 容器集群管理 <https://www.kubernetes.org.cn>
    + 参见高策的博客 <http://gaocegege.com>

### Pull Images

重复实现的关键是拉取一个现有的 Docker 镜像，可以免去安装和环境配置的诸多麻烦。

```bash
docker run --rm -it --name book -e \
 DISPLAY=192.168.99.100:0 -d -p 8282:8787 -e ROOT=TRUE \
 -e USER=rstudio -e PASSWORD=cloud rocker/geospatial
```

`DISPLAY=192.168.99.100:0` 用于启用 X11 设备，否则 rgl 等软件包会报显示警告，`--rm -it` 使得 主机和虚拟机时间一致，否则会有警告^[<https://github.com/rocker-org/rocker/wiki/Allowing-GUI-windows>]

```
# 两个与时间有关的警告
Warning message:
running command 'timedatectl' had status 1 
Failed to create bus connection: No such file or directory
```

<https://stackoverflow.com/questions/43907925/ubuntu-timedatectl-fails-in-docker-container>

```r
capabilities()
 jpeg         png        tiff       tcltk         X11        aqua    http/ftp     sockets      libxml 
 TRUE        TRUE        TRUE        TRUE       FALSE       FALSE        TRUE        TRUE        TRUE 
 fifo      cledit       iconv         NLS     profmem       cairo         ICU long.double     libcurl 
 TRUE        TRUE        TRUE       FALSE        TRUE        TRUE        TRUE        TRUE        TRUE 
```
主机端口号 8282，这里可以改成你自己喜欢的，虚拟机端口号 8787 对应 RStudio Server 默认端口，如果你想自己指定，就去修改 RStudio Server的配置文件。拉取的 Docker 镜像取名 book，这是方便以后启动 docker 时方便，只需

```bash
# 启动
docker start book
# 进入
docker exec -it book bash

docker start rocker
docker ps # 获取容器 ID CONTAINER ID
docker exec -it 6f932357e6ce /bin/bash
```

由于要安装 rstan 和 rstanarm 包，编译的过程中需要比较大的内存空间，默认分配给 docker 的内存要增加到 4 Gb，也就装个软件，大一点的基于 stan 实现的模型，还是适合放在大机器上跑，笔电可以跑跑简单的模型，学习一下就可以了。


### Docker (Windows 8.1) {#windows8}

对于 Windows 8.1 来说，需要下载 [Docker ToolBox for Windows](https://docs.docker.com/toolbox/toolbox_install_windows/) 和 [Boot2Docker](https://github.com/boot2docker/boot2docker)^[目前官方已进入维护模式]，由于 Docker for Windows 需要 Windows 10 Pro，如图 \@ref(fig:docker-installation-error)所示

```{r docker-installation-error,echo=FALSE,fig.cap="Docker for Windows 需要高版本的 Windows 系统"}
knitr::include_graphics(path = "figures/04a-docker-install-error.png")
```

下载完成后，双击 exe 可执行文件，启动安装过程，如图 \@ref(fig:docker-install) 所示，VirtualBox 和 Git 是否勾选取决于在此之前系统是否已经安装了这两个组件， Kitematic (Docker GUI) 在 Windows 8.1 下没什么用，取消勾选。创建快捷方式和添加路径到系统 PATH 环境变量，取消勾选升级 Boot2Docker VM，因为我们在 GitHub 上下载了最新版 Boot2Docker， 安装完成后替换即可。

```{r docker-install, fig.cap="自定义 Docker 安装过程", fig.subcap=c("自定义安装选项", "不要安装过程中升级 Boot2Docker"), echo=FALSE, out.width="45%"}
knitr::include_graphics(path = c("figures/04a-docker-custom-installation.png",
                                 "figures/04b-docker-shortcut.png"))
```

此外，安装过程中可能弹出，如图\@ref(fig:docker-driver) 所示的对话框，选择安装即可

```{r docker-driver, fig.cap="安装驱动", echo=FALSE}
knitr::include_graphics(path = "figures/04c-docker-drivers.png")
```

安装完成后，就可以将 Docker ToolBox 目录下的 Boot2Docker 替换，如图 \@ref(fig:docker-dir) 所示

```{r docker-dir,fig.cap="Docker ToolBox 的安装目录",echo=FALSE}
knitr::include_graphics(path = "figures/04d-docker-dir.png")
```

 **拉取镜像**

在启动桌面快捷方式（如图\@ref(fig:docker-shortcut)所示）之前，非常重要的一步是设置镜像在磁盘上的存放位置（因为默认位置是C盘），在用户主目录下新建 `.bash_profile` 文件，并且添加如下一行

```bash
export MACHINE_STORAGE_PATH='D:\Docker'
```

```{r docker-shortcut,fig.cap="双击桌面快捷方式启动Docker",echo=FALSE,out.width="35%"}
knitr::include_graphics(path = "figures/04j-docker-shortcut.png")
```

启动后，如图\@ref(fig:start-docker) 所示， [Docker 初始化完整日志](https://github.com/XiangyunHuang/ISCGwR/files/2226477/docker.log)

```{r start-docker,fig.cap="Docker 启动完成",echo=FALSE}
knitr::include_graphics(path = "figures/04k-start-docker.png")
```

在 Windows 系统上，查看 IP

```bash
docker-machine ip default
```

Docker-based Geospatial toolkit for R, built on versioned Rocker images. 开发仓库 <https://github.com/rocker-org/geospatial>

```bash
docker run --name book -d -p 8282:8787 -e ROOT=TRUE \
 -e USER=rstudio -e PASSWORD=cloud rocker/geospatial
```

`8787` 端口给 RStudio Server 使用，`8282` 端口用于浏览器登录 RStudio 使用。`8787` 端口也是可以自定义的，方法是修改 `/etc/rstudio/rserver.conf` 文件^[<http://docs.rstudio.com/ide/server-pro/access-and-security.html>]，如设置

```
www-port=8080
```

那么，拉取镜像的命令相应地改为

```bash
docker run --name book -d -p 8282:8080 -e ROOT=TRUE \
 -e USER=rstudio -e PASSWORD=cloud rocker/geospatial
```

如图 \@ref(fig:docker-pull) 所示，就是将主机端口号 `8787` 映射给容器内的 `8282` 端口

```{r docker-pull,fig.cap="拉取 Docker 镜像",echo=FALSE}
knitr::include_graphics(path = "figures/04e-docker-pull-image.png")
```

其实，也可以在 Git Bash 中拉取镜像，

```bash
# 启动 Docker
docker-machine start
# 进入 Bash 
docker-machine ssh default
```

```{r docker-pull-git,fig.cap="在 Git Bash 中拉取 Docker 镜像",echo=FALSE}
knitr::include_graphics(path = "figures/04g-docker-pull-image-git-bash.png")
```

### PuTTY {#putty-login-docker}

首先在 PuTTY 中设置分配给 Docker 的 IP

```{r set-ip,fig.cap="设置 IP 地址",echo=FALSE}
knitr::include_graphics(path = "figures/04l-PuTTY-login.png")
```

PuTTY 登陆虚拟机或者 Docker，初次登陆会要求授权

```{r security,echo=FALSE,fig.cap="安全连接认证"}
knitr::include_graphics(path = "figures/04h-PuTTY-Security.png")
```

我们可以看到，PuTTY 显示的 IP 和虚拟机保持一致

```{r login,echo=FALSE,fig.cap="登陆"}
knitr::include_graphics(path = "figures/04i-PuTTY-login.png")
```

我们也可以在 PuTTY 中拉取 Docker 镜像了，如图 \@ref(fig:docker-pull-via-putty) 所示

```{r docker-pull-via-putty,echo=FALSE,fig.cap="PuTTY 里拉取Docker镜像",fig.subcap=c("正在拉取","拉取完成"),out.width="33%"}
knitr::include_graphics(path = c("figures/04m-docker-pull-image-via-putty.png",
                                 "figures/04m-docker-pull-finish.png"))
```


### Docker (CentOS)

安装必要的依赖

```bash
sudo yum install -y yum-utils \
  device-mapper-persistent-data lvm2
```

添加 repo源

```bash
sudo yum-config-manager --add-repo \
    https://download.docker.com/linux/centos/docker-ce.repo
```

软件仓库替换为TUNA以加快下载速度

```bash
sudo sed -i 's+download.docker.com+mirrors.tuna.tsinghua.edu.cn/docker-ce+' /etc/yum.repos.d/docker-ce.repo
```

可选项 `sudo yum-config-manager --disable docker-ce-edge` 或
`sudo yum-config-manager --enable docker-ce-edge`

安装 docker-ce

```bash
sudo yum install docker-ce
```

查看可用的docker-ce版本

```bash
yum list docker-ce --showduplicates | sort -r
```

安装的是目前最新版本 `docker-ce.x86_64 0:17.09.0.ce-1.el7.centos`         

拉取 Docker 镜像 `rocker/geospatial`，创建指定用户及密码，授予用户 root 权限，设置共享目录，每次启动都检查更新、配置IP等造成启动时间长，再配置自己的环境

- 启动 Docker

```bash
sudo service docker start
sudo docker info  
```

- 拉取 `rocker/geospatial` 镜像，如图 \@ref(fig:docker-centos)

```bash
sudo docker run -d -p 8787:8787 -e ROOT=TRUE \
-e USER=xiangyun -e PASSWORD=cloud \
rocker/geospatial
```

```{r docker-centos, fig.cap="CentOS 上 Docker 安装", echo=FALSE}
knitr::include_graphics(path = "figures/04f-docker-centos.png")
```

### 常用命令 {#common-commands}

- 拉取 docker pull
- 启动 docker start
- 运行 docker run
- 移除 docker rm(i)
