---
title: "notes"
author: ["Xiangyun Huang", "The Others"]
date: "`r format(Sys.time(), tz = 'Asia/Taipei', usetz = TRUE)`"
site: bookdown::bookdown_site
geometry: margin=1.18in
documentclass: book
bibliography: [book.bib, packages.bib]
biblio-style: apalike
lof: yes
lot: yes
graphics: yes
tables: yes
link-citations: yes
links-as-notes: no
colorlinks: yes
toccolor: magenta
mathspec: yes
classoption: "hyperref, a4paper, UTF8, zihao = -4, linespread = 1.3, table"
description: "Some notes about R and other open souce softwares, such as Pandoc, LaTeX, Inkscape, Ghostscript, Git, Stan, Octave and Python."
url: 'https\://notesdown.netlify.com/'
github-repo: "xiangyunhuang/notesdown"
cover-image: "images/dragon.png"
apple-touch-icon: "images/dragon.png"
apple-touch-icon-size: 120
favicon: "favicon.ico"
---
```{r include=FALSE, cache=FALSE}
library(methods)
set.seed(2018)
options(digits = 3)

Pkgs <- c(
  "reticulate",
  "showtext", "sysfonts", "showtextdb",
  "fontcm",
  "tikzDevice", "filehash", "png",
  "xkcd", "extrafontdb", "Rttf2pt1", "extrafont"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}

if (!all(c("source-han-sans-cn", "source-han-serif-cn") %in% showtextdb::font_installed())) {
  showtextdb::font_install(showtextdb::source_han_serif("CN"))
  showtextdb::font_install(showtextdb::source_han_sans("CN"))
}
extrafont::font_install("fontcm")
extrafont::loadfonts()

if (!"xkcd" %in% extrafont::fonts()) {
  path <- path.expand("~/.fonts")
  if (!file.exists(path)) {
    dir.create(path = path.expand("~/.fonts"))
  }
  download.file("http://simonsoftware.se/other/xkcd.ttf", dest = path.expand("~/.fonts/xkcd.ttf"), mode = "wb")
  extrafont::font_import(paths = path.expand("~/.fonts"), pattern = "[X/x]kcd", prompt = FALSE)
  extrafont::loadfonts()
}

extrafont::fonts() # registered with pdfFonts()
sysfonts::font_families() # List available font families

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = TRUE,
  cache = TRUE,
  citation.bibtex.max=999,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  # fig.showtext = TRUE, # too danger
  fig.asp = 0.618, # 1 / phi
  # fig.show = "hold", # not for python matplotlib
  fig.ext = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  dev = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  engine.path = list(
    octave = "/usr/bin/octave-cli"
  )
)
ext <- if (knitr::is_html_output()) ".svg" else if (knitr::is_latex_output()) ".pdf" else ".png"

# knitr::knit_hooks$set(optipng = knitr::hook_optipng, pdfcrop = knitr::hook_pdfcrop)

# https://github.com/yihui/knitr-examples/blob/master/085-pdfcrop.Rnw
# knitr::knit_hooks$set(crop = hook_pdfcrop)
options(
  repos = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/",
  tikzDefaultEngine = "xetex",
  tikzXelatexPackages = c(
    getOption("tikzXelatexPackages"),
    "\\usepackage[colorlinks, breaklinks]{hyperref}",
    "\\usepackage{color}",
    "\\usepackage{tikz}",
    "\\usepackage[active,tightpage,xetex]{preview}",
    "\\PreviewEnvironment{pgfpicture}",
    "\\usepackage{amsmath}",
    "\\usepackage{amsfonts}",
    "\\usepackage{mathrsfs}"
  )
)
# https://github.com/yihui/knitr-examples/blob/master/047-tikz-png.Rnw
# knitr::knit_hooks$set(tikz2png = function(before, options, envir) {
  # use this hook only for dev='tikz' and externalized tikz graphics
  # if (before || options$dev != "tikz" || !options$external || options$fig.num == 0) return()
  # figs <- knitr:::all_figs(options, ext = "pdf") # all figure names
  # note the tikz2png option is the extra parameters passed to 'convert'
  # for (fig in figs) {
    # system(sprintf("convert %s %s %s", options$tikz2png, fig, sub("\\.pdf$", ".png", fig)))
  # }
# })


is_on_travis = identical(Sys.getenv("TRAVIS"), "true")
is_online = curl::has_internet()

library(reticulate)
if(is_on_travis) use_virtualenv("shims") else use_python("/usr/bin/python", required = FALSE)
# Python 环境的描述在附录
# required = FALSE 默认值，如果按照指定的位置没有找到 Python 就会扫描其它版本
# use_python("/opt/pyenv/shims/python")
# use_virtualenv("shims")

# 设置环境变量 RSTUDIO_CONNECT_SERVER 由 travis-ci 设置
connectServer <- Sys.getenv("RSTUDIO_CONNECT_SERVER") # https://bookdown.org
apiKey <- Sys.getenv("RSTUDIO_CONNECT_API_KEY")
```

```{r include = FALSE}
knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = TRUE,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  fig.asp = 0.618
)
```


# 前言 {#preface .unnumbered}

```{r fig.align='center', echo=FALSE, include=identical(knitr:::pandoc_to(), 'html')}
knitr::include_graphics('images/peaks3D.png', dpi = NA)
```

> 荃者所以在鱼，得鱼而忘荃；蹄者所以在兔；得兔而忘蹄；言者所以在意，得意而忘言。吾安得夫忘言之人而与之言哉！

```{block2, type = 'flushright', html.tag = 'p'}
--- 摘自 《庄子·杂篇·物》
```

> The fish trap exists because of the fish; once you've gotten the fish, you can forget the trap. The rabbit snare exists because of the rabbit; once you've gotten the rabbit, you can forget the snare. Words exist because of meaning; once you've gotten the meaning, you can forget the words. Where can I find a man who has forgotten words so I can have a word with him ? ^[Translated by [Eric D. Kolaczyk](http://math.bu.edu/people/kolaczyk/teach.html)]

```{block2, type = 'flushright', html.tag = 'p'}
--- Chuang Tzu
```


1. 把平时遇到的问题分类汇总形成一本笔记，用以时常查看和更新。
2. 网罗精美的案例，学习之，应用之
3. 挑选感兴趣的新技能，钻研之
4. 学习心得和体会，尤其是那些年的淌坑经历
5. 从使用者到开发者蜕变，先啃一下 Hadley Wickham 的几本书：
    + The tidyverse style guide/A style guide for the R language <http://style.tidyverse.org/>
    + Advanced R <https://adv-r.hadley.nz/>
    + R packages <http://r-pkgs.had.co.nz/>
    + R for Data Science <http://r4ds.had.co.nz/>
6. 要写书搭网站，先看一下 Yihui Xie 的书
    + bookdown: Authoring Books and Technical Documents with R Markdown <https://bookdown.org/yihui/bookdown/>
    + blogdown: Creating Websites with R Markdown <https://bookdown.org/yihui/blogdown/>
    + R Markdown: The Definitive Guide <https://bookdown.org/yihui/rmarkdown/>

<!-- The R-Box 的创意来自 VirtualBox OSE，R-Box 容纳的是R基础、统计图形、统计计算、优化算法、统计模型等 -->

<!-- ```{r vbox-ose, echo=FALSE, out.width="55%", fig.cap="The R-Box", fig.link='https://www.virtualbox.org/wiki/Downloads'} -->
<!-- knitr::include_graphics(path = "images/VBoxOSE.png") -->
<!-- ``` -->



## 致谢 {#thanks .unnumbered}

虚位以待壮士

```{r contribs, results = "asis", echo = FALSE}
# copy from https://github.com/hadley/adv-r/edit/master/Introduction.Rmd
# contribs <- system("git --no-pager shortlog -ns > contribs.txt", intern = T)
contribs <- read.delim("contribs.txt", header = FALSE,
  stringsAsFactors = FALSE)[-1, ]
names(contribs) <- c("n", "name")

contribs <- contribs[order(contribs$name), ]
contribs$uname <- ifelse(!grepl(" ", contribs$name),
  paste0("\\@", contribs$name), contribs$name)

cat("Thanks go to all contributers in alphabetical order: ")
cat(paste0(contribs$uname, collapse = ", "))
cat(".\n")
```

非常感谢谁谁以及谁谁对我的帮助。

```{block2, type = 'flushright', html.tag = 'p'}
黄湘云  
于矿大宝源公寓
```

## 结构 {#structure .unnumbered}

第一章：数学符号说明
第二章：基础知识

- R语言基础、高级技巧

你好，世界。我写了一本书。这本书是这样的，第 \@ref(install-setup) 章介绍了啥啥，第 \@ref(math-operator) 章说了啥啥，然后是啥啥……

## 后记 {#colophon .unnumbered}

这本书是在 [RStudio](https://www.rstudio.com/products/rstudio/download/) 内用 [R Markdown](https://rmarkdown.rstudio.com/) 写的， [Git](https://git-scm.com/) 控制版本， [bookdown](https://bookdown.org/yihui/bookdown/) 组织章节， [knitr](https://yihui.name/knitr/) 将 R Markdown 源文件转化为 Markdown 文件， [Pandoc](http://pandoc.org) \index{Pandoc} 再将 Markdown 文件转化为 HTML 文档，而要转化为 PDF 文档则另外需要 TinyTeX\index{TinyTeX} 发行版^[<https://yihui.name/tinytex/>] 和来自 **rticles** [@R-rticles] 包的模板（一个基于 Pandoc 的 LaTeX 模板，两个美元符号包含的就是变量，变量基本上是 LaTeX 包的设置选项）。这个网站是通过 [Travis-CI](https://travis-ci.org/) 把编译结果（即 `_book` 目录）推送到 [Netlify](https://www.netlify.com/)，实现部署。在 Travis-CI 和 Netlify 都与 Github 绑定的情况下，源代码一发生改变就会触发编译和部署，即持续集成和连续部署，你正在阅读的是 `r Sys.Date()` 在 `r if(is_on_travis) "[Travis](https://travis-ci.org/XiangyunHuang/notesdown) 上" else "本地"`构建的。

`r if(knitr::is_html_output()) "如果编译和部署成功，你会看到一个绿色的指示器，否则指示器显示红色。[![Build Status](https://travis-ci.org/XiangyunHuang/notesdown.svg?branch=master)](https://travis-ci.org/XiangyunHuang/notesdown)"`

## 说明 {#conventions .unnumbered}

[sourceserifpro](https://ctan.org/pkg/sourceserifpro) 设为默认英文字体，[inconsolata](http://levien.com/type/myfonts/inconsolata.html) 用于代码显示，R 包名称在文中以粗体显示，代码块输出用 `#>` 表示，以区分普通的代码注释 `#`

我用了两个 R 包编译这本书，分别是 **knitr**\index{knitr} [@Dynamic2015CRC] 和 **bookdown**\index{bookdown} [@bookdown2016CRC]。绘图使用的中文字体是思源宋体和思源黑体， **showtext**\index{showtext} 包安装和调用，**tikzDevice**\index{tikzDevice} 和 **fontcm**\index{fontcm} 处理其中的数学公式，**xkcd**\index{xkcd} 设置漫画手写体风格，以下是我的 R 进程信息：

```{r}
xfun::session_info()
```

## 授权 {#licenses .unnumbered}

```{block2, type = 'rmdwarning'}
本书采用 [知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议](https://creativecommons.org/licenses/by-nc-nd/4.0/) 许可，请君自重，别没事儿拿去传个什么新浪爱问、百度文库以及 XX 经济论坛，项目中代码使用 [MIT 协议](https://github.com/XiangyunHuang/notesdown/blob/master/LICENSE) 开源
```
```{r cc, echo = FALSE, out.width = "15%", fig.align = 'left'}
ext <- if (knitr::is_html_output()) ".svg" else if (knitr::is_latex_output()) ".eps" else ".png"
knitr::include_graphics(path = paste0("images/by-nc-nd",ext))
```


```{r, include = FALSE, cache = FALSE}
# automatically create a bib database for R packages
knitr::write_bib(c(
  .packages(TRUE)
), "packages.bib")
```

<!--chapter:end:index.Rmd-->

```{r include=FALSE, cache=FALSE}
library(methods)
set.seed(2018)
options(digits = 3)

Pkgs <- c(
  "reticulate",
  "showtext", "sysfonts", "showtextdb",
  "fontcm",
  "tikzDevice", "filehash", "png",
  "xkcd", "extrafontdb", "Rttf2pt1", "extrafont"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}

if (!all(c("source-han-sans-cn", "source-han-serif-cn") %in% showtextdb::font_installed())) {
  showtextdb::font_install(showtextdb::source_han_serif("CN"))
  showtextdb::font_install(showtextdb::source_han_sans("CN"))
}
extrafont::font_install("fontcm")
extrafont::loadfonts()

if (!"xkcd" %in% extrafont::fonts()) {
  path <- path.expand("~/.fonts")
  if (!file.exists(path)) {
    dir.create(path = path.expand("~/.fonts"))
  }
  download.file("http://simonsoftware.se/other/xkcd.ttf", dest = path.expand("~/.fonts/xkcd.ttf"), mode = "wb")
  extrafont::font_import(paths = path.expand("~/.fonts"), pattern = "[X/x]kcd", prompt = FALSE)
  extrafont::loadfonts()
}

extrafont::fonts() # registered with pdfFonts()
sysfonts::font_families() # List available font families

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = TRUE,
  cache = TRUE,
  citation.bibtex.max=999,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  # fig.showtext = TRUE, # too danger
  fig.asp = 0.618, # 1 / phi
  # fig.show = "hold", # not for python matplotlib
  fig.ext = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  dev = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  engine.path = list(
    octave = "/usr/bin/octave-cli"
  )
)
ext <- if (knitr::is_html_output()) ".svg" else if (knitr::is_latex_output()) ".pdf" else ".png"

# knitr::knit_hooks$set(optipng = knitr::hook_optipng, pdfcrop = knitr::hook_pdfcrop)

# https://github.com/yihui/knitr-examples/blob/master/085-pdfcrop.Rnw
# knitr::knit_hooks$set(crop = hook_pdfcrop)
options(
  repos = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/",
  tikzDefaultEngine = "xetex",
  tikzXelatexPackages = c(
    getOption("tikzXelatexPackages"),
    "\\usepackage[colorlinks, breaklinks]{hyperref}",
    "\\usepackage{color}",
    "\\usepackage{tikz}",
    "\\usepackage[active,tightpage,xetex]{preview}",
    "\\PreviewEnvironment{pgfpicture}",
    "\\usepackage{amsmath}",
    "\\usepackage{amsfonts}",
    "\\usepackage{mathrsfs}"
  )
)
# https://github.com/yihui/knitr-examples/blob/master/047-tikz-png.Rnw
# knitr::knit_hooks$set(tikz2png = function(before, options, envir) {
  # use this hook only for dev='tikz' and externalized tikz graphics
  # if (before || options$dev != "tikz" || !options$external || options$fig.num == 0) return()
  # figs <- knitr:::all_figs(options, ext = "pdf") # all figure names
  # note the tikz2png option is the extra parameters passed to 'convert'
  # for (fig in figs) {
    # system(sprintf("convert %s %s %s", options$tikz2png, fig, sub("\\.pdf$", ".png", fig)))
  # }
# })


is_on_travis = identical(Sys.getenv("TRAVIS"), "true")
is_online = curl::has_internet()

library(reticulate)
if(is_on_travis) use_virtualenv("shims") else use_python("/usr/bin/python", required = FALSE)
# Python 环境的描述在附录
# required = FALSE 默认值，如果按照指定的位置没有找到 Python 就会扫描其它版本
# use_python("/opt/pyenv/shims/python")
# use_virtualenv("shims")

# 设置环境变量 RSTUDIO_CONNECT_SERVER 由 travis-ci 设置
connectServer <- Sys.getenv("RSTUDIO_CONNECT_SERVER") # https://bookdown.org
apiKey <- Sys.getenv("RSTUDIO_CONNECT_API_KEY")
```
# 作者简介 {#authors}

我是黄湘云，即将毕业的硕士研究生，跟随导师学习数理统计，主修 R 语言，顺便学了点统计，南方人， 2017年6月开始混迹于 Github ， 虽然2015年就注册了， 但是一直没有用起来， 后来有了直接的刚需（因为工作需要嘛），全是自学和靠大牛指点，偶尔参加一些技术大会和沙龙， 周边学校也去听讲座， 对学术大牛心里充满无限敬仰。

本科学过 Photoshop 接触过 AI 和 AE，后来学了 R 这些就淡忘了，但是图层这个概念却一直记忆犹新，因为图层在 ggplot2 中是一个很关键的概念。

Python 喊着要学，已经叫唤两年了，今年打算学个入门。
Mxnet、Xgboost 和 Stan 也是要学的，下半年正式入职京东了，另外一个可能要学的是 [INLA](http://www.r-inla.org) 专用于处理空间广义线性混合效应模型，这个会在混合效应模型的相关章节予以介绍。

<!--chapter:end:00-authors.Rmd-->

```{r include=FALSE, cache=FALSE}
library(methods)
set.seed(2018)
options(digits = 3)

Pkgs <- c(
  "reticulate",
  "showtext", "sysfonts", "showtextdb",
  "fontcm",
  "tikzDevice", "filehash", "png",
  "xkcd", "extrafontdb", "Rttf2pt1", "extrafont"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}

if (!all(c("source-han-sans-cn", "source-han-serif-cn") %in% showtextdb::font_installed())) {
  showtextdb::font_install(showtextdb::source_han_serif("CN"))
  showtextdb::font_install(showtextdb::source_han_sans("CN"))
}
extrafont::font_install("fontcm")
extrafont::loadfonts()

if (!"xkcd" %in% extrafont::fonts()) {
  path <- path.expand("~/.fonts")
  if (!file.exists(path)) {
    dir.create(path = path.expand("~/.fonts"))
  }
  download.file("http://simonsoftware.se/other/xkcd.ttf", dest = path.expand("~/.fonts/xkcd.ttf"), mode = "wb")
  extrafont::font_import(paths = path.expand("~/.fonts"), pattern = "[X/x]kcd", prompt = FALSE)
  extrafont::loadfonts()
}

extrafont::fonts() # registered with pdfFonts()
sysfonts::font_families() # List available font families

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = TRUE,
  cache = TRUE,
  citation.bibtex.max=999,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  # fig.showtext = TRUE, # too danger
  fig.asp = 0.618, # 1 / phi
  # fig.show = "hold", # not for python matplotlib
  fig.ext = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  dev = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  engine.path = list(
    octave = "/usr/bin/octave-cli"
  )
)
ext <- if (knitr::is_html_output()) ".svg" else if (knitr::is_latex_output()) ".pdf" else ".png"

# knitr::knit_hooks$set(optipng = knitr::hook_optipng, pdfcrop = knitr::hook_pdfcrop)

# https://github.com/yihui/knitr-examples/blob/master/085-pdfcrop.Rnw
# knitr::knit_hooks$set(crop = hook_pdfcrop)
options(
  repos = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/",
  tikzDefaultEngine = "xetex",
  tikzXelatexPackages = c(
    getOption("tikzXelatexPackages"),
    "\\usepackage[colorlinks, breaklinks]{hyperref}",
    "\\usepackage{color}",
    "\\usepackage{tikz}",
    "\\usepackage[active,tightpage,xetex]{preview}",
    "\\PreviewEnvironment{pgfpicture}",
    "\\usepackage{amsmath}",
    "\\usepackage{amsfonts}",
    "\\usepackage{mathrsfs}"
  )
)
# https://github.com/yihui/knitr-examples/blob/master/047-tikz-png.Rnw
# knitr::knit_hooks$set(tikz2png = function(before, options, envir) {
  # use this hook only for dev='tikz' and externalized tikz graphics
  # if (before || options$dev != "tikz" || !options$external || options$fig.num == 0) return()
  # figs <- knitr:::all_figs(options, ext = "pdf") # all figure names
  # note the tikz2png option is the extra parameters passed to 'convert'
  # for (fig in figs) {
    # system(sprintf("convert %s %s %s", options$tikz2png, fig, sub("\\.pdf$", ".png", fig)))
  # }
# })


is_on_travis = identical(Sys.getenv("TRAVIS"), "true")
is_online = curl::has_internet()

library(reticulate)
if(is_on_travis) use_virtualenv("shims") else use_python("/usr/bin/python", required = FALSE)
# Python 环境的描述在附录
# required = FALSE 默认值，如果按照指定的位置没有找到 Python 就会扫描其它版本
# use_python("/opt/pyenv/shims/python")
# use_virtualenv("shims")

# 设置环境变量 RSTUDIO_CONNECT_SERVER 由 travis-ci 设置
connectServer <- Sys.getenv("RSTUDIO_CONNECT_SERVER") # https://bookdown.org
apiKey <- Sys.getenv("RSTUDIO_CONNECT_API_KEY")
```
# 符号说明 {#notations}

- $S \neq \varnothing$
- 
- $\mathbf{A,B,C},\mathsf{A,B,C},\mathit{A,B,C}$
- $\mathrm{A,B,C}$
- $\mathfrak{A,B,C}$
- $$X,Y,D, \mathbf{X,Y,D},\mathsf{X,Y,D},\mathit{X,Y,D},\mathrm{X,Y,D}$$

$A,B,C,D$ 斜体表示普通的集合，$X,Y,Z$ 表示矩阵，$a,b,c,d$ 表示常数，$\alpha,\beta,\theta,\phi,\kappa$ 表示模型或者分布函数的参数，$\Theta$ 表示参数空间，$\mathbb{R}^{n},\mathbb{C}^{n}$ 表示特殊的 $n$ 维实（复）数域，$\mathscr{A,B,C,D}$ 表示一般的数域，$\mathcal{S,P,G}$ 分别表示随机过程、概率空间和图

|                 符号                  |                    含义                     |                 符号                 |                     含义                      |
| :-----------------------------------: | :-----------------------------------------: | :----------------------------------: | :-------------------------------------------: |
|             $\mathbf{A}$              |                    粗体                     |               $\Omega$               |                     全集                      |
|             $\mathit{A}$              |                    集合                     |            $\mathbb{R,C}$            |                 实（复）数集                  |
|             $\mathcal{A}$             |                    集族                     |            $\varnothing$             |                     空集                      |
|             $\mathsf{A}$              |                    矩阵                     |           $\mathsf{A}^{-}$           |                 矩阵的广义逆                  |
|           $\mathsf{A}^\top$           |                  矩阵转置                   |              $\bar{x}$               |                    平均值                     |
|       $\mathsf{A}^{-1}$        |                  矩阵的逆                   |           $\vert a \vert$            |                  标量绝对值                   |
|         $\mathsf{A}^{\star}$          |                  伴随矩阵                   | $\mathop{\mathrm{diag}}(\mathsf{A})$ |                  矩阵的对角                   |
|    $\lVert \mathsf{A} \rVert_{1}$     |                 矩阵的1范数                 |             $\mathsf{I}$             |                   单位矩阵                    |
|    $\lVert \mathsf{A} \rVert_{2}$     |                 矩阵的2范数                 |           $\mathsf{I}_{n}$           |                $n$ 阶单位矩阵                 |
|  $\lVert \mathsf{A} \rVert_{\infty}$  |               矩阵的无穷范数                |             $\mathsf{1}$             |                    全1矩阵                    |
|    $\lVert \mathsf{X} \rVert_{1}$     |                 向量的1范数                 |           $\mathsf{1}_{n}$           |                 $n$ 阶全1矩阵                 |
|    $\lVert \mathsf{X} \rVert_{2}$     |                 向量的2范数                 | $\lVert \mathsf{X} \rVert_{\infty}$  |                向量的无穷范数                 |
| $\langle\mathsf{X},\mathsf{Y}\rangle$ |                 向量的内积                  |           $f(\mathsf{X})$            |                随机变量的函数                 |
|    $\mathsf{X} \wedge \mathsf{Y}$     |                 向量的外积                  |         $\nabla{\mathsf{X}}$         |                向量微分或梯度                 |
|                $\beta$                |                  模型系数                   |               $\theta$               |                模型或分布参数                 |
|               $\alpha$                |                  模型截距                   |               $\Theta$               |                   参数空间                    |
|          $\hat{\beta}_{ls}$           |              模型系数的LS估计               |                $f(x)$                |                  标量值函数                   |
|          $\hat{\beta}_{mle}$          |              模型系数的MLE估计              |           $f(\mathsf{X})$            |                  向量的函数                   |
|         $\hat{\beta}_{bayes}$         |             模型系数的Bayes估计             |            $\mathcal{X}$             |                   概率空间                    |
|                $\rho$                 |                  相关系数                   |               $\kappa$               |                贝塞尔函数的阶                 |
|                $\phi$                 |                  尺度参数                   |                 $u$                  | 距离 $\lVert \mathsf{x}_1 -\mathsf{x}_2 \rVert$ |
|            $\mathbb{R}^2$             |                 二维实数域                  |                $S(x)$                |                   空间过程                    |
|             $\mathcal{S}$             | $\mathcal{S} = \{S(x):x \in \mathbb{R}^2\}$ |        $\mathcal{S}^{\star}$         |         随机过程 $\mathcal{S}$ 的近似         |

- 多元统计分析 高惠璇 矩阵符号表示
- 深度学习符号表示 <https://github.com/XiangyunHuang/dlbook>

举例，线性模型的表示，此处 $Y$ 为 $n\times 1$列向量，$X$ 为$p\times n$的矩阵，$\beta$ 为 $p\times 1$的列向量 ，$\epsilon$ 为$n\times1$列向量
$$Y = X'\beta + \epsilon$$
$$\mathsf{A} = \varGamma^\top\Lambda\varGamma$$
$$\mathsf{u} = (u_1,u_2,\cdots,u_n)$$
$$\mathsf{x} = (x_1,x_2,\cdots,x_n)$$
期望 $\mathsf{E}$ 正态分布 $\mathcal{N}(\mathsf{x};\mathsf{\mu},\mathsf{\Sigma})$
对数 $\mathsf{\log}$ 协方差 $\mathsf{Cov},\mathsf{Var}$ 

矩阵 $$\mathsf{Y} = (\mathsf{y}^{(1)},\mathsf{y}^{(n)},\cdots,\mathsf{y}^{(n)})$$
其中 $\mathsf{y}^{(i)} = (y_{1i},y_{2i},\cdots,y_{ni})$ 表示第 $i$ 列

梅隆函数(Matern function)是描述空间相关性的常用函数，它带有两参数$\kappa$ 和 $\phi$，具体形式如下：
$$\rho(u) = \big\{2^{\kappa-1}\Gamma(\kappa)\big\}^{-1}(u/\phi)^{\kappa}K_{\kappa}(u/\phi)$$
其中，$K_{\kappa}(\cdot)$ 表示 $\kappa$ 阶修正的贝塞尔函数

<!--chapter:end:00-notations.Rmd-->

```{r include=FALSE, cache=FALSE}
library(methods)
set.seed(2018)
options(digits = 3)

Pkgs <- c(
  "reticulate",
  "showtext", "sysfonts", "showtextdb",
  "fontcm",
  "tikzDevice", "filehash", "png",
  "xkcd", "extrafontdb", "Rttf2pt1", "extrafont"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}

if (!all(c("source-han-sans-cn", "source-han-serif-cn") %in% showtextdb::font_installed())) {
  showtextdb::font_install(showtextdb::source_han_serif("CN"))
  showtextdb::font_install(showtextdb::source_han_sans("CN"))
}
extrafont::font_install("fontcm")
extrafont::loadfonts()

if (!"xkcd" %in% extrafont::fonts()) {
  path <- path.expand("~/.fonts")
  if (!file.exists(path)) {
    dir.create(path = path.expand("~/.fonts"))
  }
  download.file("http://simonsoftware.se/other/xkcd.ttf", dest = path.expand("~/.fonts/xkcd.ttf"), mode = "wb")
  extrafont::font_import(paths = path.expand("~/.fonts"), pattern = "[X/x]kcd", prompt = FALSE)
  extrafont::loadfonts()
}

extrafont::fonts() # registered with pdfFonts()
sysfonts::font_families() # List available font families

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = TRUE,
  cache = TRUE,
  citation.bibtex.max=999,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  # fig.showtext = TRUE, # too danger
  fig.asp = 0.618, # 1 / phi
  # fig.show = "hold", # not for python matplotlib
  fig.ext = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  dev = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  engine.path = list(
    octave = "/usr/bin/octave-cli"
  )
)
ext <- if (knitr::is_html_output()) ".svg" else if (knitr::is_latex_output()) ".pdf" else ".png"

# knitr::knit_hooks$set(optipng = knitr::hook_optipng, pdfcrop = knitr::hook_pdfcrop)

# https://github.com/yihui/knitr-examples/blob/master/085-pdfcrop.Rnw
# knitr::knit_hooks$set(crop = hook_pdfcrop)
options(
  repos = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/",
  tikzDefaultEngine = "xetex",
  tikzXelatexPackages = c(
    getOption("tikzXelatexPackages"),
    "\\usepackage[colorlinks, breaklinks]{hyperref}",
    "\\usepackage{color}",
    "\\usepackage{tikz}",
    "\\usepackage[active,tightpage,xetex]{preview}",
    "\\PreviewEnvironment{pgfpicture}",
    "\\usepackage{amsmath}",
    "\\usepackage{amsfonts}",
    "\\usepackage{mathrsfs}"
  )
)
# https://github.com/yihui/knitr-examples/blob/master/047-tikz-png.Rnw
# knitr::knit_hooks$set(tikz2png = function(before, options, envir) {
  # use this hook only for dev='tikz' and externalized tikz graphics
  # if (before || options$dev != "tikz" || !options$external || options$fig.num == 0) return()
  # figs <- knitr:::all_figs(options, ext = "pdf") # all figure names
  # note the tikz2png option is the extra parameters passed to 'convert'
  # for (fig in figs) {
    # system(sprintf("convert %s %s %s", options$tikz2png, fig, sub("\\.pdf$", ".png", fig)))
  # }
# })


is_on_travis = identical(Sys.getenv("TRAVIS"), "true")
is_online = curl::has_internet()

library(reticulate)
if(is_on_travis) use_virtualenv("shims") else use_python("/usr/bin/python", required = FALSE)
# Python 环境的描述在附录
# required = FALSE 默认值，如果按照指定的位置没有找到 Python 就会扫描其它版本
# use_python("/opt/pyenv/shims/python")
# use_virtualenv("shims")

# 设置环境变量 RSTUDIO_CONNECT_SERVER 由 travis-ci 设置
connectServer <- Sys.getenv("RSTUDIO_CONNECT_SERVER") # https://bookdown.org
apiKey <- Sys.getenv("RSTUDIO_CONNECT_API_KEY")
```
\mainmatter

# (PART) 基础知识 {-}

<!--chapter:end:Foundations.Rmd-->

```{r include=FALSE, cache=FALSE}
library(methods)
set.seed(2018)
options(digits = 3)

Pkgs <- c(
  "reticulate",
  "showtext", "sysfonts", "showtextdb",
  "fontcm",
  "tikzDevice", "filehash", "png",
  "xkcd", "extrafontdb", "Rttf2pt1", "extrafont"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}

if (!all(c("source-han-sans-cn", "source-han-serif-cn") %in% showtextdb::font_installed())) {
  showtextdb::font_install(showtextdb::source_han_serif("CN"))
  showtextdb::font_install(showtextdb::source_han_sans("CN"))
}
extrafont::font_install("fontcm")
extrafont::loadfonts()

if (!"xkcd" %in% extrafont::fonts()) {
  path <- path.expand("~/.fonts")
  if (!file.exists(path)) {
    dir.create(path = path.expand("~/.fonts"))
  }
  download.file("http://simonsoftware.se/other/xkcd.ttf", dest = path.expand("~/.fonts/xkcd.ttf"), mode = "wb")
  extrafont::font_import(paths = path.expand("~/.fonts"), pattern = "[X/x]kcd", prompt = FALSE)
  extrafont::loadfonts()
}

extrafont::fonts() # registered with pdfFonts()
sysfonts::font_families() # List available font families

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = TRUE,
  cache = TRUE,
  citation.bibtex.max=999,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  # fig.showtext = TRUE, # too danger
  fig.asp = 0.618, # 1 / phi
  # fig.show = "hold", # not for python matplotlib
  fig.ext = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  dev = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  engine.path = list(
    octave = "/usr/bin/octave-cli"
  )
)
ext <- if (knitr::is_html_output()) ".svg" else if (knitr::is_latex_output()) ".pdf" else ".png"

# knitr::knit_hooks$set(optipng = knitr::hook_optipng, pdfcrop = knitr::hook_pdfcrop)

# https://github.com/yihui/knitr-examples/blob/master/085-pdfcrop.Rnw
# knitr::knit_hooks$set(crop = hook_pdfcrop)
options(
  repos = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/",
  tikzDefaultEngine = "xetex",
  tikzXelatexPackages = c(
    getOption("tikzXelatexPackages"),
    "\\usepackage[colorlinks, breaklinks]{hyperref}",
    "\\usepackage{color}",
    "\\usepackage{tikz}",
    "\\usepackage[active,tightpage,xetex]{preview}",
    "\\PreviewEnvironment{pgfpicture}",
    "\\usepackage{amsmath}",
    "\\usepackage{amsfonts}",
    "\\usepackage{mathrsfs}"
  )
)
# https://github.com/yihui/knitr-examples/blob/master/047-tikz-png.Rnw
# knitr::knit_hooks$set(tikz2png = function(before, options, envir) {
  # use this hook only for dev='tikz' and externalized tikz graphics
  # if (before || options$dev != "tikz" || !options$external || options$fig.num == 0) return()
  # figs <- knitr:::all_figs(options, ext = "pdf") # all figure names
  # note the tikz2png option is the extra parameters passed to 'convert'
  # for (fig in figs) {
    # system(sprintf("convert %s %s %s", options$tikz2png, fig, sub("\\.pdf$", ".png", fig)))
  # }
# })


is_on_travis = identical(Sys.getenv("TRAVIS"), "true")
is_online = curl::has_internet()

library(reticulate)
if(is_on_travis) use_virtualenv("shims") else use_python("/usr/bin/python", required = FALSE)
# Python 环境的描述在附录
# required = FALSE 默认值，如果按照指定的位置没有找到 Python 就会扫描其它版本
# use_python("/opt/pyenv/shims/python")
# use_virtualenv("shims")

# 设置环境变量 RSTUDIO_CONNECT_SERVER 由 travis-ci 设置
connectServer <- Sys.getenv("RSTUDIO_CONNECT_SERVER") # https://bookdown.org
apiKey <- Sys.getenv("RSTUDIO_CONNECT_API_KEY")
```
\mainmatter

# 安装与配置 {#install-setup}

```{r include = FALSE, eval = .Platform$OS.type != "windows"}
Pkgs <- c(
  "RDieHarder", "magrittr"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) 
  install.packages(setdiff(Pkgs, .packages(TRUE)))
```

## 安装 R 软件

Windows 下安装指导见《R语言忍者秘笈》的第二章^[<https://bookdown.org/yihui/r-ninja/setup.html>]

推荐没事多翻翻官网 [FAQ 文档](https://mirrors.tuna.tsinghua.edu.cn/CRAN/doc/FAQ/R-FAQ.html) 以及6本自带的手册

* **An Introduction to R** (R-intro) includes information on data types, programming elements, statistical modeling and graphics. This document is based on the **Notes on S-PLUS** by Bill Venables and David Smith.
    + 介绍数据类型，编程基础，统计模型和图形
* **Writing R Extensions** (R-exts) currently describes the process of creating R add-on packages, writing R documentation, R’s system and foreign language interfaces, and the R API.
    + 描述创建扩展包、写R包文档的过程，介绍 R 系统，外部语言接口以及 R 的API
* **R Data Import/Export** (R-data) is a guide to importing and exporting data to and from R.
    + 从 R 导入和导出数据
* **The R Language Definition** (R-lang), a first version of the *Kernighan & Ritchie of R*, explains evaluation, parsing, object oriented programming, computing on the language, and so forth.
    + 介绍 R 语言程序设计，解释计算、解析、面向对象编程以及计算
* **R Installation and Administration** (R-admin).
    + R 安装和管理
* **R Internals** (R-ints) is a guide to R’s internal structures. (Added in R 2.4.0.)
    + R 内部结构指南

Hadley Wickham 正在写文档介绍 [Documentation for R's internal C API](https://github.com/hadley/r-internals)

- 从源码编译 R 的需求在哪呢？

1. 爱折腾的极客：玩配置，学习 make 相关工具和 Linux 世界的依赖
2. 追求性能：如 [LFS 支持](http://users.suse.com/~aj/linux_lfs.html) 和 [Intel MKL 加速](http://dirk.eddelbuettel.com/blog/2018/04/15/#018_mkl_for_debian_ubuntu)
3. 环境限制：CentOS 6/7 或者红帽系统，自带的R版本比较落后
4. 微软提供的一套 MSR （这里不需要编译）

现在很多东西都讲究 docker 化，直接往 CentOS 系统上编译安装最新版 R 会越来越少，这里给个例子，在 docker 内安装 R 和扩展包，Dockerfile 的内容如下

```{r docker-file}
cat(readLines("docs/Dockerfile", encoding = "UTF-8") ,sep = "\n")
```

这种方式可以安装到最新版的 R，同时省去了自己配置安装过程中的麻烦，只是系统自带的 texlive 还是比较旧，如何安装 tlmgr 管理器，安装新的 TeX 包到之前的位置值得考虑，主要目的是为中文的 R Markdown 文档服务。

Pandoc 提供的 LaTeX 文类，是希望用户在 YAML 指定 CJKmainfont 等，显式地安装系统中文字体供使用，楷体和宋体，文泉驿黑体都是系统自带的。要我说可以用思源黑体和宋体，或者自己拷贝一份中文字体到 `~/.fonts` 然后刷新，就是添加这样一段代码，这种做法使用最广

```
RUN mkdir ~/.fonts \
  && curl -o ~/.fonts/Inconsolata-Bold.ttf https://raw.githubusercontent.com/google/fonts/master/ofl/inconsolata/Inconsolata-Bold.ttf \
  && curl -o ~/.fonts/Inconsolata-Regular.ttf https://raw.githubusercontent.com/google/fonts/master/ofl/inconsolata/Inconsolata-Regular.ttf \
  && fc-cache -fv ~/.fonts \
```

文泉驿字体

```
wqy-unibit-fonts wqy-microhei-fonts wqy-zenhei-fonts
```

安装 RStudio 或者 RStudio Server 请看官网介绍

-  <https://www.rstudio.com/products/rstudio/download/>
-  <http://docs.rstudio.com/ide/server-pro/>

* 安装 Microsoft R Open <https://mran.microsoft.com/documents/rro/installation#revorinst-lin>
* 安装 Machine Learning Server
    + [在线安装](https://docs.microsoft.com/en-us/machine-learning-server/install/machine-learning-server-linux-install)
    + [离线安装](https://docs.microsoft.com/en-us/machine-learning-server/install/machine-learning-server-linux-offline)


## 安装 R 扩展包

- 从指定的镜像站点安装（源头）

```{r,eval=FALSE}
install.packages("rbokeh", repos = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/")
```

- 再指定安装的位置（本地）

```{r,eval=FALSE}
install.packages("rbokeh",
  repos = c(
    deltarho = "http://packages.deltarho.org",
    getOption("repos")
  ),
  lib = R.home("site-library")
)
```

- 安装 Bioconductor 上的 R 包

```{r,eval=FALSE}
source("https://bioconductor.org/biocLite.R")
BiocInstaller::biocLite("rbokeh")
```

- 安装Github上的R包

```{r,eval=FALSE}
devtools::install_github("bokeh/rbokeh")
```

- 依赖问题：主要针对离线安装和源码编译安装
- 平台问题：有些 R 包只能装在 Linux 操作系统上
- 软件问题：有些 R 包要求相应 R 软件版本
- 特定库依赖：如 **RDieHarder** \index{RDieHarder} 包就依赖 `libgsl-dev` 和 `libdieharder-dev` 库

所以我们需要查看以下信息

```{r}
sessionInfo()
```

有时候甚至是

```{r}
devtools::session_info("showtext")
```

```{block2, type='rmdnote'}
推荐 `devtools::session_info("package")` 而不是 `sessionInfo()`，尤其在遇到因为版本不对而带来错误的时候，如 <https://d.cosx.org/d/419765-showtext>
```


### SparkR

### sparklyr

```{r,eval=FALSE}
library(sparklyr)
# spark_available_versions()
spark_install(version = "2.2.0", hadoop_version = "2.7")
```

### DBI

这是一个存放在Github上的包，随着 ClikHouse 在大厂的流行，此包也受到越来越多的关注
与数据仓库如何连接，如何查询数据，背后的接口 DBI 如何使用，实例化一个新的接口（如 clickhouse2r ）

- <https://github.com/hannesmuehleisen/clickhouse-r>
- 壮士！交给你个任务，基于 clickhouse 的 odbc 驱动 <https://github.com/yandex/clickhouse-odbc> 写了 R 包如何，顺带介绍 clickhouse ，再给统计之都投篇稿子，在明年的 R 会给个相关报告。名字 r4clickhouse 还是 clickhouse4r 呢

[ClickHouse](https://clickhouse.yandex/) 独辟蹊径，基于 C++ 的实现，数据查询速度超级快，官网介绍碾压大量传统数据库。还有不少接口，其中还有 R 的 <https://github.com/hannesmuehleisen/clickhouse-r> 

- 安装

```r
devtools::install_github("hannesmuehleisen/clickhouse-r")
```

下载 <https://clickhouse.yandex/docs/en/single/#installation>

- 使用

```{r,eval=FALSE}
library(DBI)
con <- dbConnect(clickhouse::clickhouse(),
  host = "localhost",
  port = 8123L,
  user = "default",
  password = ""
)
dbWriteTable(con, "mtcars", mtcars)
dbListTables(con)
dbGetQuery(con, "SELECT COUNT(*) FROM mtcars")
d <- dbReadTable(con, "mtcars")
dbDisconnect(con)
```

发现它和 knitr  里的 SQL 钩子，都用 DBI 这个R包  <https://github.com/rstats-db/DBI>

```{r clickhouse,fig.cap="ClickHouse与R"}
knitr::include_graphics(path = "images/clickhouse.png")
```

参考 <https://d.cosx.org/d/419974-r-markdown-sql>

````markdown
`r ''````{r setup}
library(DBI)
library(RMySQL)
# 这里的数据库链接信息我改了
db <- dbConnect(MySQL(),
  dbname = "dbtest",
  username = "user_test",
  password = "password",
  host = "10.10.101.10",
  port = 3306
)
# 创建默认连接
knitr::opts_chunk$set(connection = "db")
# 设置字符，以免中文查询乱码
dbSendQuery(db, "SET NAMES utf8")
# 设置日期变量，以运用在SQL中
idate <- "2018-05-03"
# 请忽略我
```
````

SQL中使用R的变量并将结果输出为数据框

````markdown
`r ''````{sql, output.var="data_output"}
SELECT * FROM user_table where date_format(created_date,'%Y-%m-%d')>=?idate  
# 请忽略我
```
````

以上代码会将SQL的运行结果存在 `data_output` 这是数据库中。如果SQL比较长，为了代码美观，把带有变量的SQL保存为.sql脚本，那怎么在SQL的chunk中直接导入SQL文件

````markdown
`r ''````{sql, code=readLines("你的脚本.sql")}
```
````


### reticulate

Python 与 R 交互

### INLA 

具有非常多的依赖关系，除了 CRAN 还有来自 bioconductor 的包，介绍 <http://www.r-inla.org/events/newtutorialsonspatialmodelsininla>

```{r,eval=FALSE}
install.packages("INLA",
  repos = "https://www.math.ntnu.no/inla/R/testing"
)
```

### mxnet

依赖也是很多，主要在于 GPU 版如何安装使用

### tensorflow

同样地，依赖也是很多，主要在于 GPU 版如何安装使用

## 安装 IDE

RStudio


## 配置文件


工作目录下的 .Rprofile，设置 site-library，设置环境变量 Renviron



## 小技巧 {#tricks}

1. 设置 Notepad++ 为 Git Bash 默认编辑器

图 \@ref(fig:notepad-git) 所示^[<http://readorskip.com/2016/09/12/Using-Notepad-to-Write-Git-Commit-Messages/>]

```{r notepad-git,fig.cap="Notepad++ 与 Git"}
knitr::include_graphics(path = "images/git-vim-commit-message.png")
```

在 Git Bash 中输入下面一行

```bash
git config --global core.editor "'c:\Program Files\Notepad++\notepad++.exe' -multiInst -notabbar -nosession -noPlugin '$*'"
```

Windows下配置 Git 中 ssh-agent 自动启动 <https://lfkid.github.io/>
这种让 Git 的 ssh-agent 常驻内存貌似不合理，占内存嘛

设置 ssh 和 store 保存应该比较好


2. 打开 bookdown 项目出来警告

如图 \@ref(fig:yaml-load) 所示，目前只出现在 Windows 平台下

```{r yaml-load,echo=FALSE,fig.cap="YAML 扫描错误"}
knitr::include_graphics(path = "diagrams/ymal-load-error.png")
```

直观来看，是字符串 string 本身需要转化为 UTF8（其实是需要YAML区域都变成UTF8），有关详细介绍见 <http://biostat.mc.vanderbilt.edu/wiki/Main/YamlR#yaml.load> 和 <https://github.com/viking/r-yaml>

```{r,echo=TRUE}
yaml::yaml.load
```

先看个简单的

```{r}
yaml::yaml.load('你好')
```

开发者用如下方式避免一个警告 [issues #47](https://github.com/viking/r-yaml/issues/47)

```{r}
yaml::yaml.load("!expr paste('orange')", handlers = list(expr = function(x) eval(parse(text = x))))
```

要么等着 YAML 更新，要么等着 bookdown 或 rmarkdown 更新，目前还是在 rocker 下编辑吧，看着红红的警告信息，心里有点烦。

- <https://github.com/viking/r-yaml/issues/6>
- <https://github.com/rstudio/rmarkdown/issues/420>
- <https://github.com/rstudio/config/issues/12>

<!--chapter:end:01-installations.Rmd-->

```{r include=FALSE, cache=FALSE}
library(methods)
set.seed(2018)
options(digits = 3)

Pkgs <- c(
  "reticulate",
  "showtext", "sysfonts", "showtextdb",
  "fontcm",
  "tikzDevice", "filehash", "png",
  "xkcd", "extrafontdb", "Rttf2pt1", "extrafont"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}

if (!all(c("source-han-sans-cn", "source-han-serif-cn") %in% showtextdb::font_installed())) {
  showtextdb::font_install(showtextdb::source_han_serif("CN"))
  showtextdb::font_install(showtextdb::source_han_sans("CN"))
}
extrafont::font_install("fontcm")
extrafont::loadfonts()

if (!"xkcd" %in% extrafont::fonts()) {
  path <- path.expand("~/.fonts")
  if (!file.exists(path)) {
    dir.create(path = path.expand("~/.fonts"))
  }
  download.file("http://simonsoftware.se/other/xkcd.ttf", dest = path.expand("~/.fonts/xkcd.ttf"), mode = "wb")
  extrafont::font_import(paths = path.expand("~/.fonts"), pattern = "[X/x]kcd", prompt = FALSE)
  extrafont::loadfonts()
}

extrafont::fonts() # registered with pdfFonts()
sysfonts::font_families() # List available font families

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = TRUE,
  cache = TRUE,
  citation.bibtex.max=999,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  # fig.showtext = TRUE, # too danger
  fig.asp = 0.618, # 1 / phi
  # fig.show = "hold", # not for python matplotlib
  fig.ext = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  dev = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  engine.path = list(
    octave = "/usr/bin/octave-cli"
  )
)
ext <- if (knitr::is_html_output()) ".svg" else if (knitr::is_latex_output()) ".pdf" else ".png"

# knitr::knit_hooks$set(optipng = knitr::hook_optipng, pdfcrop = knitr::hook_pdfcrop)

# https://github.com/yihui/knitr-examples/blob/master/085-pdfcrop.Rnw
# knitr::knit_hooks$set(crop = hook_pdfcrop)
options(
  repos = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/",
  tikzDefaultEngine = "xetex",
  tikzXelatexPackages = c(
    getOption("tikzXelatexPackages"),
    "\\usepackage[colorlinks, breaklinks]{hyperref}",
    "\\usepackage{color}",
    "\\usepackage{tikz}",
    "\\usepackage[active,tightpage,xetex]{preview}",
    "\\PreviewEnvironment{pgfpicture}",
    "\\usepackage{amsmath}",
    "\\usepackage{amsfonts}",
    "\\usepackage{mathrsfs}"
  )
)
# https://github.com/yihui/knitr-examples/blob/master/047-tikz-png.Rnw
# knitr::knit_hooks$set(tikz2png = function(before, options, envir) {
  # use this hook only for dev='tikz' and externalized tikz graphics
  # if (before || options$dev != "tikz" || !options$external || options$fig.num == 0) return()
  # figs <- knitr:::all_figs(options, ext = "pdf") # all figure names
  # note the tikz2png option is the extra parameters passed to 'convert'
  # for (fig in figs) {
    # system(sprintf("convert %s %s %s", options$tikz2png, fig, sub("\\.pdf$", ".png", fig)))
  # }
# })


is_on_travis = identical(Sys.getenv("TRAVIS"), "true")
is_online = curl::has_internet()

library(reticulate)
if(is_on_travis) use_virtualenv("shims") else use_python("/usr/bin/python", required = FALSE)
# Python 环境的描述在附录
# required = FALSE 默认值，如果按照指定的位置没有找到 Python 就会扫描其它版本
# use_python("/opt/pyenv/shims/python")
# use_virtualenv("shims")

# 设置环境变量 RSTUDIO_CONNECT_SERVER 由 travis-ci 设置
connectServer <- Sys.getenv("RSTUDIO_CONNECT_SERVER") # https://bookdown.org
apiKey <- Sys.getenv("RSTUDIO_CONNECT_API_KEY")
```
# 数学运算 {#math-operator}

```{r,include = FALSE}
library(Matrix)
```

统计计算之矩阵运算，自然离不开 **Matrix** 包 [@R-Matrix]

## 矩阵运算

```{r}
A <- matrix(c(1, 2, 2, 3), nrow = 2)
A
```

### 乘法

```{r}
A %*% A
```

### Hadamard 积 {#Hadamard}

矩阵每个元素平方

```{r}
A^2
```

### 交叉积

```{r}
crossprod(A, A)  #  t(x) %*% y
tcrossprod(A, A) #  x %*% t(y)
```

### 外积

```{r}
A %o% A
outer(A, A, FUN = "*")
```

### 直积

直积/克罗内克积

```{r}
A %x% A
kronecker(A, A, FUN = "*")
```

### 乘方

矩阵 A 首先是一个方阵，对称性和正定性未知，n 个 矩阵 A 相乘

统计之都论坛讨论如何求矩阵的乘方 <https://d.cosx.org/d/5619-svd>

```r
"%^%" <- function(mat, pow) {
  if (!is.matrix(mat)) mat <- as.matrix(mat)
  stopifnot(!diff(dim(mat)))
  if (pow < 0) {
    pow <- -pow
    mat <- solve(mat)
  }
  pow <- round(pow)
  switch(pow + 1, return(diag(1, nrow(mat))), return(mat))
  get.exponents <- function(pow)
    if (pow == 0) NULL else c(k <- 2^floor(log2(pow)), get.exponents(pow - k))
  ans <- diag(nrow(mat))
  dlog2exp <- rev(-diff(c(log2(get.exponents(pow)), 0)))
  for (j in 1:length(dlog2exp)) {
    if (dlog2exp[j]) for (i in 1:dlog2exp[j]) mat <- mat %*% mat
    ans <- ans %*% mat
  }
  ans
}
```

奇异值分解

```r
s <- svd(A)
all.equal(s$u%*%diag(s$d)%*%t(s$v),A)
```

特征值及分解 $A = V \Lambda V^{-1}$ 求解矩阵 A 的 n 次方

```{r}
eigen(A)

eigen(A)$vectors %*% diag(eigen(A)$values) %*% solve(eigen(A)$vectors)
eigen(A)$vectors %*% diag(eigen(A)$values)^3 %*% solve(eigen(A)$vectors)
A %*% A %*% A
```

### 幂

```{r}
2^A
exp(A)
```

### 行列式

```{r}
det(A)
```

### 逆

```{r}
solve(A)
```

应用之线性方程组

```{r}
B <- Hilbert(6)
b <- rowSums(B)
# not inv
solve(B,b) 

# inv
solve(B) %*% b
```


Moore-Penrose generalized inverse 广义逆，如果 A 可逆则，广义逆就是逆

```{r}
library(MASS)
ginv(A)
A %*% ginv(A) %*% A
ginv(A) %*% A %*% ginv(A)
t(A %*% ginv(A))
A %*% ginv(A)
t(ginv(A) %*% A)
ginv(A) %*% A
```

`ginv` 函数实现

```r
# The function is currently defined as
function(X, tol = sqrt(.Machine$double.eps))
{
## Generalized Inverse of a Matrix
  dnx <- dimnames(X)
  if(is.null(dnx)) dnx <- vector("list", 2)
  s <- svd(X)
  nz <- s$d > tol * s$d[1]
  structure(
    if(any(nz)) s$v[, nz] %*% (t(s$u[, nz])/s$d[nz]) else X,
    dimnames = dnx[2:1])
}
```

### 伴随矩阵

伴随矩阵 $A*A^{\star} = A^{\star} *A = |A|*I, A^{\star} = |A|*A^{-1}$

- $|A^{\star}| = |A|^{n-1}, A \in \mathbb{R}^{n\times n},n \geq 2$
- $(A^{\star})^{\star} = |A|^{n-2}A, A \in \mathbb{R}^{n\times n},n \geq 2$
- $(A^{\star})^{\star}$ A 的 n 次伴随是？


```{r}
det(A)*solve(A)
```

### 单位矩阵

```{r}
diag(rep(3))
```

全1矩阵，借助外积运算，如3阶矩阵

```{r}
rep(1,3) %o% rep(1,3) 
```


### 对角矩阵

```{r}
diag(A)       # diagonal of a matrix
diag(diag(A)) # construct a diagonal matrix
```

### 条件数

```{r}
base::rcond(A)
kappa(A)
Matrix::rcond(Hilbert(6))
Matrix::rcond(A)
```

### 范数

向量和矩阵的范数，包括1，2，无穷范数，其他操作看 Matrix 包 [@R-Matrix] ，尤其关于稀疏矩阵计算部分

```{r}
norm(A)
```

### 秩

```{r}
qr(A)$rank # or qr.default(A)$rank
```

### 稀疏矩阵

```{r}
library(Matrix)
dn <- list(LETTERS[1:3], letters[1:5])
## pointer vectors can be used, and the (i,x) slots are sorted if necessary:
## 使用指针构造
m <- sparseMatrix(i = c(3,1, 3:2, 2:1), p= c(0:2, 4,4,6), x = 1:6, dimnames = dn)
m
## 典型构造方式
i <- c(1,3:8); j <- c(2,9,6:10); x <- 7 * (1:7)
(A <- sparseMatrix(i, j, x = x))                    ##  8 x 10 "dgCMatrix"
```


## 矩阵分解

### Cholesky 分解

```{r}
# Compute the Choleski factorization of a real symmetric positive-definite square matrix.
chol(A + diag(rep(1,2)))
# Inverse from Choleski (or QR) Decomposition
Matrix::chol2inv(A + diag(rep(1,2)))
```


### 奇异值及分解

```{r}
svd(A)
svd(A)$d
```


### QR分解

```{r}
qr.default(A)
qr.X(qr.default(A))
qr.Q(qr.default(A))
qr.R(qr.default(A))
qr.Q(qr.default(A)) %*% qr.R(qr.default(A))
```



LU 分解、Jordan分解


矩阵下三角

row 和 col

```{r}
row(A)
col(A)
A[row(A)]
```


```{r}
lower.tri(A)
upper.tri(A) # 矩阵上三角
A[lower.tri(A)]
A[lower.tri(A)] <- 0 # 获得上三角矩阵
A
A[row(A) < col(A)] <- 0
A
```

- Householder 变换 <https://www.wikiwand.com/en/Householder_transformation>
- Givens 旋转 <https://www.wikiwand.com/en/Givens_rotation>
- 帽子矩阵在统计中的应用 回归与方差分析 [@David1978Hat]



## 特殊函数

### 阶乘

- 阶乘 $n! = 1\times 2\times 3\cdots n$ 
- 双阶乘 $(2n+1)!! = 1 \times 3\times 5 \times \cdots \times (2n+1), n = 0,1,2,\cdots$

```{r}
factorial(5) # 阶乘
seq(from = 1, to = 5, length.out = 3)
prod(seq(from = 1, to = 5, length.out = 3)) # 连乘 双阶乘

seq(5)
cumprod(seq(5)) # 累积
cumsum(seq(5)) # 累和
```

此外还有 `cummax` 和 `cummin`

- 组合数 $C_{n}^{k} = \frac{n(n-1)…(n-k+1)}{k!}$

$C_{5}^{3} = \frac{5 \times 4 \times 3}{3 \times 2 \times 1}$

```{r}
choose(5,3)
```

> 斯特林公式

### 伽马函数

$\Gamma(x) = \int_{0}^{\infty} t^{x-1}\exp(-t)dt$
$\Gamma(n) = (n-1)!, n \in \mathbb{Z}^{+}$

```{r gamma-ex}
gamma(2)
gamma(10)
gamma2 <- function(t,x){
  t^(x-1)*exp(-t)
}
integrate(gamma2, lower = 0, upper = + Inf, x = 10)
```

- psigamma(x, deriv) 表示 $\psi(x)$ 的 `deriv` 阶导数

$\mathrm{digamma}(x) \triangleq \psi(x) = \frac{d}{dx}{\ln \Gamma(x)} = \Gamma'(x) / \Gamma(x)$

```{r psigamma-ex}
# 例1
x <- 2
eval(deriv(~ gamma(x), "x"))/gamma(x)
# 与此等价
psigamma(2, 0)

digamma(x) # psi(x) 的一阶导数
trigamma(x) # psi(x) 的二阶导数

# 例2
eval(deriv(~ psigamma(x, 1), "x"))
# 与此等价
psigamma(2, 2)

# 注意与下面这个例子比较
dx2x <- deriv(~ x^3, "x")
eval(dx2x)
```

### 贝塔函数

$B(a,b) = \Gamma(a)\Gamma(b)/\Gamma(a+b) = \int_{0}^{1} t^{a-1} (1-t)^{b-1} dt$

```{r beta-ex}
beta(1, 1)
beta(2, 3)
beta2 <- function(t, a, b) {
  t^(a - 1) * (1 - t)^(b - 1)
}
integrate(beta2, lower = 0, upper = 1, a = 2, b = 3)
```

### 贝塞尔函数

```r
besselI(x, nu, expon.scaled = FALSE) # 修正的第一类
besselK(x, nu, expon.scaled = FALSE) # 修正的第二类
besselJ(x, nu) # 第一类
besselY(x, nu) # 第二类
```

- $\nu$ 贝塞尔函数的阶，可以是分数
- expon.scaled 是否使用指数表示

```{r Modified-Bessel}
nus <- c(0:5, 10, 20)
x <- seq(0, 4, length.out = 501)
plot(x, x, ylim = c(0, 6), ylab = "", type = "n",
     main = "Bessel Functions  I_nu(x)")
for(nu in nus) lines(x, besselI(x, nu = nu), col = nu + 2)
legend(0, 6, legend = paste("nu=", nus), col = nus + 2, lwd = 1)
```

## 统计分布 {#distribution}


### 一元分布

三大抽样及其历史

### 多元分布

多元t分布函数

The multivariate $t$ distribution (MVT) is given by

$$T(\mathbf{a},\mathbf{b},\Sigma,\nu)=\frac{2^{1-\frac{\nu}{2}}}{\Gamma(\frac{\nu}{2}) } \int_{0}^{\infty} s^{\nu-1}e^{-\frac{s^2}{2}} \Phi(\frac{s\mathbf{a}}{\sqrt{\nu}},\frac{s\mathbf{b}}{\sqrt{\nu}},\Sigma)ds$$

multivariate normal distribution function (MVN)

$$\Phi(\mathbf{a},\mathbf{b},\Sigma)=\frac{1}{\sqrt{|\Sigma|(2\pi)^m}} \int_{a_1}^{b_1}\!\int_{a_2}^{b_2}\!\cdots\!\int_{a_m}^{b_m} e^{-\frac{1}{2}x^\top\Sigma^{-1}x}dx$$
$x=(x_1,x_2,\dots,x_m)^\top,-\infty \le a_i \le b_i \le \infty$ for all $i$ and $\Sigma$ is a positive semi-definite symmetric $m \times m$ matrix

多元$t$分布分位数计算

```r
library(mvtnorm)
library(matrixcalc)
n <- c(26, 24, 20, 33, 32)
V <- diag(1 / n)
df <- 130
C <- matrix(c(
  1, 1, 1, 0, 0, -1, 0, 0, 1, 0,
  0, -1, 0, 0, 1, 0, 0, 0, -1, -1,
  0, 0, -1, 0, 0
), ncol = 5)
cv <- C %*% V %*% t(C) ## covariance matrix
dv <- t(1 / sqrt(diag(cv)))
cr <- cv * (t(dv) %*% dv) ## correlation matrix
delta <- rep(0, 5)
Tn <- qmvt(0.95,
  df = df, delta = delta, corr = cr,
  abseps = 0.0001, maxpts = 100000, tail = "both"
)
Tn
```

计算多元正态分布的概率

```r
sigma <- read.csv(file = "data/sigma.csv", header = F, sep = ",")
mat <- matrix(0, nrow = nrow(sigma), ncol = ncol(sigma))
sigma <- as.matrix(sigma)
attributes(sigma) <- attributes(mat)
# str(sigma)
# is.symmetric.matrix(sigma)
# is.positive.definite(sigma)
m <- nrow(sigma)
Fn <- pmvnorm(
  lower = rep(-Inf, m), upper = rep(0, m),
  mean = rep(0, m), sigma = sigma
)
Fn
```

mvrnorm 函数来自 MASS 包，模拟多元正态分布的样本

# 文件操作

<https://github.com/r-lib/fs>

```r
# 获取当前目录
getwd()

# 当前目录的子目录
list.dirs()
# 当前目录下的子目录和文件
dir()
# 查看指定目录的子目录和文件
dir(path = "./")

# 只列出以字母R开头的子目录和文件
dir(path = "./",pattern = '^R')
# 列出目录下所有目录和文件，包括隐藏文件
dir(path = "./",all.files = TRUE)

# 查看当前目录的子目录和文件，同dir()函数
list.files()

list.files(".",all.files = TRUE)

# 查看当前目录的权限
file.info(".")

# 查看指定目录权限
file.info("./documents/python")

# 当前目录下，创建一个目录
dir.create("create")

list.dirs()


#
system("tree")
```

<!--chapter:end:02-operators.Rmd-->

```{r include=FALSE, cache=FALSE}
library(methods)
set.seed(2018)
options(digits = 3)

Pkgs <- c(
  "reticulate",
  "showtext", "sysfonts", "showtextdb",
  "fontcm",
  "tikzDevice", "filehash", "png",
  "xkcd", "extrafontdb", "Rttf2pt1", "extrafont"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}

if (!all(c("source-han-sans-cn", "source-han-serif-cn") %in% showtextdb::font_installed())) {
  showtextdb::font_install(showtextdb::source_han_serif("CN"))
  showtextdb::font_install(showtextdb::source_han_sans("CN"))
}
extrafont::font_install("fontcm")
extrafont::loadfonts()

if (!"xkcd" %in% extrafont::fonts()) {
  path <- path.expand("~/.fonts")
  if (!file.exists(path)) {
    dir.create(path = path.expand("~/.fonts"))
  }
  download.file("http://simonsoftware.se/other/xkcd.ttf", dest = path.expand("~/.fonts/xkcd.ttf"), mode = "wb")
  extrafont::font_import(paths = path.expand("~/.fonts"), pattern = "[X/x]kcd", prompt = FALSE)
  extrafont::loadfonts()
}

extrafont::fonts() # registered with pdfFonts()
sysfonts::font_families() # List available font families

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = TRUE,
  cache = TRUE,
  citation.bibtex.max=999,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  # fig.showtext = TRUE, # too danger
  fig.asp = 0.618, # 1 / phi
  # fig.show = "hold", # not for python matplotlib
  fig.ext = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  dev = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  engine.path = list(
    octave = "/usr/bin/octave-cli"
  )
)
ext <- if (knitr::is_html_output()) ".svg" else if (knitr::is_latex_output()) ".pdf" else ".png"

# knitr::knit_hooks$set(optipng = knitr::hook_optipng, pdfcrop = knitr::hook_pdfcrop)

# https://github.com/yihui/knitr-examples/blob/master/085-pdfcrop.Rnw
# knitr::knit_hooks$set(crop = hook_pdfcrop)
options(
  repos = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/",
  tikzDefaultEngine = "xetex",
  tikzXelatexPackages = c(
    getOption("tikzXelatexPackages"),
    "\\usepackage[colorlinks, breaklinks]{hyperref}",
    "\\usepackage{color}",
    "\\usepackage{tikz}",
    "\\usepackage[active,tightpage,xetex]{preview}",
    "\\PreviewEnvironment{pgfpicture}",
    "\\usepackage{amsmath}",
    "\\usepackage{amsfonts}",
    "\\usepackage{mathrsfs}"
  )
)
# https://github.com/yihui/knitr-examples/blob/master/047-tikz-png.Rnw
# knitr::knit_hooks$set(tikz2png = function(before, options, envir) {
  # use this hook only for dev='tikz' and externalized tikz graphics
  # if (before || options$dev != "tikz" || !options$external || options$fig.num == 0) return()
  # figs <- knitr:::all_figs(options, ext = "pdf") # all figure names
  # note the tikz2png option is the extra parameters passed to 'convert'
  # for (fig in figs) {
    # system(sprintf("convert %s %s %s", options$tikz2png, fig, sub("\\.pdf$", ".png", fig)))
  # }
# })


is_on_travis = identical(Sys.getenv("TRAVIS"), "true")
is_online = curl::has_internet()

library(reticulate)
if(is_on_travis) use_virtualenv("shims") else use_python("/usr/bin/python", required = FALSE)
# Python 环境的描述在附录
# required = FALSE 默认值，如果按照指定的位置没有找到 Python 就会扫描其它版本
# use_python("/opt/pyenv/shims/python")
# use_virtualenv("shims")

# 设置环境变量 RSTUDIO_CONNECT_SERVER 由 travis-ci 设置
connectServer <- Sys.getenv("RSTUDIO_CONNECT_SERVER") # https://bookdown.org
apiKey <- Sys.getenv("RSTUDIO_CONNECT_API_KEY")
```
# 数据操作

## 集合运算


## 正则匹配

字符串处理 [Handling Strings with R](http://www.gastonsanchez.com/r4strings/) Gaston Sanchez 著

正则表达式 is ervrywhere，is 高级/hacker's skill 技能

- [正则表达式速查表 -- Python3](https://www.dataquest.io/blog/large_files/python-regular-expressions-cheat-sheet.pdf)
- [Online regex tester and debugger](https://regex101.com/)
- [Regular expression operations](https://docs.python.org/3/library/re.html)

以 CRAN 日志数据为例

- R 包开发者

```{r}
library(magrittr)
gsub(
  " <([^<>]*)>", "",
  lapply(.packages(TRUE), maintainer)
  %>%
    unlist()
) %>% 
  unique() %>% 
  sort() %>% 
  tail(10)
```

```r
# 网上有多少 R 包
pkg_repos <- c("https://mirrors.tuna.tsinghua.edu.cn/CRAN/","https://inla.r-inla-download.org/R/stable","http://r-forge.r-project.org/")

pkg <- utils::available.packages(repos = pkg_repos)

pkg <- as.data.frame(pkg, stringsAsFactors = FALSE)

pkg$Package
download.packages("Rbooks", destdir = "~/",repos = "http://r-forge.r-project.org/")
```


Github 活动记录 <https://github.com/jonocarroll/butteRfly>

```r
# install.packages("devtools")
devtools::install_github("jonocarroll/butteRfly")
my_socials <- collate_socials(user = c("jonocarroll", "carroll_jono", 4168169), 
                              socials = c("GitHub", "Twitter", "StackOverflow"))
```

## 排序

### order 

### sort


## 索引

### which

向量和矩阵中的操作

### `[[`


```r
# which [] 索引性能比较

n = 100000
x = runif(n)
i = logical(n)
i[sample(n, n/4)] = TRUE
microbenchmark::microbenchmark(x[i], x[which(i)], times = 1000)
```

## 分组

by


with 和 within


## apply 

### lapply

### sapply
 
### parallel


 
## 合并 

### aggregate

## 映射 

### Map  

### Reduce

openxlsx 
拆分、映射计算，合并

```r
## Load dependencies
if (!require('openxlsx')) install.packages('openxlsx')
library('openxlsx')
 
## Split data apart by a grouping variable;
##   makes a named list of tables
dat <- split(mtcars, mtcars$cyl)
dat
 
 
## Create a blank workbook
wb <- createWorkbook()
 
## Loop through the list of split tables as well as their names
##   and add each one as a sheet to the workbook
Map(function(data, name){
 
    addWorksheet(wb, name)
    writeData(wb, name, data)
 
}, dat, names(dat))
 
 
## Save workbook to working directory
saveWorkbook(wb, file = "example.xlsx", overwrite = TRUE)
```


## 拆分

### split 

### cut

```
Z <- stats::rnorm(10000)
table(cut(Z, breaks = -6:6))
# 条形图
plot(cut(Z, breaks = -6:6))
# 落在区间 [-6，6] 内的点
sum(table(cut(Z, breaks = -6:6, labels = FALSE)))
# 直方图
hist(Z, breaks = -6:6)

aaa <- c(1,2,3,4,5,2,3,4,5,6,7)
cut(aaa, 3)
cut(aaa, 3, dig.lab = 4, ordered = TRUE)
## one way to extract the breakpoints
labs <- levels(cut(aaa, 3))
cbind(lower = as.numeric( sub("\\((.+),.*", "\\1", labs) ),
      upper = as.numeric( sub("[^,]*,([^]]*)\\]", "\\1", labs) ))

```

- findInterval
- embed

## 数据库

RMariaDB: Implements a 'DBI'-compliant interface to 'MariaDB' (<https://mariadb.org/>) and 'MySQL' (<https://www.mysql.com/>) databases. <https://github.com/r-dbi/RMariaDB>

- rio <https://github.com/leeper/rio>


```r
# 读取一系列同一格式的数据文件
read_list <- function(list_of_datasets, read_func){

        read_and_assign <- function(dataset, read_func){
                dataset_name <- as.name(dataset)
                dataset_name <- read_func(dataset)
        }

        # invisible is used to suppress the unneeded output
        output <- invisible(
                sapply(list_of_datasets,
                           read_and_assign, read_func = read_func, simplify = FALSE, USE.NAMES = TRUE))

        # Remove the extension at the end of the data set names
        names_of_datasets <- c(unlist(strsplit(list_of_datasets, "[.]"))[c(T, F)])
        names(output) <- names_of_datasets
        return(output)
}

data_files <- list.files(pattern = ".csv")  # 提取文件名.csv格式文件

print(data_files)

library("readr")
library("tibble")

list_of_data_sets <- read_list(data_files, read_csv)


glimpse(list_of_data_sets)
```

<!--chapter:end:03-manipulations.Rmd-->

```{r include=FALSE, cache=FALSE}
library(methods)
set.seed(2018)
options(digits = 3)

Pkgs <- c(
  "reticulate",
  "showtext", "sysfonts", "showtextdb",
  "fontcm",
  "tikzDevice", "filehash", "png",
  "xkcd", "extrafontdb", "Rttf2pt1", "extrafont"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}

if (!all(c("source-han-sans-cn", "source-han-serif-cn") %in% showtextdb::font_installed())) {
  showtextdb::font_install(showtextdb::source_han_serif("CN"))
  showtextdb::font_install(showtextdb::source_han_sans("CN"))
}
extrafont::font_install("fontcm")
extrafont::loadfonts()

if (!"xkcd" %in% extrafont::fonts()) {
  path <- path.expand("~/.fonts")
  if (!file.exists(path)) {
    dir.create(path = path.expand("~/.fonts"))
  }
  download.file("http://simonsoftware.se/other/xkcd.ttf", dest = path.expand("~/.fonts/xkcd.ttf"), mode = "wb")
  extrafont::font_import(paths = path.expand("~/.fonts"), pattern = "[X/x]kcd", prompt = FALSE)
  extrafont::loadfonts()
}

extrafont::fonts() # registered with pdfFonts()
sysfonts::font_families() # List available font families

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = TRUE,
  cache = TRUE,
  citation.bibtex.max=999,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  # fig.showtext = TRUE, # too danger
  fig.asp = 0.618, # 1 / phi
  # fig.show = "hold", # not for python matplotlib
  fig.ext = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  dev = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  engine.path = list(
    octave = "/usr/bin/octave-cli"
  )
)
ext <- if (knitr::is_html_output()) ".svg" else if (knitr::is_latex_output()) ".pdf" else ".png"

# knitr::knit_hooks$set(optipng = knitr::hook_optipng, pdfcrop = knitr::hook_pdfcrop)

# https://github.com/yihui/knitr-examples/blob/master/085-pdfcrop.Rnw
# knitr::knit_hooks$set(crop = hook_pdfcrop)
options(
  repos = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/",
  tikzDefaultEngine = "xetex",
  tikzXelatexPackages = c(
    getOption("tikzXelatexPackages"),
    "\\usepackage[colorlinks, breaklinks]{hyperref}",
    "\\usepackage{color}",
    "\\usepackage{tikz}",
    "\\usepackage[active,tightpage,xetex]{preview}",
    "\\PreviewEnvironment{pgfpicture}",
    "\\usepackage{amsmath}",
    "\\usepackage{amsfonts}",
    "\\usepackage{mathrsfs}"
  )
)
# https://github.com/yihui/knitr-examples/blob/master/047-tikz-png.Rnw
# knitr::knit_hooks$set(tikz2png = function(before, options, envir) {
  # use this hook only for dev='tikz' and externalized tikz graphics
  # if (before || options$dev != "tikz" || !options$external || options$fig.num == 0) return()
  # figs <- knitr:::all_figs(options, ext = "pdf") # all figure names
  # note the tikz2png option is the extra parameters passed to 'convert'
  # for (fig in figs) {
    # system(sprintf("convert %s %s %s", options$tikz2png, fig, sub("\\.pdf$", ".png", fig)))
  # }
# })


is_on_travis = identical(Sys.getenv("TRAVIS"), "true")
is_online = curl::has_internet()

library(reticulate)
if(is_on_travis) use_virtualenv("shims") else use_python("/usr/bin/python", required = FALSE)
# Python 环境的描述在附录
# required = FALSE 默认值，如果按照指定的位置没有找到 Python 就会扫描其它版本
# use_python("/opt/pyenv/shims/python")
# use_virtualenv("shims")

# 设置环境变量 RSTUDIO_CONNECT_SERVER 由 travis-ci 设置
connectServer <- Sys.getenv("RSTUDIO_CONNECT_SERVER") # https://bookdown.org
apiKey <- Sys.getenv("RSTUDIO_CONNECT_API_KEY")
```
# (PART) 统计图形 {-}

<!--chapter:end:Graphics.Rmd-->

```{r include=FALSE, cache=FALSE}
library(methods)
set.seed(2018)
options(digits = 3)

Pkgs <- c(
  "reticulate",
  "showtext", "sysfonts", "showtextdb",
  "fontcm",
  "tikzDevice", "filehash", "png",
  "xkcd", "extrafontdb", "Rttf2pt1", "extrafont"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}

if (!all(c("source-han-sans-cn", "source-han-serif-cn") %in% showtextdb::font_installed())) {
  showtextdb::font_install(showtextdb::source_han_serif("CN"))
  showtextdb::font_install(showtextdb::source_han_sans("CN"))
}
extrafont::font_install("fontcm")
extrafont::loadfonts()

if (!"xkcd" %in% extrafont::fonts()) {
  path <- path.expand("~/.fonts")
  if (!file.exists(path)) {
    dir.create(path = path.expand("~/.fonts"))
  }
  download.file("http://simonsoftware.se/other/xkcd.ttf", dest = path.expand("~/.fonts/xkcd.ttf"), mode = "wb")
  extrafont::font_import(paths = path.expand("~/.fonts"), pattern = "[X/x]kcd", prompt = FALSE)
  extrafont::loadfonts()
}

extrafont::fonts() # registered with pdfFonts()
sysfonts::font_families() # List available font families

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = TRUE,
  cache = TRUE,
  citation.bibtex.max=999,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  # fig.showtext = TRUE, # too danger
  fig.asp = 0.618, # 1 / phi
  # fig.show = "hold", # not for python matplotlib
  fig.ext = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  dev = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  engine.path = list(
    octave = "/usr/bin/octave-cli"
  )
)
ext <- if (knitr::is_html_output()) ".svg" else if (knitr::is_latex_output()) ".pdf" else ".png"

# knitr::knit_hooks$set(optipng = knitr::hook_optipng, pdfcrop = knitr::hook_pdfcrop)

# https://github.com/yihui/knitr-examples/blob/master/085-pdfcrop.Rnw
# knitr::knit_hooks$set(crop = hook_pdfcrop)
options(
  repos = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/",
  tikzDefaultEngine = "xetex",
  tikzXelatexPackages = c(
    getOption("tikzXelatexPackages"),
    "\\usepackage[colorlinks, breaklinks]{hyperref}",
    "\\usepackage{color}",
    "\\usepackage{tikz}",
    "\\usepackage[active,tightpage,xetex]{preview}",
    "\\PreviewEnvironment{pgfpicture}",
    "\\usepackage{amsmath}",
    "\\usepackage{amsfonts}",
    "\\usepackage{mathrsfs}"
  )
)
# https://github.com/yihui/knitr-examples/blob/master/047-tikz-png.Rnw
# knitr::knit_hooks$set(tikz2png = function(before, options, envir) {
  # use this hook only for dev='tikz' and externalized tikz graphics
  # if (before || options$dev != "tikz" || !options$external || options$fig.num == 0) return()
  # figs <- knitr:::all_figs(options, ext = "pdf") # all figure names
  # note the tikz2png option is the extra parameters passed to 'convert'
  # for (fig in figs) {
    # system(sprintf("convert %s %s %s", options$tikz2png, fig, sub("\\.pdf$", ".png", fig)))
  # }
# })


is_on_travis = identical(Sys.getenv("TRAVIS"), "true")
is_online = curl::has_internet()

library(reticulate)
if(is_on_travis) use_virtualenv("shims") else use_python("/usr/bin/python", required = FALSE)
# Python 环境的描述在附录
# required = FALSE 默认值，如果按照指定的位置没有找到 Python 就会扫描其它版本
# use_python("/opt/pyenv/shims/python")
# use_virtualenv("shims")

# 设置环境变量 RSTUDIO_CONNECT_SERVER 由 travis-ci 设置
connectServer <- Sys.getenv("RSTUDIO_CONNECT_SERVER") # https://bookdown.org
apiKey <- Sys.getenv("RSTUDIO_CONNECT_API_KEY")
```
# 基础图形 {#graphics}

```{r include = FALSE}
Pkgs <- c(
  "ISLR", "raster", "sp"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}

if (!"spDataLarge" %in% .packages(TRUE)) {
  install.packages("spDataLarge",
    repos = "https://nowosad.github.io/drat/",
    type = "source"
  )
}
```

## plot {#base}

```{r run-length-hist, fig.cap='游程直方图', fig.showtext=TRUE}
set.seed(2018) 
n <- 2^16
x <- runif(n,0,1)
delta <- 0.01
len <- diff(c(0,which(x < delta),n+1))-1
ylim <- seq( 0, 1800, by = 300)
xlim <- seq( 0, 100, by = 20)
p <- hist(len[len < 101], breaks = -1:100+0.5, plot = FALSE)
par(mar = c(2,2,.5,.5))
plot(p, xlab = '间距', ylab = '频数', axes = FALSE, 
     col = "lightblue", border = "white", main = "")	 
axis( 1, labels = xlim, at = xlim, las = 1) # x 轴
axis( 2, labels = ylim, at = ylim, las = 0) # y 轴
box(col="gray")
# 添加线性回归线
xx <- seq.int(from = 0, to = 100, by = 1)
xy <- p$counts
options(digits = 2)
fit <- lm(xy~xx)
abline(fit, col = 'red')
b = coef(fit)
# mtext(paste0( "Y = ", paste0(paste0(b[1], b[2]),"x") ), side = 3, cex = 2)
```

还你一个清爽的世界，统计之都文章 [漫谈条形图](https://cosx.org/2017/10/discussion-about-bar-graph/)

```{r beautiful-barplot,fig.cap="条形图"}
data(NCI60, package = "ISLR") # 加载数据
myData <- sort(table(NCI60$labs), decreasing = TRUE)
par(mar = c(2, 7, 1, 1))
barCenters <- barplot(myData,
  col = "lightblue", axes = FALSE,
  axisnames = FALSE, horiz = TRUE, border = "white"
)
text(
  y = barCenters, x = par("usr")[3],
  adj = 1, labels = names(myData), xpd = TRUE
)
axis(1, labels = seq(0, 9, by = 1), at = seq(0, 9, by = 1), las = 1, col = "gray")
```

plot 作为一个泛型函数，对于不同的输入数据类型，会自动匹配不同的绘图函数，默认的有

```{r}
methods(plot)
```


```{r nice-plot, fig.cap='丰富的方法', fig.width=8,fig.height=9,out.width="80%"}
op <- par(mfrow = c(3, 2), mar = c(2, 2, .5, .5))
# 分类散点图
plot(Sepal.Length ~ Sepal.Width, data = iris, col = Species, pch = 16)
legend("topright",
  legend = unique(iris$Species), box.col = "gray",
  pch = 16, col = unique(iris$Species)
)
box(col = "gray")
# 气泡图
plot(Volume ~ Height,
  data = trees, pch = 16, cex = Girth / 8,
  col = rev(terrain.colors(nrow(trees), alpha = .5))
)
box(col = "gray")
# 折线图
plot(AirPassengers, col = "lightblue")
box(col = "gray")

# 柱形图
set.seed(123456)
barPois <- table(stats::rpois(1000, lambda = 5))
plot(barPois, col = "lightblue", type = "h", lwd = 10, main = "")
box(col = "gray")

# 马赛克图
# par(mar=c(2,2,.5,.5))
plot(HairEyeColor, col = "lightblue", border = "white", main = "")
# box(col="gray")
# 矩阵图 自带 layout
plot(iris[, -5], col = iris$Species, pch = 16)
par(op)
```

raster 图形

```{r, fig.cap="raster 图形"}
library(raster)
library(sp)
library(spDataLarge)
plot(elevation, asp = NA)
```

注意与 image 函数区别

```{r, fig.cap="image 图形"}
# A prettier display of the volcano
x <- 10*(1:nrow(volcano))
y <- 10*(1:ncol(volcano))
image(x, y, volcano, col = terrain.colors(100), axes = FALSE)
contour(x, y, volcano, levels = seq(90, 200, by = 5),
        add = TRUE, col = "peru")
axis(1, at = seq(100, 800, by = 100))
axis(2, at = seq(100, 600, by = 100))
box()
title(main = "Maunga Whau Volcano", font.main = 4)
```

残差图

```
# iris$Species 分三类

vec_mean <- apply(iris[,-5],2,mean)
vec_sd <- apply(iris[,-5],2,sd)

plot( seq(4) , vec_mean,
    ylim = range(c(vec_mean-vec_sd, vec_mean + vec_sd)),
    pch=19, xlab="Species", ylab="Mean +/- SD",
    main="Scatter plot with std.dev error bars"
)

arrows(seq(4), vec_mean-vec_sd, seq(4),  vec_mean + vec_sd, length=0.05, angle=90, code=3)
# seq( nlevels(iris$Species) )
```

<!--chapter:end:04-plot.Rmd-->

```{r include=FALSE, cache=FALSE}
library(methods)
set.seed(2018)
options(digits = 3)

Pkgs <- c(
  "reticulate",
  "showtext", "sysfonts", "showtextdb",
  "fontcm",
  "tikzDevice", "filehash", "png",
  "xkcd", "extrafontdb", "Rttf2pt1", "extrafont"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}

if (!all(c("source-han-sans-cn", "source-han-serif-cn") %in% showtextdb::font_installed())) {
  showtextdb::font_install(showtextdb::source_han_serif("CN"))
  showtextdb::font_install(showtextdb::source_han_sans("CN"))
}
extrafont::font_install("fontcm")
extrafont::loadfonts()

if (!"xkcd" %in% extrafont::fonts()) {
  path <- path.expand("~/.fonts")
  if (!file.exists(path)) {
    dir.create(path = path.expand("~/.fonts"))
  }
  download.file("http://simonsoftware.se/other/xkcd.ttf", dest = path.expand("~/.fonts/xkcd.ttf"), mode = "wb")
  extrafont::font_import(paths = path.expand("~/.fonts"), pattern = "[X/x]kcd", prompt = FALSE)
  extrafont::loadfonts()
}

extrafont::fonts() # registered with pdfFonts()
sysfonts::font_families() # List available font families

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = TRUE,
  cache = TRUE,
  citation.bibtex.max=999,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  # fig.showtext = TRUE, # too danger
  fig.asp = 0.618, # 1 / phi
  # fig.show = "hold", # not for python matplotlib
  fig.ext = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  dev = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  engine.path = list(
    octave = "/usr/bin/octave-cli"
  )
)
ext <- if (knitr::is_html_output()) ".svg" else if (knitr::is_latex_output()) ".pdf" else ".png"

# knitr::knit_hooks$set(optipng = knitr::hook_optipng, pdfcrop = knitr::hook_pdfcrop)

# https://github.com/yihui/knitr-examples/blob/master/085-pdfcrop.Rnw
# knitr::knit_hooks$set(crop = hook_pdfcrop)
options(
  repos = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/",
  tikzDefaultEngine = "xetex",
  tikzXelatexPackages = c(
    getOption("tikzXelatexPackages"),
    "\\usepackage[colorlinks, breaklinks]{hyperref}",
    "\\usepackage{color}",
    "\\usepackage{tikz}",
    "\\usepackage[active,tightpage,xetex]{preview}",
    "\\PreviewEnvironment{pgfpicture}",
    "\\usepackage{amsmath}",
    "\\usepackage{amsfonts}",
    "\\usepackage{mathrsfs}"
  )
)
# https://github.com/yihui/knitr-examples/blob/master/047-tikz-png.Rnw
# knitr::knit_hooks$set(tikz2png = function(before, options, envir) {
  # use this hook only for dev='tikz' and externalized tikz graphics
  # if (before || options$dev != "tikz" || !options$external || options$fig.num == 0) return()
  # figs <- knitr:::all_figs(options, ext = "pdf") # all figure names
  # note the tikz2png option is the extra parameters passed to 'convert'
  # for (fig in figs) {
    # system(sprintf("convert %s %s %s", options$tikz2png, fig, sub("\\.pdf$", ".png", fig)))
  # }
# })


is_on_travis = identical(Sys.getenv("TRAVIS"), "true")
is_online = curl::has_internet()

library(reticulate)
if(is_on_travis) use_virtualenv("shims") else use_python("/usr/bin/python", required = FALSE)
# Python 环境的描述在附录
# required = FALSE 默认值，如果按照指定的位置没有找到 Python 就会扫描其它版本
# use_python("/opt/pyenv/shims/python")
# use_virtualenv("shims")

# 设置环境变量 RSTUDIO_CONNECT_SERVER 由 travis-ci 设置
connectServer <- Sys.getenv("RSTUDIO_CONNECT_SERVER") # https://bookdown.org
apiKey <- Sys.getenv("RSTUDIO_CONNECT_API_KEY")
```
# 高级图形 {#ggplot}

```{r,include=FALSE}
Pkgs <- c(
  "cranlogs", "ggthemes",
  "tidyverse","ggrepel"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}
```

- Claus O. Wilke 新书：数据可视化基础 [Fundamentals of Data Visualization](http://serialmentor.com/dataviz/) 全 R/ggplot2 实现


ggplot2 有很多绘图函数

```{r}
library(ggplot2)
# packageDescription("ggplot2")
grep('^(geom_)', ls('package:ggplot2'), value = TRUE)
grep('^(stat_)', ls('package:ggplot2'), value = TRUE)
```

rattle 下载量时序图

```{r log, fig.showtext = TRUE}
library(cranlogs)
library(ggthemes)
pkgs_down <- cran_downloads(package = "rattle", from = Sys.Date() - 365 * 5, to = Sys.Date())
ggplot(pkgs_down, aes(x = date, y = count, colour = package)) +
  geom_line() +
  geom_point(size = 1.5) +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  ylim(c(0, 1500)) +
  scale_colour_brewer(palette = "Set1") +
  # scale_color_fivethirtyeight("") +
  # theme_fivethirtyeight() +
  labs(
    subtitle = paste("最近更新日期:", Sys.Date()),
    title = "Rattle 最近5年每日下载量",
    caption = " 数据源: http://cran-logs.rstudio.com/ "
  ) +
  theme_minimal(base_size = 10.54, base_family = "source-han-serif-cn")
```

给线条添加注释和标签，这个功能有时候比图例更加漂亮

```{r add-label-ggrepel, fig.cap="添加标签"}
# 出自 https://gist.github.com/EmilHvitfeldt/acb849a6135a21426c260850cf0f461b
# Horizontal annotations with ggrepel and ggplot2
library(tidyverse)
library(ggrepel)
data <- tibble(
  x = seq_len(100),
  y = cumsum(rnorm(100))
)

anno_data <- data %>%
  filter(x %% 25 == 10) %>%
  mutate(text = "text")

data %>%
  ggplot(aes(x, y)) +
  geom_line() +
  geom_label_repel(aes(label = text),
    data = anno_data,
    direction = "y",
    nudge_y = c(-5, 5, 5, 5)
  ) +
  theme_minimal()
```


本节软件信息

```{r}
devtools::session_info("ggplot2")
```


<!--chapter:end:05-grid.Rmd-->

```{r include=FALSE, cache=FALSE}
library(methods)
set.seed(2018)
options(digits = 3)

Pkgs <- c(
  "reticulate",
  "showtext", "sysfonts", "showtextdb",
  "fontcm",
  "tikzDevice", "filehash", "png",
  "xkcd", "extrafontdb", "Rttf2pt1", "extrafont"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}

if (!all(c("source-han-sans-cn", "source-han-serif-cn") %in% showtextdb::font_installed())) {
  showtextdb::font_install(showtextdb::source_han_serif("CN"))
  showtextdb::font_install(showtextdb::source_han_sans("CN"))
}
extrafont::font_install("fontcm")
extrafont::loadfonts()

if (!"xkcd" %in% extrafont::fonts()) {
  path <- path.expand("~/.fonts")
  if (!file.exists(path)) {
    dir.create(path = path.expand("~/.fonts"))
  }
  download.file("http://simonsoftware.se/other/xkcd.ttf", dest = path.expand("~/.fonts/xkcd.ttf"), mode = "wb")
  extrafont::font_import(paths = path.expand("~/.fonts"), pattern = "[X/x]kcd", prompt = FALSE)
  extrafont::loadfonts()
}

extrafont::fonts() # registered with pdfFonts()
sysfonts::font_families() # List available font families

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = TRUE,
  cache = TRUE,
  citation.bibtex.max=999,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  # fig.showtext = TRUE, # too danger
  fig.asp = 0.618, # 1 / phi
  # fig.show = "hold", # not for python matplotlib
  fig.ext = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  dev = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  engine.path = list(
    octave = "/usr/bin/octave-cli"
  )
)
ext <- if (knitr::is_html_output()) ".svg" else if (knitr::is_latex_output()) ".pdf" else ".png"

# knitr::knit_hooks$set(optipng = knitr::hook_optipng, pdfcrop = knitr::hook_pdfcrop)

# https://github.com/yihui/knitr-examples/blob/master/085-pdfcrop.Rnw
# knitr::knit_hooks$set(crop = hook_pdfcrop)
options(
  repos = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/",
  tikzDefaultEngine = "xetex",
  tikzXelatexPackages = c(
    getOption("tikzXelatexPackages"),
    "\\usepackage[colorlinks, breaklinks]{hyperref}",
    "\\usepackage{color}",
    "\\usepackage{tikz}",
    "\\usepackage[active,tightpage,xetex]{preview}",
    "\\PreviewEnvironment{pgfpicture}",
    "\\usepackage{amsmath}",
    "\\usepackage{amsfonts}",
    "\\usepackage{mathrsfs}"
  )
)
# https://github.com/yihui/knitr-examples/blob/master/047-tikz-png.Rnw
# knitr::knit_hooks$set(tikz2png = function(before, options, envir) {
  # use this hook only for dev='tikz' and externalized tikz graphics
  # if (before || options$dev != "tikz" || !options$external || options$fig.num == 0) return()
  # figs <- knitr:::all_figs(options, ext = "pdf") # all figure names
  # note the tikz2png option is the extra parameters passed to 'convert'
  # for (fig in figs) {
    # system(sprintf("convert %s %s %s", options$tikz2png, fig, sub("\\.pdf$", ".png", fig)))
  # }
# })


is_on_travis = identical(Sys.getenv("TRAVIS"), "true")
is_online = curl::has_internet()

library(reticulate)
if(is_on_travis) use_virtualenv("shims") else use_python("/usr/bin/python", required = FALSE)
# Python 环境的描述在附录
# required = FALSE 默认值，如果按照指定的位置没有找到 Python 就会扫描其它版本
# use_python("/opt/pyenv/shims/python")
# use_virtualenv("shims")

# 设置环境变量 RSTUDIO_CONNECT_SERVER 由 travis-ci 设置
connectServer <- Sys.getenv("RSTUDIO_CONNECT_SERVER") # https://bookdown.org
apiKey <- Sys.getenv("RSTUDIO_CONNECT_API_KEY")
```
# 动态图形 {#js}

```{r, include=FALSE}
Pkgs <- c(
  "leaflet","rbokeh","plotly","highcharter"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}
```


基于 JS 动态库的 R 包 leaflet [@R-leaflet]，ggvis ， rbokeh [@R-rbokeh] 和 plotly [@R-plotly] ，我比较喜欢 highcharter [@R-highcharter]，美观高效，还活跃开发中。

```{r highcharter, fig.cap="highcharter 图形",eval=FALSE}
library("highcharter")
data(diamonds, mpg, package = "ggplot2")
hchart(mpg, "scatter", hcaes(x = displ, y = hwy, group = class))
```


```{r rbokeh,fig.cap="rbokeh 图形",eval=FALSE}
library(rbokeh)
figure(width = 600, height = 400) %>%
  ly_hist(eruptions, data = faithful, breaks = 40, freq = FALSE) %>%
  ly_density(eruptions, data = faithful)
```


```{r plotly, fig.cap="plotly 图形",eval=FALSE}
library(plotly)
plot_ly(z = ~volcano, type = "surface")
```

## ECharts

基于 ECharts 4 开发的 R 包 [@R-echarts4r] 和 [@R-recharts]


```r
# install.packages("devtools")
devtools::install_github("JohnCoene/echarts4r")
devtools::install_github('cosname/recharts')
```

## D3

R Interface to D3 Visualizations [@R-r2d3]

```r
devtools::install_github("rstudio/r2d3")
```




<!--chapter:end:06-interactions.Rmd-->

```{r include=FALSE, cache=FALSE}
library(methods)
set.seed(2018)
options(digits = 3)

Pkgs <- c(
  "reticulate",
  "showtext", "sysfonts", "showtextdb",
  "fontcm",
  "tikzDevice", "filehash", "png",
  "xkcd", "extrafontdb", "Rttf2pt1", "extrafont"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}

if (!all(c("source-han-sans-cn", "source-han-serif-cn") %in% showtextdb::font_installed())) {
  showtextdb::font_install(showtextdb::source_han_serif("CN"))
  showtextdb::font_install(showtextdb::source_han_sans("CN"))
}
extrafont::font_install("fontcm")
extrafont::loadfonts()

if (!"xkcd" %in% extrafont::fonts()) {
  path <- path.expand("~/.fonts")
  if (!file.exists(path)) {
    dir.create(path = path.expand("~/.fonts"))
  }
  download.file("http://simonsoftware.se/other/xkcd.ttf", dest = path.expand("~/.fonts/xkcd.ttf"), mode = "wb")
  extrafont::font_import(paths = path.expand("~/.fonts"), pattern = "[X/x]kcd", prompt = FALSE)
  extrafont::loadfonts()
}

extrafont::fonts() # registered with pdfFonts()
sysfonts::font_families() # List available font families

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = TRUE,
  cache = TRUE,
  citation.bibtex.max=999,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  # fig.showtext = TRUE, # too danger
  fig.asp = 0.618, # 1 / phi
  # fig.show = "hold", # not for python matplotlib
  fig.ext = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  dev = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  engine.path = list(
    octave = "/usr/bin/octave-cli"
  )
)
ext <- if (knitr::is_html_output()) ".svg" else if (knitr::is_latex_output()) ".pdf" else ".png"

# knitr::knit_hooks$set(optipng = knitr::hook_optipng, pdfcrop = knitr::hook_pdfcrop)

# https://github.com/yihui/knitr-examples/blob/master/085-pdfcrop.Rnw
# knitr::knit_hooks$set(crop = hook_pdfcrop)
options(
  repos = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/",
  tikzDefaultEngine = "xetex",
  tikzXelatexPackages = c(
    getOption("tikzXelatexPackages"),
    "\\usepackage[colorlinks, breaklinks]{hyperref}",
    "\\usepackage{color}",
    "\\usepackage{tikz}",
    "\\usepackage[active,tightpage,xetex]{preview}",
    "\\PreviewEnvironment{pgfpicture}",
    "\\usepackage{amsmath}",
    "\\usepackage{amsfonts}",
    "\\usepackage{mathrsfs}"
  )
)
# https://github.com/yihui/knitr-examples/blob/master/047-tikz-png.Rnw
# knitr::knit_hooks$set(tikz2png = function(before, options, envir) {
  # use this hook only for dev='tikz' and externalized tikz graphics
  # if (before || options$dev != "tikz" || !options$external || options$fig.num == 0) return()
  # figs <- knitr:::all_figs(options, ext = "pdf") # all figure names
  # note the tikz2png option is the extra parameters passed to 'convert'
  # for (fig in figs) {
    # system(sprintf("convert %s %s %s", options$tikz2png, fig, sub("\\.pdf$", ".png", fig)))
  # }
# })


is_on_travis = identical(Sys.getenv("TRAVIS"), "true")
is_online = curl::has_internet()

library(reticulate)
if(is_on_travis) use_virtualenv("shims") else use_python("/usr/bin/python", required = FALSE)
# Python 环境的描述在附录
# required = FALSE 默认值，如果按照指定的位置没有找到 Python 就会扫描其它版本
# use_python("/opt/pyenv/shims/python")
# use_virtualenv("shims")

# 设置环境变量 RSTUDIO_CONNECT_SERVER 由 travis-ci 设置
connectServer <- Sys.getenv("RSTUDIO_CONNECT_SERVER") # https://bookdown.org
apiKey <- Sys.getenv("RSTUDIO_CONNECT_API_KEY")
```
# 绘图工具

```{r,include=FALSE}
Pkgs <- c(
  "webp", "rsvg", "pdftools", "magick"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}
```


图片导入，导出，转化，批量转化

导入 SVG 格式的图片, rsvg [@R-rsvg] 批量转化 svg 文件为 pdf 文件

```r
library(rsvg)
tmp <- "figure/Ink" # svgs 存放目录
input_paths <- paste0(tmp, "/", list.files(tmp))
output_paths <- paste0("figure/pdf", "/", gsub("svg", "pdf", list.files(tmp)))

for (i in seq(length(list.files(tmp)))) {
  rsvg_pdf(input_paths[i], file = output_paths[i])
}
```

- pdftools [@R-pdftools] 用于文本提取，渲染和转化 PDF 文档

- magick 的简单使用，如插入 Inkscape 图标，如图\@ref(fig:inkscape-logo)

```{r inkscape-logo,fig.cap="Inkscape 图标", echo = FALSE, out.width="25%"}
# magick::image_read_svg(path = "diagrams/inkscape.svg")
knitr::include_graphics(path = paste0("diagrams/inkscape", ext))
```

[magick](https://github.com/ropensci/magick) Bindings to ImageMagick: the most comprehensive open-source image processing library available. Supports many common formats (png, jpeg, tiff, pdf, etc) and manipulations (rotate, scale, crop, trim, flip, blur, etc). All operations are vectorized via the Magick++ STL meaning they operate either on a single frame or a series of frames for working with layers, collages, or animation. In RStudio images are automatically previewed when printed to the console, resulting in an interactive editing environment. The latest version of the package includes a native graphics device for creating in-memory graphics or drawing onto images using pixel coordinates.



## 截图

- webshot <https://github.com/wch/webshot>

```r
# 截图
install.packages("webshot")
webshot::install_phantomjs()
# 截网页
library(webshot)
webshot("https://www.r-project.org/", "r.png")
webshot("https://www.r-project.org/", "r.pdf") # Can also output to PDF
# 截文档
rmdshot("document.rmd", "document.png")
# 截特定大小 GraphicsMagick (recommended) or ImageMagick installed
# Can specify pixel dimensions for resize()
webshot("https://www.r-project.org/", "r-small.png") %>%
  resize("400x") %>%
  shrink()
```


## Inkscape

Inkscape is an open source drawing tool with capabilities similar to Illustrator, Freehand, and CorelDraw that uses the W3C standard scalable vector graphics  format (SVG). Some supported SVG features include basic shapes, paths, text, markers, clones, alpha blending, transforms, gradients, and grouping. In addition, Inkscape supports Creative Commons meta-data, node-editing, layers, complex path operations, text-on-path, and SVG XML editing. It also imports several formats like EPS, Postscript, JPEG, PNG, BMP, and TIFF and exports PNG as well as multiple vector-based formats.

Inkscape's main motivations are to provide the Open Source community with a fully W3C compliant XML, SVG, and CSS2 drawing tool emphasizing a lightweight core with powerful features added as extensions, and the establishment of a friendly, open, community-oriented development processes.

Inkscape^[<https://inkscape.org/zh/>] 是替代 Adobe Illustrator（简称 AI） 最佳工具，没有之一。开源免费，功能齐全，更新快，跨平台。尤其不用面临如图\@ref(fig:ai-error)所示的兼容性问题，说白了，就是厂家在不停地刷版本号，要用户掏钱升级，我早年间也是 Adobe 的忠实粉丝，通过校园先锋以学生身份买了好几套产品，后来看透了这一切，又找到了开源的 Inkscape \index{Inkscape}，现在我没有理由去升级 AI 了，我的电脑现在装的还都是 CS6 系列。

```{r ai-error,fig.cap="兼容性错误", echo = FALSE}
knitr::include_graphics(path = "diagrams/AICC.png")
```

`r if(knitr::is_html_output()) "最后欣赏来自官网的几个作品^[图片来自 <https://inkscape.org/en/gallery/>]" `

```{r ink-work,fig.cap="作品欣赏", echo = FALSE,out.width="45%", eval= knitr::is_html_output() }
knitr::include_graphics(path = paste0(
  "diagrams/",
  paste0(
    c("space-ink", "about-ink"), ".svg"
  )
))
```


## 转化

首先安装 ImageMagick 软件包中的 covert 程序

```bash
asy -f jpg test.asy
```

高质量大图，给定像素

```
convert -geometry 1000x3000 example.eps example.png
```

指定分辨率

```
convert -geometry 1000x3000 -density 300 -units PixelsPerInch example.eps example.png
```

这样不改变图像的像素数，只是给出一个每个像素应该显示多大的提示。

## 优化

optipng 是一个非常好的图片压缩、优化工具

现在，我们设置 chunk 选项 `optipng` 为非空(non-`NULL`)的值，例如，`''` 去激活这个 hook （益辉称之为钩子，这里勾的是 optipng 这个图片优化工具）

```{r use-optipng, optipng='',fig.cap="优化"}
library(ggplot2)
set.seed(123)
qplot(rnorm(1e3), rnorm(1e3))
```

同一幅图，但是没有优化

```{r no-optipng, ref.label='use-optipng',fig.cap="没有优化"}
```

同一幅图，但是使用最高级别的优化 (传递 `-o7` 参数给 `optipng`):

```{r optipng-o7, ref.label='use-optipng', optipng='-o7',fig.cap="最强优化"}
```

## 裁剪

pdfcrop 可将 PDF 图片中留白的部分裁去，再也不用纠结 par 了

```{r pdfcrop, fig.cap="pdfcrop 裁剪白边", crop = TRUE,echo=FALSE}
knitr::include_graphics(path = "figures/map_usa_unemp.pdf")
```

## 接口

R提供了丰富的图形接口，包括 Tcl/Tk , Gtk, Shiny 等。John Chamber 在书 《Extending R》详细介绍了这一切

rattle/RGtk2: R Bindings for Gtk 2.8.0 and Above <http://www.ggobi.org/rgtk2/>

Rcmdr: tcl/tk

shiny: radiant <https://github.com/radiant-rstats/radiant>

```r
install.packages("radiant", repos = "https://radiant-rstats.github.io/minicran/")
```

<!--chapter:end:08-ImageMagick.Rmd-->

```{r include=FALSE, cache=FALSE}
library(methods)
set.seed(2018)
options(digits = 3)

Pkgs <- c(
  "reticulate",
  "showtext", "sysfonts", "showtextdb",
  "fontcm",
  "tikzDevice", "filehash", "png",
  "xkcd", "extrafontdb", "Rttf2pt1", "extrafont"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}

if (!all(c("source-han-sans-cn", "source-han-serif-cn") %in% showtextdb::font_installed())) {
  showtextdb::font_install(showtextdb::source_han_serif("CN"))
  showtextdb::font_install(showtextdb::source_han_sans("CN"))
}
extrafont::font_install("fontcm")
extrafont::loadfonts()

if (!"xkcd" %in% extrafont::fonts()) {
  path <- path.expand("~/.fonts")
  if (!file.exists(path)) {
    dir.create(path = path.expand("~/.fonts"))
  }
  download.file("http://simonsoftware.se/other/xkcd.ttf", dest = path.expand("~/.fonts/xkcd.ttf"), mode = "wb")
  extrafont::font_import(paths = path.expand("~/.fonts"), pattern = "[X/x]kcd", prompt = FALSE)
  extrafont::loadfonts()
}

extrafont::fonts() # registered with pdfFonts()
sysfonts::font_families() # List available font families

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = TRUE,
  cache = TRUE,
  citation.bibtex.max=999,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  # fig.showtext = TRUE, # too danger
  fig.asp = 0.618, # 1 / phi
  # fig.show = "hold", # not for python matplotlib
  fig.ext = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  dev = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  engine.path = list(
    octave = "/usr/bin/octave-cli"
  )
)
ext <- if (knitr::is_html_output()) ".svg" else if (knitr::is_latex_output()) ".pdf" else ".png"

# knitr::knit_hooks$set(optipng = knitr::hook_optipng, pdfcrop = knitr::hook_pdfcrop)

# https://github.com/yihui/knitr-examples/blob/master/085-pdfcrop.Rnw
# knitr::knit_hooks$set(crop = hook_pdfcrop)
options(
  repos = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/",
  tikzDefaultEngine = "xetex",
  tikzXelatexPackages = c(
    getOption("tikzXelatexPackages"),
    "\\usepackage[colorlinks, breaklinks]{hyperref}",
    "\\usepackage{color}",
    "\\usepackage{tikz}",
    "\\usepackage[active,tightpage,xetex]{preview}",
    "\\PreviewEnvironment{pgfpicture}",
    "\\usepackage{amsmath}",
    "\\usepackage{amsfonts}",
    "\\usepackage{mathrsfs}"
  )
)
# https://github.com/yihui/knitr-examples/blob/master/047-tikz-png.Rnw
# knitr::knit_hooks$set(tikz2png = function(before, options, envir) {
  # use this hook only for dev='tikz' and externalized tikz graphics
  # if (before || options$dev != "tikz" || !options$external || options$fig.num == 0) return()
  # figs <- knitr:::all_figs(options, ext = "pdf") # all figure names
  # note the tikz2png option is the extra parameters passed to 'convert'
  # for (fig in figs) {
    # system(sprintf("convert %s %s %s", options$tikz2png, fig, sub("\\.pdf$", ".png", fig)))
  # }
# })


is_on_travis = identical(Sys.getenv("TRAVIS"), "true")
is_online = curl::has_internet()

library(reticulate)
if(is_on_travis) use_virtualenv("shims") else use_python("/usr/bin/python", required = FALSE)
# Python 环境的描述在附录
# required = FALSE 默认值，如果按照指定的位置没有找到 Python 就会扫描其它版本
# use_python("/opt/pyenv/shims/python")
# use_virtualenv("shims")

# 设置环境变量 RSTUDIO_CONNECT_SERVER 由 travis-ci 设置
connectServer <- Sys.getenv("RSTUDIO_CONNECT_SERVER") # https://bookdown.org
apiKey <- Sys.getenv("RSTUDIO_CONNECT_API_KEY")
```
# 配色 {#color}

```{r include = FALSE}
Pkgs <- c(
  "colorspace", "scales", "palr", "colortools", "colormap",
  "dichromat", "yarrr", "colorRamps", "ColorPalette", "viridisLite", "pals"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) 
  install.packages(setdiff(Pkgs, .packages(TRUE)))
```

君子爱色，取之有道：有些人功力深厚，黑白灰几乎打遍天下无敌手，如科波拉执导的《教父》、沃卓斯基执导的《黑客帝国》等等，但我还是要说，好色乃人之本性也，花花世界，岂能都是法印眼中的白骨！再说《红楼梦》里，芍药丛中，桃花树下，滴翠亭边，栊翠庵里，处处都是湘云、黛玉、宝钗、妙玉留下的诗歌。

黑西装、黑领带和白衬衫，让人一下子想到了电影《黑客帝国》，构建了整幅画轴，黑领带换黑领结和红玫瑰，转而又想到电影《教父》的主角维托·唐·科莱昂，黑白灰就占了电影的主色调。这么素的颜色怎么就能这么丰富呢？这就是配色的技艺了！

## 调色板

首先选择一组合适的颜色，比如从桃色到梨色，选择6种颜色，以此为基础，可以借助`grDevices::colorRampPalette`函数扩充至想要的数目

```{r}
# Colors from https://github.com/johannesbjork/LaCroixColoR
color_vec <- c("#FF3200", "#E9A17C", "#E9E4A6", "#1BB6AF", "#0076BB", "#172869")
n <- 20
more_colors <- (grDevices::colorRampPalette(color_vec))(n)
```

这里用 `graphics::rect` 函数展示这组颜色

```{r ,fig.cap="桃色至梨色的渐变",fig.width=3,fig.height=1}
# 代码来自 ?colorspace::rainbow_hcl
pal <- function(colorname, border = "light gray", ...) {
  n <- length(colorname)
  plot(0, 0,
    type = "n", xlim = c(0, 1), ylim = c(0, 1),
    axes = FALSE, ...
  )
  rect(0:(n - 1) / n, 0, 1:n / n, 1, col = colorname, border = border)
}
par(mar = rep(0, 4))
pal(more_colors, xlab = "Colors from Peach to Pear", ylab = "")
```

早些时候我在统计之都论坛上发帖 -- R语言绘图用调色板大全 <https://d.cosx.org/d/419378-r>

阐述色理 HCL RGB CMYK 
Adobe RGB  sRGB   P3广色域  
2K 4K 5K  视网膜屏  普清  高清 超高清 全高清 显示器 
打印机  照相机 

为什么需要这么多颜色模式

知道颜色模式及其之间的转化
颜色空间及其区别 HCL and HSV color spaces
基于网页、人眼、打印机使用不同的颜色模式为何



哪里可以获取颜色

grDevices [@R-base] colorspace [@R-colorspace] RColorBrewer [@R-RColorBrewer]
基本够用

取之有道 拿人家的颜色 一定要记得引用啊，我这里要是还有哪里没有引用到的一定要提出来

18个R包 所谓降龙十八掌 要想降住色魔，非得十八掌不可


## 颜色空间

确定一种颜色，我们需要知道 色相 饱和度 明度 颜色的三个属性， 

### RGB

红(red)、绿(green)、蓝(blue)是三原色

```r
rgb(red, green, blue, alpha, names = NULL, maxColorValue = 1)
```

函数参数说明：

- __red, blue, green, alpha__ 取值范围[0,M]，M 是 *maxColorValue*
- __names__ 字符向量，给这组颜色值取名
- __maxColorValue__ 红，绿，蓝三色范围的最大值 

The colour specification refers to the standard sRGB colorspace (IEC
standard 61966).

rgb 产生一种颜色，如 `rgb(255, 0, 0, maxColorValue = 255)` 的颜色是 `"#FF0000"` ，这是一串16进制数，每两个一组，那么一组有 $16^2 = 256$ 种组合，整个一串有 $256^3 = 16777216$ 种组合，这就是RGB表达的所有颜色。用色轮示意，如图 \@ref(fig:RGBwheel)

```{r RGBwheel,fig.cap="RGB 色轮", crop = TRUE}
par(mar = rep(0,4))
pie(rep(1, times = 255), labels = "", col = rainbow(255), border = FALSE)
```

colorRampPalette 自制调色板

```{r custom,fig.cap="colorRampPalette自制调色板"}
op <- par(mfrow = c(3, 1), mar = c(0.1, 0.1, 0.5, 0.1), xaxs = "i", yaxs = "i")
n <- 1000
mycolors <- colorRampPalette(c("blue", "orangeRed"))(n)
barplot(rep(1, times = n), col = mycolors, border = mycolors, axes = FALSE)
mycolors <- colorRampPalette(c("darkgreen", "yellow", "orangered"))(n)
barplot(rep(1, times = n), col = mycolors, border = mycolors, axes = FALSE)
mycolors <- colorRampPalette(c("blue", "white", "orangered"), bias = 1.2)(n)
barplot(rep(1, times = n), col = mycolors, border = mycolors, axes = FALSE)
```

### HSL

色相饱和度亮度 hue–saturation–luminance (HSL)

### HSV 

Create a vector of colors from vectors specifying hue, saturation and value.	色相饱和度值

```r	
hsv(h = 1, s = 1, v = 1, alpha)
```

This function creates a vector of colors corresponding to the given values in HSV space.
rgb and rgb2hsv for RGB to HSV conversion;


hsv函数通过设置色调、饱和度和亮度获得颜色，三个值都是0-1的相对量

```{r hsv,fig.cap="色相、饱和度和亮度"}
par(mfcol = c(11, 121), mar = c(0, 0, 0, 0), xaxs = "i", yaxs = "i")
x <- seq(0, 10) / 10
ndx <- expand.grid(x, x, x)
mycolor <- hsv(ndx[, 3], ndx[, 2], ndx[, 1])
for (i in 1:nrow(ndx)) {
  barplot(1, col = mycolor[i], border = mycolor[i], axes = FALSE)
}
```

RGB HSV HSL 都是不连续的颜色空间，缺点

### HCL 

基于感知的颜色空间替代RGB颜色空间

通过指定色相(hue)，色度(chroma)和亮度(luminance/lightness)，创建一组（种）颜色

```r			
hcl(h = 0, c = 35, l = 85, alpha, fixup = TRUE)
```

函数参数说明：

- __h__ 颜色的色调，取值范围为[0,360]，0、120、240分别对应红色、绿色、蓝色

- __c__ 颜色的色度，其上界取决于色调和亮度

- __l__ 颜色的亮度，取值范围[0,100]，给定色调和色度，只有一部分子集可用

- __alpha__ 透明度，取值范围[0,1]，0 和1分别表示透明和不透明

This function corresponds to polar coordinates in the CIE-LUV color space


### CMYK

印刷三原色：青 (cyan)、品红 (magenta)、黄 (yellow)

- 颜色模式转化

`col2rgb` 、`rgb2hsv` 和 `rgb` 函数 [@R-base] 
`hex2RGB` 函数 [@R-colorspace] 
*col2hcl*函数 [@R-scales] 
*col2HSV*  [@R-colortools]
*col2hex* [@R-palr]

这里应该有个思维导图

```{r color-convert,echo=TRUE}
col2rgb("lightblue")  # color to  RGB
scales::col2hcl("lightblue") # color to HCL
palr::col2hex("lightblue") # color to HEX
colortools::col2HSV("lightblue") # color to HSV
```

```{r,echo=TRUE}
rgb(173,216,230,maxColorValue = 255) # RGB to HEX
colorspace::hex2RGB("#ADD8E6")  # HEX to RGB
rgb(.678,.847,.902,maxColorValue = 1) # RGB to HEX
rgb2hsv(173,216,230,maxColorValue = 255) # RGB to HSV
```

选色为什么这么难

```{r select-color,fig.cap="源起",fig.height=12}
op <- par(mar = c(1, 2, 1, 0), mfrow = c(3, 2))
set.seed(1234)
barplot(sample(seq(8), 8, replace = FALSE), col = palette(), border = "white")
set.seed(1234)
barplot(sample(seq(8), 8, replace = FALSE), col = heat.colors(8), border = "white")
set.seed(1234)
barplot(sample(seq(8), 8, replace = FALSE), col = gray.colors(8), border = "white")
set.seed(1234)
barplot(sample(seq(8), 8, replace = FALSE), col = "lightblue", border = "white")
barplot(sample(seq(8), 8, replace = FALSE), col = colorspace::sequential_hcl(8), border = "white")
barplot(sample(seq(8), 8, replace = FALSE),
  col = colorspace::diverge_hcl(8, h = c(130, 43), c = 100, l = c(70, 90)), border = "white"
)
par(op)
```





色相与阴影相比是无关紧要的，色相对于标记和分类很有用，但表示（精细的）空间数据或形状的效果较差。颜色是改善图形的好工具，但糟糕的配色方案 (color schemes) 可能会导致比灰度调色板更差的效果。[@meteorological2009]


黑、白、灰，看似有三种颜色，其实只有一种颜色，黑和白只是灰色的两极，那么如何设置灰色梯度，使得人眼比较好区分它们呢？这样获得的调色板适用于什么样的绘图环境呢？

R预置的灰色有224种，挑出其中的调色板

```{r gray-color,echo=TRUE}
grep( "^gr(a|e)y" , grep("gr(a|e)y" , colors() ,value = TRUE),value = TRUE,invert = TRUE)
```

```{r gray1,fig.width=8,fig.height=1.5,fig.cap="灰度调色板",out.width="100%"}
gray_colors <- paste0(rep(c("slategray", "darkslategray"), each = 4), seq(4))
op <- par(mar = c(0, 0, 3, 0))
pal(gray_colors, main = toString(gray_colors), cex.main = .9)
par(op)
```

gray 与 grey 是一样的，类似 color 和 colour 的关系，可能是美式和英式的差别，且看

```{r,echo=TRUE}
all.equal( col2rgb( paste0("gray",seq(100) ) ), col2rgb( paste0( "grey", seq(100) ) ) )
```

`gray100` 代表白色，`gray0` 代表黑色，提取灰色调色板，去掉首尾部分是必要的

```{r gray2,echo=TRUE,fig.width=8,fig.height=2,fig.cap="提取10种灰色做调色板"}
op <- par(mfrow = c(2,1), mar=c(0,0,2,0))
n <- 10 # 提取 n 种灰色
pal(paste0("gray", round( seq( from = 29, to = 89, length.out = n ) ) ), main = "custom color palette")
pal(gray.colors(10, start = .3, end = .9), main = "gray.colors function")
par(op)
```

比较 viridis 和 Spectral 两块调色板，如图 \@ref(fig:pickcolor) 所示，可见 Spectral 的可识别性高些

```{r pickcolor,fig.width=12,fig.height=5,out.width="100%",fig.cap="viridis 和 Spectral对比"}
dat <- as.data.frame(cbind(rep(1948 + seq(12), each = 12), rep(seq(12), 12), AirPassengers))
colnames(dat) <- c("year", "month", "passengers")
library(ggplot2)
library(colormap)
library(gridExtra)
viridis <- ggplot(data = dat, aes(as.factor(year), as.factor(month))) +
  geom_point(pch = 15, size = 8, aes(color = passengers)) +
  scale_color_colormap(colormap = colormaps$viridis) +
  labs(x = "Year", y = "Month", colour = "Passengers") +
  theme_minimal()
Spectral <- ggplot(data = dat, aes(as.factor(year), as.factor(month))) +
  geom_point(aes(colour = passengers), pch = 15, size = 8) +
  scale_colour_distiller(palette = "Spectral") +
  labs(x = "Year", y = "Month", colour = "Passengers") +
  theme_minimal()
grid.arrange(viridis, Spectral, ncol = 2)
```

再举栗子，图\@ref(fig:faithfuld)是正负例对比，其中好在哪里呢？这张图要表达美国黄石国家公园的老忠实泉间歇喷发的时间规律，那么好的标准就是层次分明，以突出不同颜色之间的时间差异。这个差异，还要看起来不那么费眼睛，越一目了然越好。

```{r faithfuld,fig.cap="美国黄石国家公园的老忠实泉"}
erupt <- ggplot(faithfuld, aes(waiting, eruptions, fill = density)) +
  geom_raster() +
  scale_x_continuous(NULL, expand = c(0, 0)) +
  scale_y_continuous(NULL, expand = c(0, 0)) +
  theme(legend.position = "none")
erupt1 <- erupt + scale_fill_gradientn(colours = gray.colors(7))
erupt2 <- erupt + scale_fill_distiller(palette = "Spectral")
erupt3 <- erupt + scale_fill_gradientn(colours = terrain.colors(7))
erupt4 <- erupt + scale_fill_colormap(colormap = colormaps$RdBu)
grid.arrange(erupt1, erupt2, erupt3, erupt4, ncol = 2)
```

RColorBrewer 包 提供了有序 (Sequential) 、定性 (Qualitative) 和发散 (Diverging)  三类调色板，一般来讲，分别适用于连续或有序分类变量、无序分类变量、两类分层对比变量的绘图。再加上强大的 ggplot2 包内置的对颜色处理的函数，如 `scale_alpha_*` 、 `scale_colour_*` 和 `scale_fill_*` 等，详见：

```{r,echo=TRUE}
ls("package:ggplot2",pattern = "scale_col(ou|o)r_")
ls("package:ggplot2",pattern = "scale_fill_")
```


除之前提到的 grDevices 包[@R-base] 、colorspace 包 [@R-colorspace]和 RColorBrewer 包 [@R-RColorBrewer] 之外，此处还收录 yarrr 包[@R-yarrr] 、dichromat 包[@R-dichromat] 、colormap 包[@R-colormap]、viridis 包[@R-viridis]、pals 包[@R-pals] 、ColorPalette 包[@R-ColorPalette]、colorRamps包 [@R-colorRamps]、colortools包[@R-colortools] ，此外还有 palr 包[@R-palr] 就不一一收录了

```{r palettes,fig.height=5.5,fig.width=6,fig.cap="grDevices调色板1"}
# 代码来自 ?palettes
demo.pal <-
  function(n, border = if (n < 32) "light gray" else NA,
           main = paste("color palettes: alpha = 1,  n=", n),
           ch.col = c("rainbow(n, start=.7, end=.1)", "heat.colors(n)",
                      "terrain.colors(n)", "topo.colors(n)",
                      "cm.colors(n)","gray.colors(n, start = 0.3, end = 0.9)"))
{
    nt <- length(ch.col)
    i <- 1:n; j <- n / nt; d <- j/6; dy <- 2*d
    plot(i, i+d, type = "n", axes = FALSE, ylab = "",xlab = "", main = main)
    for (k in 1:nt) {
        rect(i-.5, (k-1)*j+ dy, i+.4, k*j,
             col = eval(parse(text = ch.col[k])), border = border)
        text(2*j,  k * j + dy/4, ch.col[k])
    }
}
n <- if(.Device == "postscript") 64 else 16
# Since for screen, larger n may give color allocation problem
op <- par(mar=c(0,0,2,0))
demo.pal(n)
par(op)
```

```{r democolors,fig.width=8,fig.height=11,fig.align='center',fig.cap="grDevices调色板2",out.width="100%"}
op <- par(mfrow =c(33,1),mar=c(0,0,.8,0))
 for( i in seq(32)) {
	  pal( colors()[ (1+20*(i-1)) : (20*i) ] ,main = paste(1+20*(i-1),"to", 20*i))
}
pal( colors()[ 641 : 657 ], main = "641 to 657") 
par(op)
```


```{r ColorPalette,fig.width=8,fig.height=3,fig.cap="ColorPalette调色板"}
library(ColorPalette)
op <- par(mfrow=c(4,1),mar=c(0,0,2,0))
pal(generateMonochromaticColors("lightblue", 16),main = "generateMonochromaticColors")
pal(complementColors("lightblue", 16),main = "complementColors")
pal(tetradicColors("lightblue",16),main = "tetradicColors")
pal(triadicColors("lightblue",16), main = "triadicColors")
par(op)
```

```{r colorRamps,fig.width=8,fig.height=4,fig.cap="colorRamps调色板"}
library(colorRamps)
op <- par(mfrow=c(6,1),mar=c(0,0,2,0))
n <- 16
pal(matlab.like(n),main = "matlab.like")
pal(matlab.like2(n),main = "matlab.like2")
pal(blue2green2red(n),main = "blue2green2red")
pal(primary.colors(n), main = "primary.colors")
pal(ygobb(n), main = "ygobb")
pal(rgb.tables(n), main = "rgb.tables")
par(op)
```

```{r viridis,fig.width=8,fig.height=3,fig.cap="viridis调色板"}
library(viridisLite)
n <- 16
op <- par(mfrow=c(4,1),mar=c(0,0,2,0))
pal(magma(n, alpha = 1, begin = 0, end = 1))
pal(inferno(n, alpha = 1, begin = 0, end = 1))
pal(plasma(n, alpha = 1, begin = 0, end = 1))
pal(viridis(n, alpha = 1, begin = 0, end = 1))
par(op)
```


```{r pals1,fig.width=8,fig.height=8,fig.cap="pals调色板1",eval=FALSE}
op <- par(mfrow=c(2,1),mar=c(0,3,2,0))
library(pals)
pals::pal.bands(coolwarm, parula, ocean.haline, cubicl, kovesi.rainbow,
          ocean.phase, brewer.paired(12), stepped,
          main="Colormap suggestions")

# Qualtitative
pals::pal.bands(brewer.accent(8), brewer.dark2(8), brewer.paired(12), brewer.pastel1(9),
          brewer.pastel2(8), brewer.set1(9), brewer.set2(8), brewer.set3(10),
          labels=c("brewer.accent", "brewer.dark2", "brewer.paired", "brewer.pastel1",
                   "brewer.pastel2", "brewer.set1", "brewer.set2", "brewer.set3"),
          main="Brewer qualitative")
par(op)
```

```{r pals2,fig.width=8,fig.height=8,fig.cap="pals调色板2",eval=FALSE}
op <- par(mfrow=c(2,1),mar=c(0,3,2,0))
# Sequential
pals::pal.bands(brewer.blues, brewer.bugn, brewer.bupu, brewer.gnbu, brewer.greens,
          brewer.greys, brewer.oranges, brewer.orrd, brewer.pubu, brewer.pubugn,
          brewer.purd, brewer.purples, brewer.rdpu, brewer.reds, brewer.ylgn,
          brewer.ylgnbu, brewer.ylorbr, brewer.ylorrd,
          main="Brewer sequential")

# Diverging
pals::pal.bands(brewer.brbg, brewer.piyg, brewer.prgn, brewer.puor, brewer.rdbu,
          brewer.rdgy, brewer.rdylbu, brewer.rdylgn, brewer.spectral,
          main="Brewer diverging")
par(op)
```

```{r colortools1,fig.width=6,fig.height=6,fig.cap="colortools调色板1"}
colortools::pals()
```

```{r colortools2,fig.width=6,fig.height=6,results='hide',fig.cap="colortools调色板2"}
colortools::wheel(colortools::pals("fish")[1], bg = "white")
```


```{r colorspace,fig.width=8,fig.height=8,fig.cap="colorspace调色板"}
library(colorspace)
## a few useful diverging HCL palettes
op <- par(mar = c(0,0,2,0), mfrow = c(16, 2))

pal(diverge_hcl(16), main = "diverging HCL palettes")
pal(diverge_hcl(16, h = c(246, 40), c = 96, l = c(65, 90)))
pal(diverge_hcl(16, h = c(130, 43), c = 100, l = c(70, 90)))
pal(diverge_hcl(16, h = c(180, 70), c = 70, l = c(90, 95)))

pal(diverge_hcl(16, h = c(180, 330), c = 59, l = c(75, 95)))
pal(diverge_hcl(16, h = c(128, 330), c = 98, l = c(65, 90)))
pal(diverge_hcl(16, h = c(255, 330), l = c(40, 90)))
pal(diverge_hcl(16, c = 100, l = c(50, 90), power = 1))

## sequential palettes
pal(sequential_hcl(16), main= "sequential palettes")
pal(heat_hcl(16, h = c(0, -100), l = c(75, 40), c = c(40, 80), power = 1))
pal(terrain_hcl(16, c = c(65, 0), l = c(45, 95), power = c(1/3, 1.5)))
pal(heat_hcl(16, c = c(80, 30), l = c(30, 90), power = c(1/5, 1.5)))

## compare base and colorspace palettes
## (in color and desaturated)
## diverging red-blue colors
pal(diverge_hsv(16), main = "diverging red-blue colors")
pal(diverge_hcl(16, c = 100, l = c(50, 90)))
pal(desaturate(diverge_hsv(16)))
pal(desaturate(diverge_hcl(16, c = 100, l = c(50, 90))))

## diverging cyan-magenta colors
pal(cm.colors(16), main = "diverging cyan-magenta colors")
pal(diverge_hcl(16, h = c(180, 330), c = 59, l = c(75, 95)))
pal(desaturate(cm.colors(16)))
pal(desaturate(diverge_hcl(16, h = c(180, 330), c = 59, l = c(75, 95))))

## heat colors
pal(heat.colors(16), main = "heat colors")
pal(heat_hcl(16))
pal(desaturate(heat.colors(16)))
pal(desaturate(heat_hcl(16)))

## terrain colors
pal(terrain.colors(16), main = "terrain colors")
pal(terrain_hcl(16))
pal(desaturate(terrain.colors(16)))
pal(desaturate(terrain_hcl(16)))

pal(rainbow_hcl(16, start = 30, end = 300), main = "dynamic")
pal(rainbow_hcl(16, start = 60, end = 240), main = "harmonic")
pal(rainbow_hcl(16, start = 270, end = 150), main = "cold")
pal(rainbow_hcl(16, start = 90, end = -30), main = "warm")

par(op)
```

```{r RColorBrewer,fig.height=8,fig.cap="RColorBrewer调色板"}
op <- par(mar=c(0,4,0,0))
RColorBrewer::display.brewer.all()
par(op)
```

```{r yarrr, fig.width = 8, fig.height = 7,fig.cap="yarrr调色板"}
yarrr::piratepal(palette = "all")
```

```{r dichromat,fig.height=4,fig.width=6,fig.cap="dichromat调色板适用于色盲人群"}
library(dichromat) 
op <- par(mar=c(0,0,2,0),mfrow = c(9,2))
for(i in seq(17)){
	pal(colorschemes[[i]], main =  names(colorschemes)[i])
} 
par(op)
```

```{r colormap,fig.width=10,fig.height=12,results='hide',fig.align='center',fig.cap="colormap调色板"}
library(colormap)
color_map <- function(colorname, border = "light gray"){ 
	col <- colormap_pal(colormap=colorname)(25)
	n <- length(col)
	plot(0, 0, type="n", xlim = c(0, 1), ylim = c(0, 1),
		axes = FALSE, xlab = "", ylab = "")
	rect(0:(n-1)/n, 0, 1:n/n, 1, col = col, border = border)
	text(.5,.5,labels = colorname)
}
op <- par(mfrow = c(22,2),mar = c(0, 0, 1, 0))
invisible( lapply(unlist(colormaps),color_map) )
par(op)
```

<!--chapter:end:09-colors.Rmd-->

```{r include=FALSE, cache=FALSE}
library(methods)
set.seed(2018)
options(digits = 3)

Pkgs <- c(
  "reticulate",
  "showtext", "sysfonts", "showtextdb",
  "fontcm",
  "tikzDevice", "filehash", "png",
  "xkcd", "extrafontdb", "Rttf2pt1", "extrafont"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}

if (!all(c("source-han-sans-cn", "source-han-serif-cn") %in% showtextdb::font_installed())) {
  showtextdb::font_install(showtextdb::source_han_serif("CN"))
  showtextdb::font_install(showtextdb::source_han_sans("CN"))
}
extrafont::font_install("fontcm")
extrafont::loadfonts()

if (!"xkcd" %in% extrafont::fonts()) {
  path <- path.expand("~/.fonts")
  if (!file.exists(path)) {
    dir.create(path = path.expand("~/.fonts"))
  }
  download.file("http://simonsoftware.se/other/xkcd.ttf", dest = path.expand("~/.fonts/xkcd.ttf"), mode = "wb")
  extrafont::font_import(paths = path.expand("~/.fonts"), pattern = "[X/x]kcd", prompt = FALSE)
  extrafont::loadfonts()
}

extrafont::fonts() # registered with pdfFonts()
sysfonts::font_families() # List available font families

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = TRUE,
  cache = TRUE,
  citation.bibtex.max=999,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  # fig.showtext = TRUE, # too danger
  fig.asp = 0.618, # 1 / phi
  # fig.show = "hold", # not for python matplotlib
  fig.ext = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  dev = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  engine.path = list(
    octave = "/usr/bin/octave-cli"
  )
)
ext <- if (knitr::is_html_output()) ".svg" else if (knitr::is_latex_output()) ".pdf" else ".png"

# knitr::knit_hooks$set(optipng = knitr::hook_optipng, pdfcrop = knitr::hook_pdfcrop)

# https://github.com/yihui/knitr-examples/blob/master/085-pdfcrop.Rnw
# knitr::knit_hooks$set(crop = hook_pdfcrop)
options(
  repos = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/",
  tikzDefaultEngine = "xetex",
  tikzXelatexPackages = c(
    getOption("tikzXelatexPackages"),
    "\\usepackage[colorlinks, breaklinks]{hyperref}",
    "\\usepackage{color}",
    "\\usepackage{tikz}",
    "\\usepackage[active,tightpage,xetex]{preview}",
    "\\PreviewEnvironment{pgfpicture}",
    "\\usepackage{amsmath}",
    "\\usepackage{amsfonts}",
    "\\usepackage{mathrsfs}"
  )
)
# https://github.com/yihui/knitr-examples/blob/master/047-tikz-png.Rnw
# knitr::knit_hooks$set(tikz2png = function(before, options, envir) {
  # use this hook only for dev='tikz' and externalized tikz graphics
  # if (before || options$dev != "tikz" || !options$external || options$fig.num == 0) return()
  # figs <- knitr:::all_figs(options, ext = "pdf") # all figure names
  # note the tikz2png option is the extra parameters passed to 'convert'
  # for (fig in figs) {
    # system(sprintf("convert %s %s %s", options$tikz2png, fig, sub("\\.pdf$", ".png", fig)))
  # }
# })


is_on_travis = identical(Sys.getenv("TRAVIS"), "true")
is_online = curl::has_internet()

library(reticulate)
if(is_on_travis) use_virtualenv("shims") else use_python("/usr/bin/python", required = FALSE)
# Python 环境的描述在附录
# required = FALSE 默认值，如果按照指定的位置没有找到 Python 就会扫描其它版本
# use_python("/opt/pyenv/shims/python")
# use_virtualenv("shims")

# 设置环境变量 RSTUDIO_CONNECT_SERVER 由 travis-ci 设置
connectServer <- Sys.getenv("RSTUDIO_CONNECT_SERVER") # https://bookdown.org
apiKey <- Sys.getenv("RSTUDIO_CONNECT_API_KEY")
```
# 字体 {#fonts}

```{r include = FALSE}
Pkgs <- c(
  "maps", "mapdata", "mapproj"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) 
  install.packages(setdiff(Pkgs, .packages(TRUE)))
```

## CJK 字体

windows 下，支持 `pdf`，`cairo_pdf` 和 `svg` 设备，如 `cairo_pdf(file = "cjk.pdf",width=3,height=1)`

```{r cjk,fig.width=3,fig.height=1,out.width="100%",fig.cap = "CJK 字体支持"}
library(grid)
grid.text("\u4F60\u597D",
  y = 2 / 3,
  gp = gpar(fontfamily = "CNS1")
)
grid.text(
  "is 'hello' in (Traditional) Chinese",
  y = 1 / 3
)
```

参考文献 <https://cran.r-project.org/doc/Rnews/Rnews_2006-2.pdf> Non-Standard Fonts in PostScript and PDF Graphics 一节

grDevices 包提供了如下函数，用于 postscript 和 pdf 图形设备，嵌入字体借助了 [Ghostscript](https://www.ghostscript.com/) 其下载地址 <https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs923/gs923w64.exe>

以及 PDF 阅读器 MuPDF <https://www.mupdf.com/>

```r
postscriptFonts(...)
pdfFonts(...)
embedFonts
```


字体设置包括自定义中文字体、英文字体和数学公式。

> 启用showtext 包处理中文，在网页版文档中，png 图片中的字体会变很小

## showtext 

showtext 包[@Qiu2015]可以调用系统字体，图\@ref(fig:iris-ggplot2)使用5号思源宋体，英文和数字使用 serif 字体。详细的使用文档可以看 [showtext 的开发页面](https://github.com/yixuan/showtext)

```{r iris-ggplot2, fig.cap="showtext包处理图里的中文",fig.showtext=TRUE}
library(ggplot2)
ggplot(iris, aes(Sepal.Length, Sepal.Width)) +
  geom_point(aes(colour = Species)) +
  scale_colour_brewer(palette = "Set1") +
  labs(
    title = "鸢尾花数据的散点图",
    x = "萼片长度", y = "萼片宽度", colour = "鸢尾花类别"
  ) +
  theme_minimal(base_size = 10.54, base_family = "source-han-serif-cn") +
  theme(
    legend.text = element_text(family = "serif", size = 10.54),
    axis.text = element_text(family = "serif", size = 10.54)
    )
```

用 ggplot2 画个简单地图，地图数据在 mapdata 包 [@R-mapdata]，如图 \@ref(fig:map-Fiji-earthquake) 所示

```{r map-Fiji-earthquake, fig.cap="斐济地震带",fig.showtext=TRUE}
library(maps)
library(mapdata)
FijiMap <- map_data("worldHires", region = "Fiji")
ggplot(FijiMap, aes(x = long, y = lat)) +
  geom_map(map = FijiMap, aes(map_id = region), size = .2) +
  geom_point(data = quakes, aes(x = long, y = lat, colour = mag), pch = 16) +
  xlim(160, 195) +
  scale_colour_distiller(palette = "Spectral") +
  scale_y_continuous(breaks = (-18:18) * 5) +
  coord_map("ortho", orientation = c(-10, 180, 0)) +
  labs(colour = "震级", x = "经度", y = "纬度", title = "斐济地震带") +
  theme_minimal() +
  theme(
    title = element_text(family = "source-han-sans-cn"),
    axis.title = element_text(family = "source-han-serif-cn"),
    legend.title = element_text(family = "source-han-sans-cn"),
    legend.position = c(1, 0), legend.justification = c(1, 0)
  )
```

用 base plot 画地图，如图 \@ref(fig:maps-unemp-plot) 所示

```{r maps-unemp-plot, fig.cap="2009年美国各城镇失业率",fig.width=8,fig.height=6,out.width="100%"}
library(mapproj)
data(unemp)
data(county.fips)
colors <- c("#F1EEF6", "#D4B9DA", "#C994C7", "#DF65B0", "#DD1C77", "#980043")
unemp$colorBuckets <- as.numeric(cut(unemp$unemp, c(0, 2, 4, 6, 8, 10, 100)))
leg.txt <- c("<2%", "2-4%", "4-6%", "6-8%", "8-10%", ">10%")
cnty.fips <- county.fips$fips[match(
  map("county", plot = FALSE)$names,
  county.fips$polyname
)]
colorsmatched <- unemp$colorBuckets[match(cnty.fips, unemp$fips)]
par(mar = c(0, 0, 2, 0))
# draw map
map("county",
  col = colors[colorsmatched], fill = TRUE, resolution = 0,
  lty = 0, projection = "polyconic"
)
map("state",
  col = "white", fill = FALSE, add = TRUE, lty = 1, lwd = 0.2,
  projection = "polyconic"
)
title("unemployment by county, 2009")
legend("top", leg.txt, horiz = TRUE, fill = colors)
```

## xkcd

这篇文章主要使用 ggplot2 包[@Wickham2016]绘图，为了好玩我们还使用 xkcd 字体，先下载和加载 xkcd 包[@R-xkcd]，它提供一个 gg 风格的图层`theme_xkcd()`，图 \@ref(fig:xkcd-embed) 是一个简单使用 xkcd 字体的例子

```{r xkcd-embed, fig.cap = "xkcd 风的图",dev = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "cairo_pdf" else png}
library(extrafont)
library(xkcd)
ggplot(aes(mpg, wt), data = mtcars) + geom_point() +
    theme_xkcd()
```

## fontcm

安装 fontcm 包[@R-fontcm]处理数学公式，下载 fontcm 包^[<https://github.com/wch/fontcm>] 和相关字体，使用 fontcm 包，一个小 demo 如下，这里已经使用 `cairo_pdf` 设备保存图片了，如果用 `pdf` 设备保存会更加难看

```{r fontcm-demo, fig.cap = "fontcm 处理数学公式"}
library(fontcm)
p <- qplot(c(1, 5), c(1, 5)) +
  xlab("Made with CM fonts") + ylab("Made with CM fonts") +
  ggtitle("Made with CM fonts")
# 公式
eq <- "italic(sum(frac(1, n*'!'), n==0, infinity) ==
       lim(bgroup('(', 1 + frac(1, n), ')')^n, n %->% infinity))"
# 默认字体
p1 <- p + annotate("text", x = 3, y = 3, parse = TRUE, label = eq) # fig 1
# 使用 CM Roman 字体
p2 <- p + annotate("text",
  x = 3, y = 3, parse = TRUE,
  family = "CM Roman", label = eq
) +
  theme(
    text = element_text(size = 16, family = "CM Roman"),
    axis.title.x = element_text(face = "italic"),
    axis.title.y = element_text(face = "bold")
  )
library(gridExtra)
grid.arrange(p1,p2, nrow = 1, ncol = 2)
```

使用 ghostscript 对 `pdf` 设备保存的图形嵌入数学字体（此嵌入字体的方法对 `cairo_pdf` 保存的图形无效），最终效果如图 \@ref(fig:fontcm-ggplot) 所示，

```r 
pdf(file = 'figures/ggplot_cm.pdf',width = 8,height = 4)
grid.arrange(p1,p2, nrow = 1, ncol = 2)
dev.off()
# 嵌入字体
extrafont::embed_fonts("figures/ggplot_cm.pdf", outfile = "figures/ggplot_cm_embed.pdf")
```
```{r fontcm-ggplot, echo = FALSE, fig.cap = "fontcm 处理数学公式"}
knitr::include_graphics(path = paste0("figures/ggplot_cm_embed", if(knitr::is_latex_output()) ".pdf" else ".png"))
```

## tikzDevice

先测试一下

```{r test-tikz-device, eval= identical(Sys.getenv("TRAVIS"), "true")}
tikzDevice::tikzTest()
```

tikz 源于 LaTeX 宏包，在 R 语言绘图的世界里，对基础图形有很好的支持，如图 \@ref(fig:tikz-demo) 所示，坐标轴标签，标题，图例等位置都支持数学公式，既然含有数学公式，就得设置 `dev = 'tikz'` 和 `fig.ext = 'tex'`，并且只产生 PDF 格式图片，除非研究一个钩子（见 `common.R` 文件），遇到这种情况再将 PDF 转化为 PNG 格式

```{r tikz-linear, dev = 'tikz', fig.cap = "线性回归模型", fig.ext = 'tex', eval = knitr::is_latex_output() & identical(Sys.getenv("TRAVIS"), "true")}
x <- rnorm(10)
y <- x + rnorm(5, sd = 0.25)
model <- lm(y ~ x)
rsq <- summary(model)$r.squared
rsq <- signif(rsq, 4)
plot(x, y, main = "Hello \\LaTeX!", xlab = "$x$", ylab = "$y$", 
     sub = "$\\mathcal{N}(\\mathbf{x};\\mu,\\Sigma)$")
abline(model, col = "red")
mtext(paste("Linear model: $R^{2}=", rsq, "$"), line = 0.5)
legend("bottomright", legend = paste0("$y = ", 
                                     round(coef(model)[2], 3),
                                     "x +", 
                                     round(coef(model)[1], 3), 
                                     "$"
                                     ), 
       bty = "n")
```

或者单独保存成 pdf 图片和 png 图片，然后插入

```{r tikz-demo, fig.cap = "tikz 之线性回归", echo = FALSE, dpi = 300}
knitr::include_graphics(path = paste0("figures/linear", if(knitr::is_latex_output()) ".pdf" else ".png"))
```

再把代码贴上

```{r tikz-linear-regression-code}
cat(readLines("code/tikz-linear-regression.R", encoding = "UTF-8"), sep = "\n")
```

虽然复杂图片也可直接用 tikz 制作但是，尺寸等细节不好调整（我还没找到合适的方法），比较合适的做法可能是，独立制作图，然后作为图片插入，以一个颇具复杂度的图片为例，如图 \@ref(fig:plot3d-tikz) 所示

```{r tikz-persp-3d-code}
cat(readLines("code/tikz-persp-3d.R", encoding = "UTF-8"), sep = "\n")
```

此外还有一个重要原因，tikz 图形绘制起来比较慢，尤其是线条密集型的图片，这样过于耗时，放在 travis 上编译不合适。如图  \@ref(fig:plot3d-tikz) 

```{r plot3d-tikz, fig.cap="tikz 之复杂公式", echo = FALSE}
knitr::include_graphics(path = paste0("figures/binormal", if(knitr::is_latex_output()) ".pdf" else ".png"))
```

## TikZ 和 PGF

如图 \@ref(fig:latex-tikz) 所示，模板存放在 `tikz/tikz2pdf.tex`

```{r}
names(knitr::knit_engines$get())
```

```{tikz latex-tikz, fig.cap='tikz 图形', engine.opts = list(template = "tikz/tikz2pdf.tex")}
\begin{tikzpicture}[scale=.7]
\draw [fill=gray!30,very thick] (0,-1) rectangle (5,1);
\draw [very thick] (5, 0) -- (13,0);
\node [below] at (2,-1) {\large Hello};
\node [below, align=center] at (0,-1) {\large Two\\ lines};
\end{tikzpicture}
```

一幅纯 tikz 代码绘制的图形，代码如下

```{r import-tikze-code}
cat(readLines("tikz/mini-demo.tex", encoding = "UTF-8"), sep = "\n")
```

```{r mini-tikz-demo,echo=FALSE,fig.cap="一幅迷你 tikz 图形"}
knitr::include_graphics(path = "tikz/mini-demo.png")
```

```{r, dev='tikz', fig.width=4.4, fig.height=3.3, out.width="90%",eval = knitr::is_latex_output() & identical(Sys.getenv("TRAVIS"), "true"),fig.ext='tex', tikz2png='-density 300',fig.cap='tikz 图形'}
par(mar = c(4.5, 4, .1, .1))
hist(rnorm(1000), main='', xlab='$x$ (how the fonts look like here?)',
  ylab='$\\hat{f}(x) = \\frac{1}{nh}\\sum_{i=1}^n \\cdots$')
```


<!--chapter:end:10-fonts.Rmd-->

```{r include=FALSE, cache=FALSE}
library(methods)
set.seed(2018)
options(digits = 3)

Pkgs <- c(
  "reticulate",
  "showtext", "sysfonts", "showtextdb",
  "fontcm",
  "tikzDevice", "filehash", "png",
  "xkcd", "extrafontdb", "Rttf2pt1", "extrafont"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}

if (!all(c("source-han-sans-cn", "source-han-serif-cn") %in% showtextdb::font_installed())) {
  showtextdb::font_install(showtextdb::source_han_serif("CN"))
  showtextdb::font_install(showtextdb::source_han_sans("CN"))
}
extrafont::font_install("fontcm")
extrafont::loadfonts()

if (!"xkcd" %in% extrafont::fonts()) {
  path <- path.expand("~/.fonts")
  if (!file.exists(path)) {
    dir.create(path = path.expand("~/.fonts"))
  }
  download.file("http://simonsoftware.se/other/xkcd.ttf", dest = path.expand("~/.fonts/xkcd.ttf"), mode = "wb")
  extrafont::font_import(paths = path.expand("~/.fonts"), pattern = "[X/x]kcd", prompt = FALSE)
  extrafont::loadfonts()
}

extrafont::fonts() # registered with pdfFonts()
sysfonts::font_families() # List available font families

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = TRUE,
  cache = TRUE,
  citation.bibtex.max=999,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  # fig.showtext = TRUE, # too danger
  fig.asp = 0.618, # 1 / phi
  # fig.show = "hold", # not for python matplotlib
  fig.ext = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  dev = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  engine.path = list(
    octave = "/usr/bin/octave-cli"
  )
)
ext <- if (knitr::is_html_output()) ".svg" else if (knitr::is_latex_output()) ".pdf" else ".png"

# knitr::knit_hooks$set(optipng = knitr::hook_optipng, pdfcrop = knitr::hook_pdfcrop)

# https://github.com/yihui/knitr-examples/blob/master/085-pdfcrop.Rnw
# knitr::knit_hooks$set(crop = hook_pdfcrop)
options(
  repos = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/",
  tikzDefaultEngine = "xetex",
  tikzXelatexPackages = c(
    getOption("tikzXelatexPackages"),
    "\\usepackage[colorlinks, breaklinks]{hyperref}",
    "\\usepackage{color}",
    "\\usepackage{tikz}",
    "\\usepackage[active,tightpage,xetex]{preview}",
    "\\PreviewEnvironment{pgfpicture}",
    "\\usepackage{amsmath}",
    "\\usepackage{amsfonts}",
    "\\usepackage{mathrsfs}"
  )
)
# https://github.com/yihui/knitr-examples/blob/master/047-tikz-png.Rnw
# knitr::knit_hooks$set(tikz2png = function(before, options, envir) {
  # use this hook only for dev='tikz' and externalized tikz graphics
  # if (before || options$dev != "tikz" || !options$external || options$fig.num == 0) return()
  # figs <- knitr:::all_figs(options, ext = "pdf") # all figure names
  # note the tikz2png option is the extra parameters passed to 'convert'
  # for (fig in figs) {
    # system(sprintf("convert %s %s %s", options$tikz2png, fig, sub("\\.pdf$", ".png", fig)))
  # }
# })


is_on_travis = identical(Sys.getenv("TRAVIS"), "true")
is_online = curl::has_internet()

library(reticulate)
if(is_on_travis) use_virtualenv("shims") else use_python("/usr/bin/python", required = FALSE)
# Python 环境的描述在附录
# required = FALSE 默认值，如果按照指定的位置没有找到 Python 就会扫描其它版本
# use_python("/opt/pyenv/shims/python")
# use_virtualenv("shims")

# 设置环境变量 RSTUDIO_CONNECT_SERVER 由 travis-ci 设置
connectServer <- Sys.getenv("RSTUDIO_CONNECT_SERVER") # https://bookdown.org
apiKey <- Sys.getenv("RSTUDIO_CONNECT_API_KEY")
```
# 动画 {#animotion}

## JS 动画

## svg 动画

svgViewR <https://aaronolsen.github.io/tutorials/visualization3d.html>

## mapmate


```r
devtools::install_github("leonawicz/mapmate")
```

## rgl

真三维


<!--chapter:end:11-animations.Rmd-->

```{r include=FALSE, cache=FALSE}
library(methods)
set.seed(2018)
options(digits = 3)

Pkgs <- c(
  "reticulate",
  "showtext", "sysfonts", "showtextdb",
  "fontcm",
  "tikzDevice", "filehash", "png",
  "xkcd", "extrafontdb", "Rttf2pt1", "extrafont"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}

if (!all(c("source-han-sans-cn", "source-han-serif-cn") %in% showtextdb::font_installed())) {
  showtextdb::font_install(showtextdb::source_han_serif("CN"))
  showtextdb::font_install(showtextdb::source_han_sans("CN"))
}
extrafont::font_install("fontcm")
extrafont::loadfonts()

if (!"xkcd" %in% extrafont::fonts()) {
  path <- path.expand("~/.fonts")
  if (!file.exists(path)) {
    dir.create(path = path.expand("~/.fonts"))
  }
  download.file("http://simonsoftware.se/other/xkcd.ttf", dest = path.expand("~/.fonts/xkcd.ttf"), mode = "wb")
  extrafont::font_import(paths = path.expand("~/.fonts"), pattern = "[X/x]kcd", prompt = FALSE)
  extrafont::loadfonts()
}

extrafont::fonts() # registered with pdfFonts()
sysfonts::font_families() # List available font families

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = TRUE,
  cache = TRUE,
  citation.bibtex.max=999,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  # fig.showtext = TRUE, # too danger
  fig.asp = 0.618, # 1 / phi
  # fig.show = "hold", # not for python matplotlib
  fig.ext = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  dev = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  engine.path = list(
    octave = "/usr/bin/octave-cli"
  )
)
ext <- if (knitr::is_html_output()) ".svg" else if (knitr::is_latex_output()) ".pdf" else ".png"

# knitr::knit_hooks$set(optipng = knitr::hook_optipng, pdfcrop = knitr::hook_pdfcrop)

# https://github.com/yihui/knitr-examples/blob/master/085-pdfcrop.Rnw
# knitr::knit_hooks$set(crop = hook_pdfcrop)
options(
  repos = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/",
  tikzDefaultEngine = "xetex",
  tikzXelatexPackages = c(
    getOption("tikzXelatexPackages"),
    "\\usepackage[colorlinks, breaklinks]{hyperref}",
    "\\usepackage{color}",
    "\\usepackage{tikz}",
    "\\usepackage[active,tightpage,xetex]{preview}",
    "\\PreviewEnvironment{pgfpicture}",
    "\\usepackage{amsmath}",
    "\\usepackage{amsfonts}",
    "\\usepackage{mathrsfs}"
  )
)
# https://github.com/yihui/knitr-examples/blob/master/047-tikz-png.Rnw
# knitr::knit_hooks$set(tikz2png = function(before, options, envir) {
  # use this hook only for dev='tikz' and externalized tikz graphics
  # if (before || options$dev != "tikz" || !options$external || options$fig.num == 0) return()
  # figs <- knitr:::all_figs(options, ext = "pdf") # all figure names
  # note the tikz2png option is the extra parameters passed to 'convert'
  # for (fig in figs) {
    # system(sprintf("convert %s %s %s", options$tikz2png, fig, sub("\\.pdf$", ".png", fig)))
  # }
# })


is_on_travis = identical(Sys.getenv("TRAVIS"), "true")
is_online = curl::has_internet()

library(reticulate)
if(is_on_travis) use_virtualenv("shims") else use_python("/usr/bin/python", required = FALSE)
# Python 环境的描述在附录
# required = FALSE 默认值，如果按照指定的位置没有找到 Python 就会扫描其它版本
# use_python("/opt/pyenv/shims/python")
# use_virtualenv("shims")

# 设置环境变量 RSTUDIO_CONNECT_SERVER 由 travis-ci 设置
connectServer <- Sys.getenv("RSTUDIO_CONNECT_SERVER") # https://bookdown.org
apiKey <- Sys.getenv("RSTUDIO_CONNECT_API_KEY")
```
# (PART) 统计计算 {-}

<!--chapter:end:Computations.Rmd-->

```{r include=FALSE, cache=FALSE}
library(methods)
set.seed(2018)
options(digits = 3)

Pkgs <- c(
  "reticulate",
  "showtext", "sysfonts", "showtextdb",
  "fontcm",
  "tikzDevice", "filehash", "png",
  "xkcd", "extrafontdb", "Rttf2pt1", "extrafont"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}

if (!all(c("source-han-sans-cn", "source-han-serif-cn") %in% showtextdb::font_installed())) {
  showtextdb::font_install(showtextdb::source_han_serif("CN"))
  showtextdb::font_install(showtextdb::source_han_sans("CN"))
}
extrafont::font_install("fontcm")
extrafont::loadfonts()

if (!"xkcd" %in% extrafont::fonts()) {
  path <- path.expand("~/.fonts")
  if (!file.exists(path)) {
    dir.create(path = path.expand("~/.fonts"))
  }
  download.file("http://simonsoftware.se/other/xkcd.ttf", dest = path.expand("~/.fonts/xkcd.ttf"), mode = "wb")
  extrafont::font_import(paths = path.expand("~/.fonts"), pattern = "[X/x]kcd", prompt = FALSE)
  extrafont::loadfonts()
}

extrafont::fonts() # registered with pdfFonts()
sysfonts::font_families() # List available font families

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = TRUE,
  cache = TRUE,
  citation.bibtex.max=999,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  # fig.showtext = TRUE, # too danger
  fig.asp = 0.618, # 1 / phi
  # fig.show = "hold", # not for python matplotlib
  fig.ext = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  dev = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  engine.path = list(
    octave = "/usr/bin/octave-cli"
  )
)
ext <- if (knitr::is_html_output()) ".svg" else if (knitr::is_latex_output()) ".pdf" else ".png"

# knitr::knit_hooks$set(optipng = knitr::hook_optipng, pdfcrop = knitr::hook_pdfcrop)

# https://github.com/yihui/knitr-examples/blob/master/085-pdfcrop.Rnw
# knitr::knit_hooks$set(crop = hook_pdfcrop)
options(
  repos = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/",
  tikzDefaultEngine = "xetex",
  tikzXelatexPackages = c(
    getOption("tikzXelatexPackages"),
    "\\usepackage[colorlinks, breaklinks]{hyperref}",
    "\\usepackage{color}",
    "\\usepackage{tikz}",
    "\\usepackage[active,tightpage,xetex]{preview}",
    "\\PreviewEnvironment{pgfpicture}",
    "\\usepackage{amsmath}",
    "\\usepackage{amsfonts}",
    "\\usepackage{mathrsfs}"
  )
)
# https://github.com/yihui/knitr-examples/blob/master/047-tikz-png.Rnw
# knitr::knit_hooks$set(tikz2png = function(before, options, envir) {
  # use this hook only for dev='tikz' and externalized tikz graphics
  # if (before || options$dev != "tikz" || !options$external || options$fig.num == 0) return()
  # figs <- knitr:::all_figs(options, ext = "pdf") # all figure names
  # note the tikz2png option is the extra parameters passed to 'convert'
  # for (fig in figs) {
    # system(sprintf("convert %s %s %s", options$tikz2png, fig, sub("\\.pdf$", ".png", fig)))
  # }
# })


is_on_travis = identical(Sys.getenv("TRAVIS"), "true")
is_online = curl::has_internet()

library(reticulate)
if(is_on_travis) use_virtualenv("shims") else use_python("/usr/bin/python", required = FALSE)
# Python 环境的描述在附录
# required = FALSE 默认值，如果按照指定的位置没有找到 Python 就会扫描其它版本
# use_python("/opt/pyenv/shims/python")
# use_virtualenv("shims")

# 设置环境变量 RSTUDIO_CONNECT_SERVER 由 travis-ci 设置
connectServer <- Sys.getenv("RSTUDIO_CONNECT_SERVER") # https://bookdown.org
apiKey <- Sys.getenv("RSTUDIO_CONNECT_API_KEY")
```
# 数值优化 {#optimation}

## 测试函数

$$f(x,y) = 3*(1-x)*\mathrm{e}^{-x^2 - (y+1)^2} - 10*(\frac{x}{5} - x^3 - y^5)*\mathrm{e}^{-x^2-y^2} - \frac{1}{3}*\mathrm{e}^{-(x+1)^2-y^2}$$
多元函数求导

符号微分，表达式微分
符号求导，表达式求导

```{r}
peaks_fun <- expression(3*(1-x)*exp^(-x^2 - (y+1)^2) - 10*(x/5 - x^3 - y^5)*exp^(-x^2-y^2) -1/3*exp^(-(x+1)^2-y^2))
```

```{r}
D(peaks_fun, "x")
D(peaks_fun, "y")
```

- [An R package for optimization using genetic algorithms](https://github.com/luca-scr/GA)

复合函数求极值

```r
f <- function(y){
	g <- function(x){
	  integrate(function(t){ -sqrt(t)*exp(-t^2) },lower = 0,upper = x)$value
	}
  integrate(function(s){ g(s)*exp(-s) },lower = 0,upper = y)$value
}

# optimize(f,c(0,10),maximum = FALSE)

# optimize(f,c(0,10),maximum = FALSE)

x <- seq(from=0,to=100,length.out = 100)
fval <- rep(0,100)

for(i in seq(100)){
  fval[i] <- f(x[i])
}
plot(fval~x)
integrate(function(t){-sqrt(t)*exp(-t^2)},lower = 0,upper = 20)$value
```

<!--chapter:end:12-optimations.Rmd-->

```{r include=FALSE, cache=FALSE}
library(methods)
set.seed(2018)
options(digits = 3)

Pkgs <- c(
  "reticulate",
  "showtext", "sysfonts", "showtextdb",
  "fontcm",
  "tikzDevice", "filehash", "png",
  "xkcd", "extrafontdb", "Rttf2pt1", "extrafont"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}

if (!all(c("source-han-sans-cn", "source-han-serif-cn") %in% showtextdb::font_installed())) {
  showtextdb::font_install(showtextdb::source_han_serif("CN"))
  showtextdb::font_install(showtextdb::source_han_sans("CN"))
}
extrafont::font_install("fontcm")
extrafont::loadfonts()

if (!"xkcd" %in% extrafont::fonts()) {
  path <- path.expand("~/.fonts")
  if (!file.exists(path)) {
    dir.create(path = path.expand("~/.fonts"))
  }
  download.file("http://simonsoftware.se/other/xkcd.ttf", dest = path.expand("~/.fonts/xkcd.ttf"), mode = "wb")
  extrafont::font_import(paths = path.expand("~/.fonts"), pattern = "[X/x]kcd", prompt = FALSE)
  extrafont::loadfonts()
}

extrafont::fonts() # registered with pdfFonts()
sysfonts::font_families() # List available font families

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = TRUE,
  cache = TRUE,
  citation.bibtex.max=999,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  # fig.showtext = TRUE, # too danger
  fig.asp = 0.618, # 1 / phi
  # fig.show = "hold", # not for python matplotlib
  fig.ext = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  dev = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  engine.path = list(
    octave = "/usr/bin/octave-cli"
  )
)
ext <- if (knitr::is_html_output()) ".svg" else if (knitr::is_latex_output()) ".pdf" else ".png"

# knitr::knit_hooks$set(optipng = knitr::hook_optipng, pdfcrop = knitr::hook_pdfcrop)

# https://github.com/yihui/knitr-examples/blob/master/085-pdfcrop.Rnw
# knitr::knit_hooks$set(crop = hook_pdfcrop)
options(
  repos = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/",
  tikzDefaultEngine = "xetex",
  tikzXelatexPackages = c(
    getOption("tikzXelatexPackages"),
    "\\usepackage[colorlinks, breaklinks]{hyperref}",
    "\\usepackage{color}",
    "\\usepackage{tikz}",
    "\\usepackage[active,tightpage,xetex]{preview}",
    "\\PreviewEnvironment{pgfpicture}",
    "\\usepackage{amsmath}",
    "\\usepackage{amsfonts}",
    "\\usepackage{mathrsfs}"
  )
)
# https://github.com/yihui/knitr-examples/blob/master/047-tikz-png.Rnw
# knitr::knit_hooks$set(tikz2png = function(before, options, envir) {
  # use this hook only for dev='tikz' and externalized tikz graphics
  # if (before || options$dev != "tikz" || !options$external || options$fig.num == 0) return()
  # figs <- knitr:::all_figs(options, ext = "pdf") # all figure names
  # note the tikz2png option is the extra parameters passed to 'convert'
  # for (fig in figs) {
    # system(sprintf("convert %s %s %s", options$tikz2png, fig, sub("\\.pdf$", ".png", fig)))
  # }
# })


is_on_travis = identical(Sys.getenv("TRAVIS"), "true")
is_online = curl::has_internet()

library(reticulate)
if(is_on_travis) use_virtualenv("shims") else use_python("/usr/bin/python", required = FALSE)
# Python 环境的描述在附录
# required = FALSE 默认值，如果按照指定的位置没有找到 Python 就会扫描其它版本
# use_python("/opt/pyenv/shims/python")
# use_virtualenv("shims")

# 设置环境变量 RSTUDIO_CONNECT_SERVER 由 travis-ci 设置
connectServer <- Sys.getenv("RSTUDIO_CONNECT_SERVER") # https://bookdown.org
apiKey <- Sys.getenv("RSTUDIO_CONNECT_API_KEY")
```
# 随机模拟

## 随机数

产生重复的随机数，octave 实现，随机数生成的详细介绍请看统计之都文章 [随机数生成及其在统计模拟中的应用](https://cosx.org/2017/05/random-number-generation/)

```{octave, eval = .Platform$OS.type != "windows"}
%% copy from https://stackoverflow.com/questions/13735096/python-vs-octave-random-generator
function state = mtstate(seed)
state = uint32(zeros(625,1));
state(1) = uint32(seed);
for i=1:623,
   tmp = uint64(1812433253)*uint64(bitxor(state(i),bitshift(state(i),-30)))+i;
   state(i+1) = uint32(bitand(tmp,uint64(intmax('uint32'))));
end
state(625) = 1;
end

rand('state',mtstate(4));
rand(1,5)
rand('state',mtstate(4));
rand(1,5)
```

- [dqrng: Fast Pseudo Random Number Generators](https://github.com/daqana/dqrng)

## 随机过程

### 随机游走


### 遍历定理


### M-H 算法


### Gibbs 算法

### HMC 算法

汉密尔顿蒙特卡罗算法


## 分布式

### Rmpi

安装配置 <http://www.stats.uwo.ca/faculty/yu/Rmpi/>

### Rhpc

<https://prs.ism.ac.jp/~nakama/Rhpc/>

Function of apply style using 'MPI' provides better 'HPC' environment on R. And this package supports long vector, can deal with slightly big data.





<!--chapter:end:13-simulations.Rmd-->

```{r include=FALSE, cache=FALSE}
library(methods)
set.seed(2018)
options(digits = 3)

Pkgs <- c(
  "reticulate",
  "showtext", "sysfonts", "showtextdb",
  "fontcm",
  "tikzDevice", "filehash", "png",
  "xkcd", "extrafontdb", "Rttf2pt1", "extrafont"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}

if (!all(c("source-han-sans-cn", "source-han-serif-cn") %in% showtextdb::font_installed())) {
  showtextdb::font_install(showtextdb::source_han_serif("CN"))
  showtextdb::font_install(showtextdb::source_han_sans("CN"))
}
extrafont::font_install("fontcm")
extrafont::loadfonts()

if (!"xkcd" %in% extrafont::fonts()) {
  path <- path.expand("~/.fonts")
  if (!file.exists(path)) {
    dir.create(path = path.expand("~/.fonts"))
  }
  download.file("http://simonsoftware.se/other/xkcd.ttf", dest = path.expand("~/.fonts/xkcd.ttf"), mode = "wb")
  extrafont::font_import(paths = path.expand("~/.fonts"), pattern = "[X/x]kcd", prompt = FALSE)
  extrafont::loadfonts()
}

extrafont::fonts() # registered with pdfFonts()
sysfonts::font_families() # List available font families

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = TRUE,
  cache = TRUE,
  citation.bibtex.max=999,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  # fig.showtext = TRUE, # too danger
  fig.asp = 0.618, # 1 / phi
  # fig.show = "hold", # not for python matplotlib
  fig.ext = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  dev = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  engine.path = list(
    octave = "/usr/bin/octave-cli"
  )
)
ext <- if (knitr::is_html_output()) ".svg" else if (knitr::is_latex_output()) ".pdf" else ".png"

# knitr::knit_hooks$set(optipng = knitr::hook_optipng, pdfcrop = knitr::hook_pdfcrop)

# https://github.com/yihui/knitr-examples/blob/master/085-pdfcrop.Rnw
# knitr::knit_hooks$set(crop = hook_pdfcrop)
options(
  repos = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/",
  tikzDefaultEngine = "xetex",
  tikzXelatexPackages = c(
    getOption("tikzXelatexPackages"),
    "\\usepackage[colorlinks, breaklinks]{hyperref}",
    "\\usepackage{color}",
    "\\usepackage{tikz}",
    "\\usepackage[active,tightpage,xetex]{preview}",
    "\\PreviewEnvironment{pgfpicture}",
    "\\usepackage{amsmath}",
    "\\usepackage{amsfonts}",
    "\\usepackage{mathrsfs}"
  )
)
# https://github.com/yihui/knitr-examples/blob/master/047-tikz-png.Rnw
# knitr::knit_hooks$set(tikz2png = function(before, options, envir) {
  # use this hook only for dev='tikz' and externalized tikz graphics
  # if (before || options$dev != "tikz" || !options$external || options$fig.num == 0) return()
  # figs <- knitr:::all_figs(options, ext = "pdf") # all figure names
  # note the tikz2png option is the extra parameters passed to 'convert'
  # for (fig in figs) {
    # system(sprintf("convert %s %s %s", options$tikz2png, fig, sub("\\.pdf$", ".png", fig)))
  # }
# })


is_on_travis = identical(Sys.getenv("TRAVIS"), "true")
is_online = curl::has_internet()

library(reticulate)
if(is_on_travis) use_virtualenv("shims") else use_python("/usr/bin/python", required = FALSE)
# Python 环境的描述在附录
# required = FALSE 默认值，如果按照指定的位置没有找到 Python 就会扫描其它版本
# use_python("/opt/pyenv/shims/python")
# use_virtualenv("shims")

# 设置环境变量 RSTUDIO_CONNECT_SERVER 由 travis-ci 设置
connectServer <- Sys.getenv("RSTUDIO_CONNECT_SERVER") # https://bookdown.org
apiKey <- Sys.getenv("RSTUDIO_CONNECT_API_KEY")
```
# 贝叶斯计算 {#bayes}

```{r include=FALSE, eval=FALSE}
Pkgs <- c(
  "rstan", "rstanarm", "brms"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}
```

从 WinBUGS\index{WinBUGS} 到 OpenBUGS\index{OpenBUGS}，从 JAGS\index{JAGS} 到 Stan\index{Stan}，BUGS 的发展从未停止过，Stan^[<http://mc-stan.org/>] 是一个统计建模和高性能统计计算平台。

## BUGS 软件

最大后验估计，贝叶斯分层模型

## Stan 框架

- 安装

```bash
git clone --depth=1 --branch=develop --recursive git@github.com:stan-dev/rstan.git
# 若中间断了，则执行下一行
git submodule update --init --recursive
```

```r
# 安装新版 StanHeaders
path_rstan <- "/home/xyhuang/softwares/rstan/"
devtools::install(file.path(path_rstan, "StanHeaders"), args = "--preclean")
```

```bash
cd rstan # rstan 包目录
make build # build R包
make check # 检查R包
make install # 安装R包
```

```{r, out.width="20%", fig.cap="Stan 家族", echo=FALSE, eval=FALSE}
knitr::include_graphics(path = paste0(
  "images/",
  paste0(
    c("stan_logo", "rstan_logo", "pystan_logo"),
    if (knitr::is_latex_output()) ".eps" else ".svg"
  )
))
```

- [LOO for non-factorized normal models](https://github.com/paul-buerkner/non-factorized-loo)
- [Playing with negative binomial multilevel models in Stan](https://github.com/seananderson/negbin-stan)
- [An Introduction to Greta](https://rviews.rstudio.com/2018/04/23/on-first-meeting-greta/) tensoflow and stan

### PyStan 接口

```{python, eval=FALSE}
# 整合 Python 语言到 R Mrakdown 
import pystan
import numpy as np
import matplotlib.pyplot as plt

schools_code = """
data {
  int<lower=0> J; // number of schools
  real y[J]; // estimated treatment effects
  real<lower=0> sigma[J]; // s.e. of effect estimates
}
parameters {
  real mu;
  real<lower=0> tau;
  real eta[J];
}
transformed parameters {
  real theta[J];
  for (j in 1:J)
  theta[j] = mu + tau * eta[j];
}
model {
  eta ~ normal(0, 1);
  y ~ normal(theta, sigma);
}
"""

schools_dat = {'J': 8,
  'y': [28,  8, -3,  7, -1,  1, 18, 12],
  'sigma': [15, 10, 16, 11,  9, 11, 10, 18]}

sm = pystan.StanModel(model_code = schools_code)
fit = sm.sampling(data = schools_dat, iter = 1000, chains = 4)

print(fit)

eta = fit.extract(permuted=True)['eta']
np.mean(eta, axis=0)

## if matplotlib is installed (optional, not required), a visual summary and
## traceplot are available
# fit.plot()
# plt.show()
```

### RStan 接口

Stan 提供的R语言接口 rstan 包 [@R-rstan] 及其扩展 StanHeaders 包 [@R-StanHeaders] 、bayesplot包 [@R-bayesplot] 、brms 包 [@brms2017JSS]、 rstanarm 包 [@R-rstanarm]以及 rstan 的 wiki^[<https://github.com/stan-dev/rstan/wiki>] 及其在空间广义线性混合效应模型的参数估计和预测中的应用。

加载 rstan,如果你的电脑配置有多核处理器，内存也充足，那么可以考虑使用并行方式去估计你的模型参数，

```{r, eval=FALSE}
library(rstan)
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())

schools_dat <- list(J = 8, 
                    y = c(28,  8, -3,  7, -1,  1, 18, 12),
                    sigma = c(15, 10, 16, 11,  9, 11, 10, 18))
fit <- stan(file = 'data/8schools.stan', data = schools_dat, 
            iter = 1000, chains = 4)
print(fit)
plot(fit)
pairs(fit, pars = c("mu", "tau", "lp__"))

la <- extract(fit, permuted = TRUE) # return a list of arrays 
mu <- la$mu 

### return an array of three dimensions: iterations, chains, parameters 
a <- extract(fit, permuted = FALSE) 

### use S3 functions as.array (or as.matrix) on stanfit objects
a2 <- as.array(fit)
m <- as.matrix(fit)

print(fit, digits = 1)

schools_dat <- read_rdump('data/8schools.rdump')
source('data/8schools.rdump') 
fit <- stan(file = 'data/8schools.stan', iter = 1000, chains = 4)
```

1. Bayesian Data Analysis <https://github.com/avehtari/BDA_R_demos>
Bayesian Data Analysis, 3rd ed by Gelman, Carlin, Stern, Dunson, Vehtari, and Rubin (BDA3).

2. RStan Book <https://github.com/MatsuuraKentaro/RStanBook> 这是日文版

3. An Introduction to State Space Time Series Analysis <https://github.com/sinhrks/stan-statespace>
Stan models for state space time series

4. Draft introduction to probability and inference aimed at the Stan manual. <https://github.com/betanalpha/stan_intro>

5. [Bayesian Modeling using Stan](https://github.com/fonnesbeck/stan_workshop_2016)

6. Define Stan models using glmer-style (lme4) formulas <https://github.com/rmcelreath/glmer2stan>

7. [Examples of working and non-working models](https://github.com/sakrejda/stan-workshop)

8. State space models (dynamic linear models, hidden Markov models) implemented in Stan
<https://github.com/jrnold/ssmodels-in-stan>

9. State Space Models in Stan <https://jrnold.github.io/ssmodels-in-stan/>

10. Conditional autoregressive models in Stan <https://github.com/mbjoseph/CARstan>

11. Implementation of B-Splines in Stan <https://github.com/milkha/Splines_in_Stan>

12. 相依对数正态模型 <https://magesblog.com/post/correlated-lognormal-chain-ladder-model/>


<!--chapter:end:14-bayesians.Rmd-->

```{r include=FALSE, cache=FALSE}
library(methods)
set.seed(2018)
options(digits = 3)

Pkgs <- c(
  "reticulate",
  "showtext", "sysfonts", "showtextdb",
  "fontcm",
  "tikzDevice", "filehash", "png",
  "xkcd", "extrafontdb", "Rttf2pt1", "extrafont"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}

if (!all(c("source-han-sans-cn", "source-han-serif-cn") %in% showtextdb::font_installed())) {
  showtextdb::font_install(showtextdb::source_han_serif("CN"))
  showtextdb::font_install(showtextdb::source_han_sans("CN"))
}
extrafont::font_install("fontcm")
extrafont::loadfonts()

if (!"xkcd" %in% extrafont::fonts()) {
  path <- path.expand("~/.fonts")
  if (!file.exists(path)) {
    dir.create(path = path.expand("~/.fonts"))
  }
  download.file("http://simonsoftware.se/other/xkcd.ttf", dest = path.expand("~/.fonts/xkcd.ttf"), mode = "wb")
  extrafont::font_import(paths = path.expand("~/.fonts"), pattern = "[X/x]kcd", prompt = FALSE)
  extrafont::loadfonts()
}

extrafont::fonts() # registered with pdfFonts()
sysfonts::font_families() # List available font families

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = TRUE,
  cache = TRUE,
  citation.bibtex.max=999,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  # fig.showtext = TRUE, # too danger
  fig.asp = 0.618, # 1 / phi
  # fig.show = "hold", # not for python matplotlib
  fig.ext = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  dev = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  engine.path = list(
    octave = "/usr/bin/octave-cli"
  )
)
ext <- if (knitr::is_html_output()) ".svg" else if (knitr::is_latex_output()) ".pdf" else ".png"

# knitr::knit_hooks$set(optipng = knitr::hook_optipng, pdfcrop = knitr::hook_pdfcrop)

# https://github.com/yihui/knitr-examples/blob/master/085-pdfcrop.Rnw
# knitr::knit_hooks$set(crop = hook_pdfcrop)
options(
  repos = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/",
  tikzDefaultEngine = "xetex",
  tikzXelatexPackages = c(
    getOption("tikzXelatexPackages"),
    "\\usepackage[colorlinks, breaklinks]{hyperref}",
    "\\usepackage{color}",
    "\\usepackage{tikz}",
    "\\usepackage[active,tightpage,xetex]{preview}",
    "\\PreviewEnvironment{pgfpicture}",
    "\\usepackage{amsmath}",
    "\\usepackage{amsfonts}",
    "\\usepackage{mathrsfs}"
  )
)
# https://github.com/yihui/knitr-examples/blob/master/047-tikz-png.Rnw
# knitr::knit_hooks$set(tikz2png = function(before, options, envir) {
  # use this hook only for dev='tikz' and externalized tikz graphics
  # if (before || options$dev != "tikz" || !options$external || options$fig.num == 0) return()
  # figs <- knitr:::all_figs(options, ext = "pdf") # all figure names
  # note the tikz2png option is the extra parameters passed to 'convert'
  # for (fig in figs) {
    # system(sprintf("convert %s %s %s", options$tikz2png, fig, sub("\\.pdf$", ".png", fig)))
  # }
# })


is_on_travis = identical(Sys.getenv("TRAVIS"), "true")
is_online = curl::has_internet()

library(reticulate)
if(is_on_travis) use_virtualenv("shims") else use_python("/usr/bin/python", required = FALSE)
# Python 环境的描述在附录
# required = FALSE 默认值，如果按照指定的位置没有找到 Python 就会扫描其它版本
# use_python("/opt/pyenv/shims/python")
# use_virtualenv("shims")

# 设置环境变量 RSTUDIO_CONNECT_SERVER 由 travis-ci 设置
connectServer <- Sys.getenv("RSTUDIO_CONNECT_SERVER") # https://bookdown.org
apiKey <- Sys.getenv("RSTUDIO_CONNECT_API_KEY")
```
# 近似推断 {#r-inla}

```{r include=FALSE, eval=FALSE}
Pkgs <- c(
  "Rgraphviz", "graph"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  ## try http:// if https:// URLs are not supported
  source("https://bioconductor.org/biocLite.R")
  biocLite(c("Rgraphviz", "graph"), ask = FALSE)
}
Pkgs <- c(
  "INLA"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages("INLA", repos = c(getOption("repos"),
    INLA = "https://inla.r-inla-download.org/R/stable"
  ), dep = TRUE)
}
```

INLA 材料

- A gentle INLA tutorial <https://www.precision-analytics.ca/blog-1/inla>
- A Gentle Stan vs. INLA Comparison <http://www.martinmodrak.cz/2018/02/02/a-gentle-stan-vs.-inla-comparison/>
- 探讨算法比较 <http://discourse.mc-stan.org/t/blog-a-gentle-stan-to-inla-comparison/3205>
- GPstuff: Gaussian process models for Bayesian analysis  <http://research.cs.aalto.fi/pml/software/gpstuff/>
- GPstuff: 高斯过程模型与空间数据分析工具箱[@GPstuff2013JMLR] 适用于 Matlab/Octave 和 R

## 高斯-马尔科夫随机场


## 贝叶斯近似推断

随机偏微分方程，高维积分，拉普拉斯近似


<!--chapter:end:15-approximations.Rmd-->

```{r include=FALSE, cache=FALSE}
library(methods)
set.seed(2018)
options(digits = 3)

Pkgs <- c(
  "reticulate",
  "showtext", "sysfonts", "showtextdb",
  "fontcm",
  "tikzDevice", "filehash", "png",
  "xkcd", "extrafontdb", "Rttf2pt1", "extrafont"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}

if (!all(c("source-han-sans-cn", "source-han-serif-cn") %in% showtextdb::font_installed())) {
  showtextdb::font_install(showtextdb::source_han_serif("CN"))
  showtextdb::font_install(showtextdb::source_han_sans("CN"))
}
extrafont::font_install("fontcm")
extrafont::loadfonts()

if (!"xkcd" %in% extrafont::fonts()) {
  path <- path.expand("~/.fonts")
  if (!file.exists(path)) {
    dir.create(path = path.expand("~/.fonts"))
  }
  download.file("http://simonsoftware.se/other/xkcd.ttf", dest = path.expand("~/.fonts/xkcd.ttf"), mode = "wb")
  extrafont::font_import(paths = path.expand("~/.fonts"), pattern = "[X/x]kcd", prompt = FALSE)
  extrafont::loadfonts()
}

extrafont::fonts() # registered with pdfFonts()
sysfonts::font_families() # List available font families

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = TRUE,
  cache = TRUE,
  citation.bibtex.max=999,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  # fig.showtext = TRUE, # too danger
  fig.asp = 0.618, # 1 / phi
  # fig.show = "hold", # not for python matplotlib
  fig.ext = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  dev = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  engine.path = list(
    octave = "/usr/bin/octave-cli"
  )
)
ext <- if (knitr::is_html_output()) ".svg" else if (knitr::is_latex_output()) ".pdf" else ".png"

# knitr::knit_hooks$set(optipng = knitr::hook_optipng, pdfcrop = knitr::hook_pdfcrop)

# https://github.com/yihui/knitr-examples/blob/master/085-pdfcrop.Rnw
# knitr::knit_hooks$set(crop = hook_pdfcrop)
options(
  repos = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/",
  tikzDefaultEngine = "xetex",
  tikzXelatexPackages = c(
    getOption("tikzXelatexPackages"),
    "\\usepackage[colorlinks, breaklinks]{hyperref}",
    "\\usepackage{color}",
    "\\usepackage{tikz}",
    "\\usepackage[active,tightpage,xetex]{preview}",
    "\\PreviewEnvironment{pgfpicture}",
    "\\usepackage{amsmath}",
    "\\usepackage{amsfonts}",
    "\\usepackage{mathrsfs}"
  )
)
# https://github.com/yihui/knitr-examples/blob/master/047-tikz-png.Rnw
# knitr::knit_hooks$set(tikz2png = function(before, options, envir) {
  # use this hook only for dev='tikz' and externalized tikz graphics
  # if (before || options$dev != "tikz" || !options$external || options$fig.num == 0) return()
  # figs <- knitr:::all_figs(options, ext = "pdf") # all figure names
  # note the tikz2png option is the extra parameters passed to 'convert'
  # for (fig in figs) {
    # system(sprintf("convert %s %s %s", options$tikz2png, fig, sub("\\.pdf$", ".png", fig)))
  # }
# })


is_on_travis = identical(Sys.getenv("TRAVIS"), "true")
is_online = curl::has_internet()

library(reticulate)
if(is_on_travis) use_virtualenv("shims") else use_python("/usr/bin/python", required = FALSE)
# Python 环境的描述在附录
# required = FALSE 默认值，如果按照指定的位置没有找到 Python 就会扫描其它版本
# use_python("/opt/pyenv/shims/python")
# use_virtualenv("shims")

# 设置环境变量 RSTUDIO_CONNECT_SERVER 由 travis-ci 设置
connectServer <- Sys.getenv("RSTUDIO_CONNECT_SERVER") # https://bookdown.org
apiKey <- Sys.getenv("RSTUDIO_CONNECT_API_KEY")
```
# (PART) 数据分析 {-}

<!--chapter:end:Cases.Rmd-->

```{r include=FALSE, cache=FALSE}
library(methods)
set.seed(2018)
options(digits = 3)

Pkgs <- c(
  "reticulate",
  "showtext", "sysfonts", "showtextdb",
  "fontcm",
  "tikzDevice", "filehash", "png",
  "xkcd", "extrafontdb", "Rttf2pt1", "extrafont"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}

if (!all(c("source-han-sans-cn", "source-han-serif-cn") %in% showtextdb::font_installed())) {
  showtextdb::font_install(showtextdb::source_han_serif("CN"))
  showtextdb::font_install(showtextdb::source_han_sans("CN"))
}
extrafont::font_install("fontcm")
extrafont::loadfonts()

if (!"xkcd" %in% extrafont::fonts()) {
  path <- path.expand("~/.fonts")
  if (!file.exists(path)) {
    dir.create(path = path.expand("~/.fonts"))
  }
  download.file("http://simonsoftware.se/other/xkcd.ttf", dest = path.expand("~/.fonts/xkcd.ttf"), mode = "wb")
  extrafont::font_import(paths = path.expand("~/.fonts"), pattern = "[X/x]kcd", prompt = FALSE)
  extrafont::loadfonts()
}

extrafont::fonts() # registered with pdfFonts()
sysfonts::font_families() # List available font families

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = TRUE,
  cache = TRUE,
  citation.bibtex.max=999,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  # fig.showtext = TRUE, # too danger
  fig.asp = 0.618, # 1 / phi
  # fig.show = "hold", # not for python matplotlib
  fig.ext = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  dev = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  engine.path = list(
    octave = "/usr/bin/octave-cli"
  )
)
ext <- if (knitr::is_html_output()) ".svg" else if (knitr::is_latex_output()) ".pdf" else ".png"

# knitr::knit_hooks$set(optipng = knitr::hook_optipng, pdfcrop = knitr::hook_pdfcrop)

# https://github.com/yihui/knitr-examples/blob/master/085-pdfcrop.Rnw
# knitr::knit_hooks$set(crop = hook_pdfcrop)
options(
  repos = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/",
  tikzDefaultEngine = "xetex",
  tikzXelatexPackages = c(
    getOption("tikzXelatexPackages"),
    "\\usepackage[colorlinks, breaklinks]{hyperref}",
    "\\usepackage{color}",
    "\\usepackage{tikz}",
    "\\usepackage[active,tightpage,xetex]{preview}",
    "\\PreviewEnvironment{pgfpicture}",
    "\\usepackage{amsmath}",
    "\\usepackage{amsfonts}",
    "\\usepackage{mathrsfs}"
  )
)
# https://github.com/yihui/knitr-examples/blob/master/047-tikz-png.Rnw
# knitr::knit_hooks$set(tikz2png = function(before, options, envir) {
  # use this hook only for dev='tikz' and externalized tikz graphics
  # if (before || options$dev != "tikz" || !options$external || options$fig.num == 0) return()
  # figs <- knitr:::all_figs(options, ext = "pdf") # all figure names
  # note the tikz2png option is the extra parameters passed to 'convert'
  # for (fig in figs) {
    # system(sprintf("convert %s %s %s", options$tikz2png, fig, sub("\\.pdf$", ".png", fig)))
  # }
# })


is_on_travis = identical(Sys.getenv("TRAVIS"), "true")
is_online = curl::has_internet()

library(reticulate)
if(is_on_travis) use_virtualenv("shims") else use_python("/usr/bin/python", required = FALSE)
# Python 环境的描述在附录
# required = FALSE 默认值，如果按照指定的位置没有找到 Python 就会扫描其它版本
# use_python("/opt/pyenv/shims/python")
# use_virtualenv("shims")

# 设置环境变量 RSTUDIO_CONNECT_SERVER 由 travis-ci 设置
connectServer <- Sys.getenv("RSTUDIO_CONNECT_SERVER") # https://bookdown.org
apiKey <- Sys.getenv("RSTUDIO_CONNECT_API_KEY")
```
# 空间数据 {#spatial}

```{r include = FALSE, eval=FALSE}
Pkgs <- c(
  "sf", "tmap", "rgdal", "PrevMap"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}
```

## 分析与可视化

Here is a review of existing methods.


## sf

```{r, eval=FALSE}
library(sf)
```


- Intro to Geospatial Data with R <http://www.datacarpentry.org/r-raster-vector-geospatial/>

## PrevMap

```{r, eval=FALSE}
library(PrevMap)
```


案例

```{r, eval=FALSE}
library(HSAR)

data(Beijingdistricts)

library(spdep)
plot(Beijingdistricts,border="light grey")
# extract the area of each district
library(rgeos)
library(classInt)
library(RColorBrewer)

Beijingdistricts$geo.area <- gArea(Beijingdistricts,byid=TRUE) / 1000000
x <- Beijingdistricts$geo.area
breaks <- classIntervals(x,4,"fisher")$brks
groups <- cut(x,breaks,include.lowest=TRUE,labels=FALSE)
palette <- brewer.pal(4, "Blues")
plot(Beijingdistricts,col=palette[groups],border="grey")

# extract the district level spatial weights matrix
nb.list <- poly2nb(Beijingdistricts,queen=FALSE)
mat.list <- nb2mat(nb.list,style="W")
M <- as(mat.list,"dgCMatrix")
```



空间数据分析

to think about, not sure if needed but then this would be a good place to point out why our book might have advantages over other books. Compare with:
- Bivand, R., Pebesma, E., Gomez-Rubio, V. (2013): Applied spatial data analysis with R.
- Blangiardo, M. & Cameletti, M. (2015): Spatial and spatio-temporal Bayesian models with R - INLA.
- Brunsdon, C. & Comber, L. (2015): An introduction to R for spatial analysis and mapping.
- Dorman, M. (2014): Learning R for geospatial analysis.
- Hijmans, R. (2016): Spatial data analysis and modeling with R.  http://rspatial.org/intr/index.html (haven't read it but might be more suitable for beginners, however, it does not consider sf; additionally, it provides more code than text, and hence, probably less explanations than our book) 
- Quiang, S. (2016): Environmental and Ecological Statistics with R (not really a competitor, I have ordered a copy, this book is really about modeling, and I would rather prefer the Zuur et al. books over it)
- Wegmann, M., Leutner, B., Dech, S. (2016): Remote Sensing and GIS for ecologists: Using Open Source Software.
- Zuur, A., Ieno, E., Saveliev, A. (2017): Beginner's guide to spatial, temporal and spatial-temporal ecological data analysis with R-INLA.

Put the competing books into categories, e.g., introduction to spatial analysis (Brundsdon, Dorman, Hijmans), advanced spatial analysis (Bivand), topical spatial analysis (Quiang, Wegmann),  (mainly) spatial modeling (Bivand, Blangiardo, Hijmans, Quiang, Zuur).
Point out where our book fits in and which gap it is filling -> somewhere between advanced (but not that hard) and spatial modeling with a broad range of topics (not just one like ecology).
We try to address a broad audiecence with an interest in spatial data, and how things can be **get done**, not just theoretically but in an applied way.
On the other hand, we embed the shown methods into the bigger field of GIScience, provide context and refer to further literature for the interested reader.

<!--chapter:end:16-spatial.Rmd-->

```{r include=FALSE, cache=FALSE}
library(methods)
set.seed(2018)
options(digits = 3)

Pkgs <- c(
  "reticulate",
  "showtext", "sysfonts", "showtextdb",
  "fontcm",
  "tikzDevice", "filehash", "png",
  "xkcd", "extrafontdb", "Rttf2pt1", "extrafont"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}

if (!all(c("source-han-sans-cn", "source-han-serif-cn") %in% showtextdb::font_installed())) {
  showtextdb::font_install(showtextdb::source_han_serif("CN"))
  showtextdb::font_install(showtextdb::source_han_sans("CN"))
}
extrafont::font_install("fontcm")
extrafont::loadfonts()

if (!"xkcd" %in% extrafont::fonts()) {
  path <- path.expand("~/.fonts")
  if (!file.exists(path)) {
    dir.create(path = path.expand("~/.fonts"))
  }
  download.file("http://simonsoftware.se/other/xkcd.ttf", dest = path.expand("~/.fonts/xkcd.ttf"), mode = "wb")
  extrafont::font_import(paths = path.expand("~/.fonts"), pattern = "[X/x]kcd", prompt = FALSE)
  extrafont::loadfonts()
}

extrafont::fonts() # registered with pdfFonts()
sysfonts::font_families() # List available font families

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = TRUE,
  cache = TRUE,
  citation.bibtex.max=999,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  # fig.showtext = TRUE, # too danger
  fig.asp = 0.618, # 1 / phi
  # fig.show = "hold", # not for python matplotlib
  fig.ext = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  dev = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  engine.path = list(
    octave = "/usr/bin/octave-cli"
  )
)
ext <- if (knitr::is_html_output()) ".svg" else if (knitr::is_latex_output()) ".pdf" else ".png"

# knitr::knit_hooks$set(optipng = knitr::hook_optipng, pdfcrop = knitr::hook_pdfcrop)

# https://github.com/yihui/knitr-examples/blob/master/085-pdfcrop.Rnw
# knitr::knit_hooks$set(crop = hook_pdfcrop)
options(
  repos = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/",
  tikzDefaultEngine = "xetex",
  tikzXelatexPackages = c(
    getOption("tikzXelatexPackages"),
    "\\usepackage[colorlinks, breaklinks]{hyperref}",
    "\\usepackage{color}",
    "\\usepackage{tikz}",
    "\\usepackage[active,tightpage,xetex]{preview}",
    "\\PreviewEnvironment{pgfpicture}",
    "\\usepackage{amsmath}",
    "\\usepackage{amsfonts}",
    "\\usepackage{mathrsfs}"
  )
)
# https://github.com/yihui/knitr-examples/blob/master/047-tikz-png.Rnw
# knitr::knit_hooks$set(tikz2png = function(before, options, envir) {
  # use this hook only for dev='tikz' and externalized tikz graphics
  # if (before || options$dev != "tikz" || !options$external || options$fig.num == 0) return()
  # figs <- knitr:::all_figs(options, ext = "pdf") # all figure names
  # note the tikz2png option is the extra parameters passed to 'convert'
  # for (fig in figs) {
    # system(sprintf("convert %s %s %s", options$tikz2png, fig, sub("\\.pdf$", ".png", fig)))
  # }
# })


is_on_travis = identical(Sys.getenv("TRAVIS"), "true")
is_online = curl::has_internet()

library(reticulate)
if(is_on_travis) use_virtualenv("shims") else use_python("/usr/bin/python", required = FALSE)
# Python 环境的描述在附录
# required = FALSE 默认值，如果按照指定的位置没有找到 Python 就会扫描其它版本
# use_python("/opt/pyenv/shims/python")
# use_virtualenv("shims")

# 设置环境变量 RSTUDIO_CONNECT_SERVER 由 travis-ci 设置
connectServer <- Sys.getenv("RSTUDIO_CONNECT_SERVER") # https://bookdown.org
apiKey <- Sys.getenv("RSTUDIO_CONNECT_API_KEY")
```
# 网络数据 {#network}

We describe our methods in this chapter.

## 分析与可视化


- <http://www.htmlwidgets.org/> R 与 JavaScript
- <https://github.com/rich-iannone/DiagrammeR>
- 分析 <https://github.com/igraph/python-igraph> 与 <https://github.com/igraph/rigraph>


## gephi


<!--chapter:end:17-network.Rmd-->

```{r include=FALSE, cache=FALSE}
library(methods)
set.seed(2018)
options(digits = 3)

Pkgs <- c(
  "reticulate",
  "showtext", "sysfonts", "showtextdb",
  "fontcm",
  "tikzDevice", "filehash", "png",
  "xkcd", "extrafontdb", "Rttf2pt1", "extrafont"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}

if (!all(c("source-han-sans-cn", "source-han-serif-cn") %in% showtextdb::font_installed())) {
  showtextdb::font_install(showtextdb::source_han_serif("CN"))
  showtextdb::font_install(showtextdb::source_han_sans("CN"))
}
extrafont::font_install("fontcm")
extrafont::loadfonts()

if (!"xkcd" %in% extrafont::fonts()) {
  path <- path.expand("~/.fonts")
  if (!file.exists(path)) {
    dir.create(path = path.expand("~/.fonts"))
  }
  download.file("http://simonsoftware.se/other/xkcd.ttf", dest = path.expand("~/.fonts/xkcd.ttf"), mode = "wb")
  extrafont::font_import(paths = path.expand("~/.fonts"), pattern = "[X/x]kcd", prompt = FALSE)
  extrafont::loadfonts()
}

extrafont::fonts() # registered with pdfFonts()
sysfonts::font_families() # List available font families

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = TRUE,
  cache = TRUE,
  citation.bibtex.max=999,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  # fig.showtext = TRUE, # too danger
  fig.asp = 0.618, # 1 / phi
  # fig.show = "hold", # not for python matplotlib
  fig.ext = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  dev = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  engine.path = list(
    octave = "/usr/bin/octave-cli"
  )
)
ext <- if (knitr::is_html_output()) ".svg" else if (knitr::is_latex_output()) ".pdf" else ".png"

# knitr::knit_hooks$set(optipng = knitr::hook_optipng, pdfcrop = knitr::hook_pdfcrop)

# https://github.com/yihui/knitr-examples/blob/master/085-pdfcrop.Rnw
# knitr::knit_hooks$set(crop = hook_pdfcrop)
options(
  repos = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/",
  tikzDefaultEngine = "xetex",
  tikzXelatexPackages = c(
    getOption("tikzXelatexPackages"),
    "\\usepackage[colorlinks, breaklinks]{hyperref}",
    "\\usepackage{color}",
    "\\usepackage{tikz}",
    "\\usepackage[active,tightpage,xetex]{preview}",
    "\\PreviewEnvironment{pgfpicture}",
    "\\usepackage{amsmath}",
    "\\usepackage{amsfonts}",
    "\\usepackage{mathrsfs}"
  )
)
# https://github.com/yihui/knitr-examples/blob/master/047-tikz-png.Rnw
# knitr::knit_hooks$set(tikz2png = function(before, options, envir) {
  # use this hook only for dev='tikz' and externalized tikz graphics
  # if (before || options$dev != "tikz" || !options$external || options$fig.num == 0) return()
  # figs <- knitr:::all_figs(options, ext = "pdf") # all figure names
  # note the tikz2png option is the extra parameters passed to 'convert'
  # for (fig in figs) {
    # system(sprintf("convert %s %s %s", options$tikz2png, fig, sub("\\.pdf$", ".png", fig)))
  # }
# })


is_on_travis = identical(Sys.getenv("TRAVIS"), "true")
is_online = curl::has_internet()

library(reticulate)
if(is_on_travis) use_virtualenv("shims") else use_python("/usr/bin/python", required = FALSE)
# Python 环境的描述在附录
# required = FALSE 默认值，如果按照指定的位置没有找到 Python 就会扫描其它版本
# use_python("/opt/pyenv/shims/python")
# use_virtualenv("shims")

# 设置环境变量 RSTUDIO_CONNECT_SERVER 由 travis-ci 设置
connectServer <- Sys.getenv("RSTUDIO_CONNECT_SERVER") # https://bookdown.org
apiKey <- Sys.getenv("RSTUDIO_CONNECT_API_KEY")
```
# (PART) 统计模型 {-}

<!--chapter:end:Models.Rmd-->

```{r include=FALSE, cache=FALSE}
library(methods)
set.seed(2018)
options(digits = 3)

Pkgs <- c(
  "reticulate",
  "showtext", "sysfonts", "showtextdb",
  "fontcm",
  "tikzDevice", "filehash", "png",
  "xkcd", "extrafontdb", "Rttf2pt1", "extrafont"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}

if (!all(c("source-han-sans-cn", "source-han-serif-cn") %in% showtextdb::font_installed())) {
  showtextdb::font_install(showtextdb::source_han_serif("CN"))
  showtextdb::font_install(showtextdb::source_han_sans("CN"))
}
extrafont::font_install("fontcm")
extrafont::loadfonts()

if (!"xkcd" %in% extrafont::fonts()) {
  path <- path.expand("~/.fonts")
  if (!file.exists(path)) {
    dir.create(path = path.expand("~/.fonts"))
  }
  download.file("http://simonsoftware.se/other/xkcd.ttf", dest = path.expand("~/.fonts/xkcd.ttf"), mode = "wb")
  extrafont::font_import(paths = path.expand("~/.fonts"), pattern = "[X/x]kcd", prompt = FALSE)
  extrafont::loadfonts()
}

extrafont::fonts() # registered with pdfFonts()
sysfonts::font_families() # List available font families

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = TRUE,
  cache = TRUE,
  citation.bibtex.max=999,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  # fig.showtext = TRUE, # too danger
  fig.asp = 0.618, # 1 / phi
  # fig.show = "hold", # not for python matplotlib
  fig.ext = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  dev = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  engine.path = list(
    octave = "/usr/bin/octave-cli"
  )
)
ext <- if (knitr::is_html_output()) ".svg" else if (knitr::is_latex_output()) ".pdf" else ".png"

# knitr::knit_hooks$set(optipng = knitr::hook_optipng, pdfcrop = knitr::hook_pdfcrop)

# https://github.com/yihui/knitr-examples/blob/master/085-pdfcrop.Rnw
# knitr::knit_hooks$set(crop = hook_pdfcrop)
options(
  repos = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/",
  tikzDefaultEngine = "xetex",
  tikzXelatexPackages = c(
    getOption("tikzXelatexPackages"),
    "\\usepackage[colorlinks, breaklinks]{hyperref}",
    "\\usepackage{color}",
    "\\usepackage{tikz}",
    "\\usepackage[active,tightpage,xetex]{preview}",
    "\\PreviewEnvironment{pgfpicture}",
    "\\usepackage{amsmath}",
    "\\usepackage{amsfonts}",
    "\\usepackage{mathrsfs}"
  )
)
# https://github.com/yihui/knitr-examples/blob/master/047-tikz-png.Rnw
# knitr::knit_hooks$set(tikz2png = function(before, options, envir) {
  # use this hook only for dev='tikz' and externalized tikz graphics
  # if (before || options$dev != "tikz" || !options$external || options$fig.num == 0) return()
  # figs <- knitr:::all_figs(options, ext = "pdf") # all figure names
  # note the tikz2png option is the extra parameters passed to 'convert'
  # for (fig in figs) {
    # system(sprintf("convert %s %s %s", options$tikz2png, fig, sub("\\.pdf$", ".png", fig)))
  # }
# })


is_on_travis = identical(Sys.getenv("TRAVIS"), "true")
is_online = curl::has_internet()

library(reticulate)
if(is_on_travis) use_virtualenv("shims") else use_python("/usr/bin/python", required = FALSE)
# Python 环境的描述在附录
# required = FALSE 默认值，如果按照指定的位置没有找到 Python 就会扫描其它版本
# use_python("/opt/pyenv/shims/python")
# use_virtualenv("shims")

# 设置环境变量 RSTUDIO_CONNECT_SERVER 由 travis-ci 设置
connectServer <- Sys.getenv("RSTUDIO_CONNECT_SERVER") # https://bookdown.org
apiKey <- Sys.getenv("RSTUDIO_CONNECT_API_KEY")
```
# 广义线性模型 {#glm}

通过先回顾线性模型相关知识，过渡到广义线性模型


## 线性模型

### 参数估计


### 最小二乘


### 最大似然


## 参数估计

### 最小二乘估计

glm

### 广义最小二乘估计

gls

### 最大似然估计



## 高维问题

- Statistical Inference and Sure Independence Screening via Ball Statistics [Ball](https://github.com/Mamba413/Ball)
- SIS: Sure Independence Screening [SIS](https://mirrors.tuna.tsinghua.edu.cn/CRAN/web/packages/SIS/index.html)

<!--chapter:end:18-glm.Rmd-->

```{r include=FALSE, cache=FALSE}
library(methods)
set.seed(2018)
options(digits = 3)

Pkgs <- c(
  "reticulate",
  "showtext", "sysfonts", "showtextdb",
  "fontcm",
  "tikzDevice", "filehash", "png",
  "xkcd", "extrafontdb", "Rttf2pt1", "extrafont"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}

if (!all(c("source-han-sans-cn", "source-han-serif-cn") %in% showtextdb::font_installed())) {
  showtextdb::font_install(showtextdb::source_han_serif("CN"))
  showtextdb::font_install(showtextdb::source_han_sans("CN"))
}
extrafont::font_install("fontcm")
extrafont::loadfonts()

if (!"xkcd" %in% extrafont::fonts()) {
  path <- path.expand("~/.fonts")
  if (!file.exists(path)) {
    dir.create(path = path.expand("~/.fonts"))
  }
  download.file("http://simonsoftware.se/other/xkcd.ttf", dest = path.expand("~/.fonts/xkcd.ttf"), mode = "wb")
  extrafont::font_import(paths = path.expand("~/.fonts"), pattern = "[X/x]kcd", prompt = FALSE)
  extrafont::loadfonts()
}

extrafont::fonts() # registered with pdfFonts()
sysfonts::font_families() # List available font families

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = TRUE,
  cache = TRUE,
  citation.bibtex.max=999,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  # fig.showtext = TRUE, # too danger
  fig.asp = 0.618, # 1 / phi
  # fig.show = "hold", # not for python matplotlib
  fig.ext = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  dev = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  engine.path = list(
    octave = "/usr/bin/octave-cli"
  )
)
ext <- if (knitr::is_html_output()) ".svg" else if (knitr::is_latex_output()) ".pdf" else ".png"

# knitr::knit_hooks$set(optipng = knitr::hook_optipng, pdfcrop = knitr::hook_pdfcrop)

# https://github.com/yihui/knitr-examples/blob/master/085-pdfcrop.Rnw
# knitr::knit_hooks$set(crop = hook_pdfcrop)
options(
  repos = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/",
  tikzDefaultEngine = "xetex",
  tikzXelatexPackages = c(
    getOption("tikzXelatexPackages"),
    "\\usepackage[colorlinks, breaklinks]{hyperref}",
    "\\usepackage{color}",
    "\\usepackage{tikz}",
    "\\usepackage[active,tightpage,xetex]{preview}",
    "\\PreviewEnvironment{pgfpicture}",
    "\\usepackage{amsmath}",
    "\\usepackage{amsfonts}",
    "\\usepackage{mathrsfs}"
  )
)
# https://github.com/yihui/knitr-examples/blob/master/047-tikz-png.Rnw
# knitr::knit_hooks$set(tikz2png = function(before, options, envir) {
  # use this hook only for dev='tikz' and externalized tikz graphics
  # if (before || options$dev != "tikz" || !options$external || options$fig.num == 0) return()
  # figs <- knitr:::all_figs(options, ext = "pdf") # all figure names
  # note the tikz2png option is the extra parameters passed to 'convert'
  # for (fig in figs) {
    # system(sprintf("convert %s %s %s", options$tikz2png, fig, sub("\\.pdf$", ".png", fig)))
  # }
# })


is_on_travis = identical(Sys.getenv("TRAVIS"), "true")
is_online = curl::has_internet()

library(reticulate)
if(is_on_travis) use_virtualenv("shims") else use_python("/usr/bin/python", required = FALSE)
# Python 环境的描述在附录
# required = FALSE 默认值，如果按照指定的位置没有找到 Python 就会扫描其它版本
# use_python("/opt/pyenv/shims/python")
# use_virtualenv("shims")

# 设置环境变量 RSTUDIO_CONNECT_SERVER 由 travis-ci 设置
connectServer <- Sys.getenv("RSTUDIO_CONNECT_SERVER") # https://bookdown.org
apiKey <- Sys.getenv("RSTUDIO_CONNECT_API_KEY")
```
# 混合效应模型 {#mixed-model}

## 方差分析

估计




## 线性混合效应模型

lme4: An R package for fitting and analyzing linear, nonlinear and generalized linear mixed models. 
[github](https://github.com/lme4/lme4/)  <http://lme4.r-forge.r-project.org/>

## 广义线性混合效应模型

材料

- fitting mixed models with (temporal) correlations in R 时间相依的结构的 GLMMs及其实现 [作者 Github](https://github.com/bbolker) 主页 <https://bbolker.github.io/mixedmodels-misc/notes/corr_braindump.html>

- Broadening Your Statistical Horizons: Generalized Linear Models and Multilevel Models <https://bookdown.org/roback/bookdown-bysh/>

## 空间广义线性混合效应模型


## 参数估计

### 限制极大似然估计


### profile 似然估计

### 贝叶斯估计


## 高维问题

<!--chapter:end:19-glmm.Rmd-->

```{r include=FALSE, cache=FALSE}
library(methods)
set.seed(2018)
options(digits = 3)

Pkgs <- c(
  "reticulate",
  "showtext", "sysfonts", "showtextdb",
  "fontcm",
  "tikzDevice", "filehash", "png",
  "xkcd", "extrafontdb", "Rttf2pt1", "extrafont"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}

if (!all(c("source-han-sans-cn", "source-han-serif-cn") %in% showtextdb::font_installed())) {
  showtextdb::font_install(showtextdb::source_han_serif("CN"))
  showtextdb::font_install(showtextdb::source_han_sans("CN"))
}
extrafont::font_install("fontcm")
extrafont::loadfonts()

if (!"xkcd" %in% extrafont::fonts()) {
  path <- path.expand("~/.fonts")
  if (!file.exists(path)) {
    dir.create(path = path.expand("~/.fonts"))
  }
  download.file("http://simonsoftware.se/other/xkcd.ttf", dest = path.expand("~/.fonts/xkcd.ttf"), mode = "wb")
  extrafont::font_import(paths = path.expand("~/.fonts"), pattern = "[X/x]kcd", prompt = FALSE)
  extrafont::loadfonts()
}

extrafont::fonts() # registered with pdfFonts()
sysfonts::font_families() # List available font families

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = TRUE,
  cache = TRUE,
  citation.bibtex.max=999,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  # fig.showtext = TRUE, # too danger
  fig.asp = 0.618, # 1 / phi
  # fig.show = "hold", # not for python matplotlib
  fig.ext = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  dev = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  engine.path = list(
    octave = "/usr/bin/octave-cli"
  )
)
ext <- if (knitr::is_html_output()) ".svg" else if (knitr::is_latex_output()) ".pdf" else ".png"

# knitr::knit_hooks$set(optipng = knitr::hook_optipng, pdfcrop = knitr::hook_pdfcrop)

# https://github.com/yihui/knitr-examples/blob/master/085-pdfcrop.Rnw
# knitr::knit_hooks$set(crop = hook_pdfcrop)
options(
  repos = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/",
  tikzDefaultEngine = "xetex",
  tikzXelatexPackages = c(
    getOption("tikzXelatexPackages"),
    "\\usepackage[colorlinks, breaklinks]{hyperref}",
    "\\usepackage{color}",
    "\\usepackage{tikz}",
    "\\usepackage[active,tightpage,xetex]{preview}",
    "\\PreviewEnvironment{pgfpicture}",
    "\\usepackage{amsmath}",
    "\\usepackage{amsfonts}",
    "\\usepackage{mathrsfs}"
  )
)
# https://github.com/yihui/knitr-examples/blob/master/047-tikz-png.Rnw
# knitr::knit_hooks$set(tikz2png = function(before, options, envir) {
  # use this hook only for dev='tikz' and externalized tikz graphics
  # if (before || options$dev != "tikz" || !options$external || options$fig.num == 0) return()
  # figs <- knitr:::all_figs(options, ext = "pdf") # all figure names
  # note the tikz2png option is the extra parameters passed to 'convert'
  # for (fig in figs) {
    # system(sprintf("convert %s %s %s", options$tikz2png, fig, sub("\\.pdf$", ".png", fig)))
  # }
# })


is_on_travis = identical(Sys.getenv("TRAVIS"), "true")
is_online = curl::has_internet()

library(reticulate)
if(is_on_travis) use_virtualenv("shims") else use_python("/usr/bin/python", required = FALSE)
# Python 环境的描述在附录
# required = FALSE 默认值，如果按照指定的位置没有找到 Python 就会扫描其它版本
# use_python("/opt/pyenv/shims/python")
# use_virtualenv("shims")

# 设置环境变量 RSTUDIO_CONNECT_SERVER 由 travis-ci 设置
connectServer <- Sys.getenv("RSTUDIO_CONNECT_SERVER") # https://bookdown.org
apiKey <- Sys.getenv("RSTUDIO_CONNECT_API_KEY")
```
# 广义可加模型 {#gam}

## 一般广义可加模型


## 广义可加混合效应模型

- Repo for tutorial/paper on mixed-effect GAMs (General Additive Models with Mixed-Effect Smooths) <https://github.com/noamross/mixed-effect-gams>

## 高维问题


<!--chapter:end:20-gam.Rmd-->

```{r include=FALSE, cache=FALSE}
library(methods)
set.seed(2018)
options(digits = 3)

Pkgs <- c(
  "reticulate",
  "showtext", "sysfonts", "showtextdb",
  "fontcm",
  "tikzDevice", "filehash", "png",
  "xkcd", "extrafontdb", "Rttf2pt1", "extrafont"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}

if (!all(c("source-han-sans-cn", "source-han-serif-cn") %in% showtextdb::font_installed())) {
  showtextdb::font_install(showtextdb::source_han_serif("CN"))
  showtextdb::font_install(showtextdb::source_han_sans("CN"))
}
extrafont::font_install("fontcm")
extrafont::loadfonts()

if (!"xkcd" %in% extrafont::fonts()) {
  path <- path.expand("~/.fonts")
  if (!file.exists(path)) {
    dir.create(path = path.expand("~/.fonts"))
  }
  download.file("http://simonsoftware.se/other/xkcd.ttf", dest = path.expand("~/.fonts/xkcd.ttf"), mode = "wb")
  extrafont::font_import(paths = path.expand("~/.fonts"), pattern = "[X/x]kcd", prompt = FALSE)
  extrafont::loadfonts()
}

extrafont::fonts() # registered with pdfFonts()
sysfonts::font_families() # List available font families

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = TRUE,
  cache = TRUE,
  citation.bibtex.max=999,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  # fig.showtext = TRUE, # too danger
  fig.asp = 0.618, # 1 / phi
  # fig.show = "hold", # not for python matplotlib
  fig.ext = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  dev = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  engine.path = list(
    octave = "/usr/bin/octave-cli"
  )
)
ext <- if (knitr::is_html_output()) ".svg" else if (knitr::is_latex_output()) ".pdf" else ".png"

# knitr::knit_hooks$set(optipng = knitr::hook_optipng, pdfcrop = knitr::hook_pdfcrop)

# https://github.com/yihui/knitr-examples/blob/master/085-pdfcrop.Rnw
# knitr::knit_hooks$set(crop = hook_pdfcrop)
options(
  repos = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/",
  tikzDefaultEngine = "xetex",
  tikzXelatexPackages = c(
    getOption("tikzXelatexPackages"),
    "\\usepackage[colorlinks, breaklinks]{hyperref}",
    "\\usepackage{color}",
    "\\usepackage{tikz}",
    "\\usepackage[active,tightpage,xetex]{preview}",
    "\\PreviewEnvironment{pgfpicture}",
    "\\usepackage{amsmath}",
    "\\usepackage{amsfonts}",
    "\\usepackage{mathrsfs}"
  )
)
# https://github.com/yihui/knitr-examples/blob/master/047-tikz-png.Rnw
# knitr::knit_hooks$set(tikz2png = function(before, options, envir) {
  # use this hook only for dev='tikz' and externalized tikz graphics
  # if (before || options$dev != "tikz" || !options$external || options$fig.num == 0) return()
  # figs <- knitr:::all_figs(options, ext = "pdf") # all figure names
  # note the tikz2png option is the extra parameters passed to 'convert'
  # for (fig in figs) {
    # system(sprintf("convert %s %s %s", options$tikz2png, fig, sub("\\.pdf$", ".png", fig)))
  # }
# })


is_on_travis = identical(Sys.getenv("TRAVIS"), "true")
is_online = curl::has_internet()

library(reticulate)
if(is_on_travis) use_virtualenv("shims") else use_python("/usr/bin/python", required = FALSE)
# Python 环境的描述在附录
# required = FALSE 默认值，如果按照指定的位置没有找到 Python 就会扫描其它版本
# use_python("/opt/pyenv/shims/python")
# use_virtualenv("shims")

# 设置环境变量 RSTUDIO_CONNECT_SERVER 由 travis-ci 设置
connectServer <- Sys.getenv("RSTUDIO_CONNECT_SERVER") # https://bookdown.org
apiKey <- Sys.getenv("RSTUDIO_CONNECT_API_KEY")
```
\cleardoublepage 

# (APPENDIX) 附录 {-}

<!--chapter:end:21-appendix.Rmd-->

```{r include=FALSE, cache=FALSE}
library(methods)
set.seed(2018)
options(digits = 3)

Pkgs <- c(
  "reticulate",
  "showtext", "sysfonts", "showtextdb",
  "fontcm",
  "tikzDevice", "filehash", "png",
  "xkcd", "extrafontdb", "Rttf2pt1", "extrafont"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}

if (!all(c("source-han-sans-cn", "source-han-serif-cn") %in% showtextdb::font_installed())) {
  showtextdb::font_install(showtextdb::source_han_serif("CN"))
  showtextdb::font_install(showtextdb::source_han_sans("CN"))
}
extrafont::font_install("fontcm")
extrafont::loadfonts()

if (!"xkcd" %in% extrafont::fonts()) {
  path <- path.expand("~/.fonts")
  if (!file.exists(path)) {
    dir.create(path = path.expand("~/.fonts"))
  }
  download.file("http://simonsoftware.se/other/xkcd.ttf", dest = path.expand("~/.fonts/xkcd.ttf"), mode = "wb")
  extrafont::font_import(paths = path.expand("~/.fonts"), pattern = "[X/x]kcd", prompt = FALSE)
  extrafont::loadfonts()
}

extrafont::fonts() # registered with pdfFonts()
sysfonts::font_families() # List available font families

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = TRUE,
  cache = TRUE,
  citation.bibtex.max=999,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  # fig.showtext = TRUE, # too danger
  fig.asp = 0.618, # 1 / phi
  # fig.show = "hold", # not for python matplotlib
  fig.ext = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  dev = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  engine.path = list(
    octave = "/usr/bin/octave-cli"
  )
)
ext <- if (knitr::is_html_output()) ".svg" else if (knitr::is_latex_output()) ".pdf" else ".png"

# knitr::knit_hooks$set(optipng = knitr::hook_optipng, pdfcrop = knitr::hook_pdfcrop)

# https://github.com/yihui/knitr-examples/blob/master/085-pdfcrop.Rnw
# knitr::knit_hooks$set(crop = hook_pdfcrop)
options(
  repos = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/",
  tikzDefaultEngine = "xetex",
  tikzXelatexPackages = c(
    getOption("tikzXelatexPackages"),
    "\\usepackage[colorlinks, breaklinks]{hyperref}",
    "\\usepackage{color}",
    "\\usepackage{tikz}",
    "\\usepackage[active,tightpage,xetex]{preview}",
    "\\PreviewEnvironment{pgfpicture}",
    "\\usepackage{amsmath}",
    "\\usepackage{amsfonts}",
    "\\usepackage{mathrsfs}"
  )
)
# https://github.com/yihui/knitr-examples/blob/master/047-tikz-png.Rnw
# knitr::knit_hooks$set(tikz2png = function(before, options, envir) {
  # use this hook only for dev='tikz' and externalized tikz graphics
  # if (before || options$dev != "tikz" || !options$external || options$fig.num == 0) return()
  # figs <- knitr:::all_figs(options, ext = "pdf") # all figure names
  # note the tikz2png option is the extra parameters passed to 'convert'
  # for (fig in figs) {
    # system(sprintf("convert %s %s %s", options$tikz2png, fig, sub("\\.pdf$", ".png", fig)))
  # }
# })


is_on_travis = identical(Sys.getenv("TRAVIS"), "true")
is_online = curl::has_internet()

library(reticulate)
if(is_on_travis) use_virtualenv("shims") else use_python("/usr/bin/python", required = FALSE)
# Python 环境的描述在附录
# required = FALSE 默认值，如果按照指定的位置没有找到 Python 就会扫描其它版本
# use_python("/opt/pyenv/shims/python")
# use_virtualenv("shims")

# 设置环境变量 RSTUDIO_CONNECT_SERVER 由 travis-ci 设置
connectServer <- Sys.getenv("RSTUDIO_CONNECT_SERVER") # https://bookdown.org
apiKey <- Sys.getenv("RSTUDIO_CONNECT_API_KEY")
```
# R Markdown {#pandoc-markdown}

```{r include=FALSE}
Pkgs <- c(
  "kableExtra"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0)
  install.packages(setdiff(Pkgs, .packages(TRUE)))
```


- 图片引用

`r if(knitr::is_latex_output()) "如图 \\@ref(fig:id1) 所示"`

![工作流程图](diagrams/00-workflow.png){#fig:id1 width=70% }

gitbook 这样网页又该如何引用这张图片呢？

```{r 00-workflow, echo = FALSE, fig.cap="两种编译方式及过程"}
ext <- if (knitr::is_html_output()) ".svg" else if (knitr::is_latex_output()) ".pdf" else ".png"
knitr::include_graphics(path = paste0("diagrams/00-workflow", ext))
```

如图 \@ref(fig:00-workflow) 展示了两种编译方式


- 表格交叉引用

- 参考文献交叉引用


## bookdown

在指定目录创建 Book 项目，

```r
bookdown:::bookdown_skeleton("~/book")
```

项目根目录的文件列表

```markdown
directory/
├──  index.Rmd
├── 01-intro.Rmd
├── 02-literature.Rmd
├── 03-method.Rmd
├── 04-application.Rmd
├── 05-summary.Rmd
├── 06-references.Rmd
├── _bookdown.yml
├── _output.yml
├──  book.bib
├──  preamble.tex
├──  README.md
└──  style.css
```

broom 和 pixiedust 制作表格 Tables So Beautifully Fine-Tuned You Will Believe It's Magic. <https://github.com/nutterb/pixiedust>


## 复杂表格制作 {#kableExtra}

- kableExtra

借助 kableExtra 包 [@R-kableExtra] 可以制作复杂的统计图表，更多的例子请看 <https://github.com/haozhu233/kableExtra> ，我喜欢这个图标设计，如图 \@ref(fig:kableExtra)

```{r kableExtra, echo = FALSE, fig.cap="kableExtra 的徽标",out.width="30%"}
ext <- if (knitr::is_html_output()) ".svg" else if (knitr::is_latex_output()) ".pdf" else ".png"
knitr::include_graphics(path = paste0("diagrams/kableExtra", ext))
```

```{r, eval = FALSE}
library(knitr)
library(kableExtra)
dt <- mtcars[1:5, 1:4]

# HTML table
kable(dt, format = "html", caption = "kableExtra 制作") %>%
  kable_styling(bootstrap_options = "striped",
                full_width = F) %>%
  add_header_above(c(" ", "Group 1" = 2, "Group 2[note]" = 2)) %>%
  add_footnote(c("table footnote"))

# LaTeX Table
kable(dt, format = "latex", booktabs = T, caption = "kableExtra 制作") %>%
  kable_styling(latex_options = c("striped", "hold_position"),
                full_width = F) %>%
  add_header_above(c(" ", "Group 1" = 2, "Group 2[note]" = 2)) %>%
  add_footnote(c("table footnote"))
```

1. 如何将表格横向或者纵向展示


2. 添加短标题

```{r, eval=FALSE}
library(dplyr)
library(knitr)
library(kableExtra) # 这个必须加载

df <- data.frame( X = sample(letters, 10), y = runif(10), z = sample(10:20, 10))

kable(df,
      booktabs = TRUE,
      caption = "This caption is way too long and doesnt look good when formatted in the Table of Contents.  What you really need here is a much shorter caption so that your eyes dont go crazy trying to figure out what information the author is trying to convey.  Often there is too much information in the caption anyway so why not shorten it?.",
      escape = FALSE,
      format = 'latex') %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```



```{r, eval=FALSE}
kable(df,
      booktabs = TRUE,
      caption = "This caption is way too long and doesnt look good when formatted in the Table of Contents.  What you really need here is a much shorter caption so that your eyes dont go crazy trying to figure out what information the author is trying to convey.  Often there is too much information in the caption anyway so why not shorten it?.",
      caption.short = "This is a shorter caption.",
      escape = FALSE,
      format = 'latex') %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```


<!--chapter:end:22-markdown.Rmd-->

```{r include=FALSE, cache=FALSE}
library(methods)
set.seed(2018)
options(digits = 3)

Pkgs <- c(
  "reticulate",
  "showtext", "sysfonts", "showtextdb",
  "fontcm",
  "tikzDevice", "filehash", "png",
  "xkcd", "extrafontdb", "Rttf2pt1", "extrafont"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}

if (!all(c("source-han-sans-cn", "source-han-serif-cn") %in% showtextdb::font_installed())) {
  showtextdb::font_install(showtextdb::source_han_serif("CN"))
  showtextdb::font_install(showtextdb::source_han_sans("CN"))
}
extrafont::font_install("fontcm")
extrafont::loadfonts()

if (!"xkcd" %in% extrafont::fonts()) {
  path <- path.expand("~/.fonts")
  if (!file.exists(path)) {
    dir.create(path = path.expand("~/.fonts"))
  }
  download.file("http://simonsoftware.se/other/xkcd.ttf", dest = path.expand("~/.fonts/xkcd.ttf"), mode = "wb")
  extrafont::font_import(paths = path.expand("~/.fonts"), pattern = "[X/x]kcd", prompt = FALSE)
  extrafont::loadfonts()
}

extrafont::fonts() # registered with pdfFonts()
sysfonts::font_families() # List available font families

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = TRUE,
  cache = TRUE,
  citation.bibtex.max=999,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  # fig.showtext = TRUE, # too danger
  fig.asp = 0.618, # 1 / phi
  # fig.show = "hold", # not for python matplotlib
  fig.ext = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  dev = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  engine.path = list(
    octave = "/usr/bin/octave-cli"
  )
)
ext <- if (knitr::is_html_output()) ".svg" else if (knitr::is_latex_output()) ".pdf" else ".png"

# knitr::knit_hooks$set(optipng = knitr::hook_optipng, pdfcrop = knitr::hook_pdfcrop)

# https://github.com/yihui/knitr-examples/blob/master/085-pdfcrop.Rnw
# knitr::knit_hooks$set(crop = hook_pdfcrop)
options(
  repos = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/",
  tikzDefaultEngine = "xetex",
  tikzXelatexPackages = c(
    getOption("tikzXelatexPackages"),
    "\\usepackage[colorlinks, breaklinks]{hyperref}",
    "\\usepackage{color}",
    "\\usepackage{tikz}",
    "\\usepackage[active,tightpage,xetex]{preview}",
    "\\PreviewEnvironment{pgfpicture}",
    "\\usepackage{amsmath}",
    "\\usepackage{amsfonts}",
    "\\usepackage{mathrsfs}"
  )
)
# https://github.com/yihui/knitr-examples/blob/master/047-tikz-png.Rnw
# knitr::knit_hooks$set(tikz2png = function(before, options, envir) {
  # use this hook only for dev='tikz' and externalized tikz graphics
  # if (before || options$dev != "tikz" || !options$external || options$fig.num == 0) return()
  # figs <- knitr:::all_figs(options, ext = "pdf") # all figure names
  # note the tikz2png option is the extra parameters passed to 'convert'
  # for (fig in figs) {
    # system(sprintf("convert %s %s %s", options$tikz2png, fig, sub("\\.pdf$", ".png", fig)))
  # }
# })


is_on_travis = identical(Sys.getenv("TRAVIS"), "true")
is_online = curl::has_internet()

library(reticulate)
if(is_on_travis) use_virtualenv("shims") else use_python("/usr/bin/python", required = FALSE)
# Python 环境的描述在附录
# required = FALSE 默认值，如果按照指定的位置没有找到 Python 就会扫描其它版本
# use_python("/opt/pyenv/shims/python")
# use_virtualenv("shims")

# 设置环境变量 RSTUDIO_CONNECT_SERVER 由 travis-ci 设置
connectServer <- Sys.getenv("RSTUDIO_CONNECT_SERVER") # https://bookdown.org
apiKey <- Sys.getenv("RSTUDIO_CONNECT_API_KEY")
```
# Python 绘图 {#python-plot}

## matplotlib

先安装必要的模块

```bash
sudo apt-get install -y python-tk python-pip
sudo -H pip install numpy matplotlib
```

在 R Markdown 中生成PDF需要如下tex包

```markdown
- psnfss
- type1cm
- ucs
- tex4ht
- ncntrsbk
- helvetic
- preview
```

默认使用 [STIX 数学字体](http://www.stixfonts.org/) 和 DejaVu Sans 英文字体，如图 \@ref(fig:math-matplotlib) 所示

```{python math-matplotlib, fig.cap = "数学公式"}
import numpy as np
import matplotlib.pyplot as plt
plt.switch_backend('agg') # Very Important in R Markdown
t = np.arange(0.0, 2.0, 0.01)
s = np.sin(2*np.pi*t)

plt.plot(t,s)
plt.title(r'$\alpha_i > \beta_i$', fontsize=20)
plt.text(1, -0.6, r'$\sum_{i=0}^\infty x_i$', fontsize=20)
plt.text(0.6, 0.6, r'$\mathcal{A}\mathrm{sin}(2 \omega t)$',
         fontsize=20)
plt.xlabel('time (s)')
plt.ylabel('volts (mV)')
plt.show()
# plt.savefig('math-in-plot.png', bbox_inches='tight', dpi = 300)
# plt.savefig('math-in-plot.pdf', bbox_inches='tight')
```

- dpi 分辨率，越大图像越清晰，对矢量图形无效
- bbox\_inches 去除图形周边空白区域

```{block2, type='rmdnote'}
Python 的 matplotlib 模块没有叫 `cairo_pdf` 的保存设备，所以此处设置为 `dev = "pdf"`，它支持的图片格式有 eps, pdf, pgf, png, ps, raw, rgba, svg, svgz
```

Windows 下保存的 PDF 图片需要用 gs 嵌入字体才可以，不然会出现无法显示 XX 字体的错误，假设在 R 环境中，只需如下两行命令即可

```r
# Needed only on Windows - run once per R session
# Adjust the path to match your installation of Ghostscript
Sys.setenv(R_GSCMD = "C:/Program Files/gs/gs9.23/bin/gswin64c.exe")
embedFonts(file = "math-in-plot.pdf", outfile = "math-in-plot-embed.pdf")
```

如图 \@ref(fig:native-math)

```{python native-math, fig.cap = "本真的公式样式"}
from __future__ import unicode_literals
import numpy as np
import matplotlib
matplotlib.rcParams['text.usetex'] = True
matplotlib.rcParams['text.latex.unicode'] = True
import matplotlib.pyplot as plt
plt.switch_backend('agg') # Very Important in R Markdown

t = np.linspace(0.0, 1.0, 100)
s = np.cos(4 * np.pi * t) + 2

fig, ax = plt.subplots(figsize=(6, 4), tight_layout=True)
ax.plot(t, s)

ax.set_xlabel(r'\textbf{time (s)}')
# ax.set_ylabel(r'\textit{Velocity}(\N{DEGREE SIGN}/sec)', fontsize=16)
ax.set_ylabel(r'\textit{Velocity}($^{\circ}$/sec)', fontsize=16)
ax.set_title(r'\TeX\ is Number $\displaystyle\sum_{n=1}^\infty'
             r'\frac{-e^{i\pi}}{2^n}$!', fontsize=16, color='r')
plt.show()
```

基本用法 <http://qiangbo.space/2018-04-06/matplotlib_l1/>


如果系统有安装其它字体，可以设置你喜欢的字体

```
font.family        : serif
font.serif         : Times, Palatino, New Century Schoolbook, Bookman, Computer Modern Roman
font.sans-serif    : Helvetica, Avant Garde, Computer Modern Sans serif
font.cursive       : Zapf Chancery
font.monospace     : Courier, Computer Modern Typewriter

text.usetex        : true
```


```{python, fig.cap = "Python数学字体设置"}
#from matplotlib import rc
#rc('font',**{'family':'sans-serif','sans-serif':['Helvetica']})
## for Palatino and other serif fonts use:
#rc('font',**{'family':'serif','serif':['Palatino']})
#rc('text', usetex=True)

import numpy as np
import matplotlib.pyplot as plt
plt.switch_backend('agg') # Very Important in R Markdown

# Example data
t = np.arange(0.0, 1.0 + 0.01, 0.01)
s = np.cos(4 * np.pi * t) + 2

plt.rc('text', usetex=True)
plt.rc('font', family='serif')
# plt.rc('font', family='sans-serif')
plt.plot(t, s)

plt.xlabel(r'\textbf{time} (s)')
plt.ylabel(r'\textit{voltage} (mV)',fontsize=16)
plt.title(r"\TeX\ is Number "
          r"$\displaystyle\sum_{n=1}^\infty\frac{-e^{i\pi}}{2^n}$!",
          fontsize=16, color='gray')
# Make room for the ridiculously large title.
plt.subplots_adjust(top=0.8)

# plt.savefig('tex_demo')
plt.show()
```



## seaborn

- seaborn: statistical data visualization <http://seaborn.pydata.org/>

Seaborn is a Python visualization library based on matplotlib. It provides a high-level interface for drawing attractive statistical graphics.

- statsmodels


## pyglet

处理音视频文件

## mayavi

三维图形

## bokeh

- 主页 <https://bokeh.pydata.org/en/latest/>

> R Markdown 暂不支持动态 Python 图形的展示

```{python, eval = FALSE}
# https://bokeh.pydata.org/en/latest/docs/gallery/joyplot.html
from numpy import linspace
from scipy.stats.kde import gaussian_kde

from bokeh.io import output_file, show
from bokeh.models import ColumnDataSource, FixedTicker, PrintfTickFormatter
from bokeh.plotting import figure
from bokeh.sampledata.perceptions import probly

import colorcet as cc

output_file("joyplot.html")

def joy(category, data, scale=20):
    return list(zip([category]*len(data), scale*data))

cats = list(reversed(probly.keys()))

palette = [cc.rainbow[i*15] for i in range(17)]

x = linspace(-20,110, 500)

source = ColumnDataSource(data=dict(x=x))

p = figure(y_range=cats, plot_width=900, x_range=(-5, 105), toolbar_location=None)

for i, cat in enumerate(reversed(cats)):
    pdf = gaussian_kde(probly[cat])
    y = joy(cat, pdf(x))
    source.add(y, cat)
    p.patch('x', cat, color=palette[i], alpha=0.6, line_color="black", source=source)

p.outline_line_color = None
p.background_fill_color = "#efefef"

p.xaxis.ticker = FixedTicker(ticks=list(range(0, 101, 10)))
p.xaxis.formatter = PrintfTickFormatter(format="%d%%")

p.ygrid.grid_line_color = None
p.xgrid.grid_line_color = "#dddddd"
p.xgrid.ticker = p.xaxis[0].ticker

p.axis.minor_tick_line_color = None
p.axis.major_tick_line_color = None
p.axis.axis_line_color = None

p.y_range.range_padding = 0.12

show(p)
```

## plotly

商业图形库


<!--chapter:end:23-matplotlib.Rmd-->

```{r include=FALSE, cache=FALSE}
library(methods)
set.seed(2018)
options(digits = 3)

Pkgs <- c(
  "reticulate",
  "showtext", "sysfonts", "showtextdb",
  "fontcm",
  "tikzDevice", "filehash", "png",
  "xkcd", "extrafontdb", "Rttf2pt1", "extrafont"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}

if (!all(c("source-han-sans-cn", "source-han-serif-cn") %in% showtextdb::font_installed())) {
  showtextdb::font_install(showtextdb::source_han_serif("CN"))
  showtextdb::font_install(showtextdb::source_han_sans("CN"))
}
extrafont::font_install("fontcm")
extrafont::loadfonts()

if (!"xkcd" %in% extrafont::fonts()) {
  path <- path.expand("~/.fonts")
  if (!file.exists(path)) {
    dir.create(path = path.expand("~/.fonts"))
  }
  download.file("http://simonsoftware.se/other/xkcd.ttf", dest = path.expand("~/.fonts/xkcd.ttf"), mode = "wb")
  extrafont::font_import(paths = path.expand("~/.fonts"), pattern = "[X/x]kcd", prompt = FALSE)
  extrafont::loadfonts()
}

extrafont::fonts() # registered with pdfFonts()
sysfonts::font_families() # List available font families

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = TRUE,
  cache = TRUE,
  citation.bibtex.max=999,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  # fig.showtext = TRUE, # too danger
  fig.asp = 0.618, # 1 / phi
  # fig.show = "hold", # not for python matplotlib
  fig.ext = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  dev = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  engine.path = list(
    octave = "/usr/bin/octave-cli"
  )
)
ext <- if (knitr::is_html_output()) ".svg" else if (knitr::is_latex_output()) ".pdf" else ".png"

# knitr::knit_hooks$set(optipng = knitr::hook_optipng, pdfcrop = knitr::hook_pdfcrop)

# https://github.com/yihui/knitr-examples/blob/master/085-pdfcrop.Rnw
# knitr::knit_hooks$set(crop = hook_pdfcrop)
options(
  repos = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/",
  tikzDefaultEngine = "xetex",
  tikzXelatexPackages = c(
    getOption("tikzXelatexPackages"),
    "\\usepackage[colorlinks, breaklinks]{hyperref}",
    "\\usepackage{color}",
    "\\usepackage{tikz}",
    "\\usepackage[active,tightpage,xetex]{preview}",
    "\\PreviewEnvironment{pgfpicture}",
    "\\usepackage{amsmath}",
    "\\usepackage{amsfonts}",
    "\\usepackage{mathrsfs}"
  )
)
# https://github.com/yihui/knitr-examples/blob/master/047-tikz-png.Rnw
# knitr::knit_hooks$set(tikz2png = function(before, options, envir) {
  # use this hook only for dev='tikz' and externalized tikz graphics
  # if (before || options$dev != "tikz" || !options$external || options$fig.num == 0) return()
  # figs <- knitr:::all_figs(options, ext = "pdf") # all figure names
  # note the tikz2png option is the extra parameters passed to 'convert'
  # for (fig in figs) {
    # system(sprintf("convert %s %s %s", options$tikz2png, fig, sub("\\.pdf$", ".png", fig)))
  # }
# })


is_on_travis = identical(Sys.getenv("TRAVIS"), "true")
is_online = curl::has_internet()

library(reticulate)
if(is_on_travis) use_virtualenv("shims") else use_python("/usr/bin/python", required = FALSE)
# Python 环境的描述在附录
# required = FALSE 默认值，如果按照指定的位置没有找到 Python 就会扫描其它版本
# use_python("/opt/pyenv/shims/python")
# use_virtualenv("shims")

# 设置环境变量 RSTUDIO_CONNECT_SERVER 由 travis-ci 设置
connectServer <- Sys.getenv("RSTUDIO_CONNECT_SERVER") # https://bookdown.org
apiKey <- Sys.getenv("RSTUDIO_CONNECT_API_KEY")
```
# 性能提升 {#performance}

- [C++ 编程风格指南](http://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines) 
- <https://github.com/isocpp/CppCoreGuidelines>

- 如何充分利用 Rcpp 包
- 设个目标，锻炼一下编码能力，关于统计计算和可视化尽可能提供两个方案，至少包含基础 R 包的实现

```{r base-packages}
Pkgs <- sapply(list.files(R.home("library")), function(x)
  packageDescription(pkg = x, fields = "Priority"))
names(Pkgs[Pkgs == "base" & !is.na(Pkgs)])
```

计算程序运行时间

```{r}
.proctime00 <- proc.time()
s <- 0
for (i in seq(1000)) {
  s <- s + i
}
proc.time() - .proctime00
```

## Rcpp



### RcppOctave

混合编程


### RcppGSL


### RcppArmadillo

### RcppParallel

### RcppNumerical


### RcppAlgos


```{r, eval = .Platform$OS.type != "windows"}
devtools::session_info(pkgs = c("Rcpp","RcppOctave"))
```


<!--chapter:end:24-r2cpp.Rmd-->

```{r include=FALSE, cache=FALSE}
library(methods)
set.seed(2018)
options(digits = 3)

Pkgs <- c(
  "reticulate",
  "showtext", "sysfonts", "showtextdb",
  "fontcm",
  "tikzDevice", "filehash", "png",
  "xkcd", "extrafontdb", "Rttf2pt1", "extrafont"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}

if (!all(c("source-han-sans-cn", "source-han-serif-cn") %in% showtextdb::font_installed())) {
  showtextdb::font_install(showtextdb::source_han_serif("CN"))
  showtextdb::font_install(showtextdb::source_han_sans("CN"))
}
extrafont::font_install("fontcm")
extrafont::loadfonts()

if (!"xkcd" %in% extrafont::fonts()) {
  path <- path.expand("~/.fonts")
  if (!file.exists(path)) {
    dir.create(path = path.expand("~/.fonts"))
  }
  download.file("http://simonsoftware.se/other/xkcd.ttf", dest = path.expand("~/.fonts/xkcd.ttf"), mode = "wb")
  extrafont::font_import(paths = path.expand("~/.fonts"), pattern = "[X/x]kcd", prompt = FALSE)
  extrafont::loadfonts()
}

extrafont::fonts() # registered with pdfFonts()
sysfonts::font_families() # List available font families

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = TRUE,
  cache = TRUE,
  citation.bibtex.max=999,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  # fig.showtext = TRUE, # too danger
  fig.asp = 0.618, # 1 / phi
  # fig.show = "hold", # not for python matplotlib
  fig.ext = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  dev = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  engine.path = list(
    octave = "/usr/bin/octave-cli"
  )
)
ext <- if (knitr::is_html_output()) ".svg" else if (knitr::is_latex_output()) ".pdf" else ".png"

# knitr::knit_hooks$set(optipng = knitr::hook_optipng, pdfcrop = knitr::hook_pdfcrop)

# https://github.com/yihui/knitr-examples/blob/master/085-pdfcrop.Rnw
# knitr::knit_hooks$set(crop = hook_pdfcrop)
options(
  repos = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/",
  tikzDefaultEngine = "xetex",
  tikzXelatexPackages = c(
    getOption("tikzXelatexPackages"),
    "\\usepackage[colorlinks, breaklinks]{hyperref}",
    "\\usepackage{color}",
    "\\usepackage{tikz}",
    "\\usepackage[active,tightpage,xetex]{preview}",
    "\\PreviewEnvironment{pgfpicture}",
    "\\usepackage{amsmath}",
    "\\usepackage{amsfonts}",
    "\\usepackage{mathrsfs}"
  )
)
# https://github.com/yihui/knitr-examples/blob/master/047-tikz-png.Rnw
# knitr::knit_hooks$set(tikz2png = function(before, options, envir) {
  # use this hook only for dev='tikz' and externalized tikz graphics
  # if (before || options$dev != "tikz" || !options$external || options$fig.num == 0) return()
  # figs <- knitr:::all_figs(options, ext = "pdf") # all figure names
  # note the tikz2png option is the extra parameters passed to 'convert'
  # for (fig in figs) {
    # system(sprintf("convert %s %s %s", options$tikz2png, fig, sub("\\.pdf$", ".png", fig)))
  # }
# })


is_on_travis = identical(Sys.getenv("TRAVIS"), "true")
is_online = curl::has_internet()

library(reticulate)
if(is_on_travis) use_virtualenv("shims") else use_python("/usr/bin/python", required = FALSE)
# Python 环境的描述在附录
# required = FALSE 默认值，如果按照指定的位置没有找到 Python 就会扫描其它版本
# use_python("/opt/pyenv/shims/python")
# use_virtualenv("shims")

# 设置环境变量 RSTUDIO_CONNECT_SERVER 由 travis-ci 设置
connectServer <- Sys.getenv("RSTUDIO_CONNECT_SERVER") # https://bookdown.org
apiKey <- Sys.getenv("RSTUDIO_CONNECT_API_KEY")
```
# Git

## 合并上流的 commit 

```bash
git clone --depth=5 https://github.com/XiangyunHuang/cosx.org.git
git submodule update --init --recursive
# 查看远程分支
cd cosx.org
git remote -v
```

```
origin  https://github.com/XiangyunHuang/cosx.org.git (fetch)
origin  https://github.com/XiangyunHuang/cosx.org.git (push)
```


```bash
# 添加上流分支
git remote add upstream https://github.com/cosname/cosx.org.git
git remote -v
```
```
origin  https://github.com/XiangyunHuang/cosx.org.git (fetch)
origin  https://github.com/XiangyunHuang/cosx.org.git (push)
upstream        https://github.com/cosname/cosx.org.git (fetch)
upstream        https://github.com/cosname/cosx.org.git (push)
```

```bash
# 获取上流 commit 并且合并到我的 master 分支
git fetch upstream
git merge upstream/master master
git push origin master
```

## 新建分支


```bash
git checkout -b stan # 新建 stan 分支
git branch -v # 查看本地分支 stan 前有个星号标记
git pull --rebase git@github.com:XiangyunHuang/cosx.org.git master
# 同步到远程分支 stan
git push --set-upstream origin stan
git push origin master:stan

git add .
git commit -m "balabala"
git push --set-upstream origin stan
```

## 创建站点

基于 GitHub Pages 创建站点用于存放图片和数据

1. 在Github上创建一个空的仓库，命名为 uploads，没有 readme.md 和 LICENSE
2. 在本地创建目录 uploads 
3. 切换到 uploads 目录下

git init 
git checkout -b gh-pages
git remote add origin https://github.com/XiangyunHuang/home.git

添加图片或者数据，并且 git add 和 commit 后

git push --set-upstream origin gh-pages

这样仓库 home 只包含 gh-pages 分支

数据地址即为

https://xiangyunhuang.github.io/home/data/eqList2018_05_18.xls

## 回车换行

CR (Carriage Return) 表示回车，LF (Line Feed) 表示换行，Windows 下用回车加换行表示下一行，UNIX/Linux 采用换行符 (LF) 表示下一行，MAC OS 则采用回车符 (CR) 表示下一行

```bash
git config --global core.autocrlf false
```

添加子模块

```bash
git submodule add git://github.com/jgm/pandoc-templates.git templates
```

克隆项目

```bash
git clone --depth=10 --branch=master --recursive \
    git@github.com:XiangyunHuang/pandoc4everything.git
```

配置账户

```bash
git config --global user.email "email"
git config --global user.name "username"
touch .git-credentials
echo "https://username:password@github.com" >> .git-credentials
git config --global credential.helper store
```

往空的 Github 仓库添加本地文件

```bash
git init
git remote add origin https://github.com/XiangyunHuang/notesdown.git
git add -A
git commit -m "balabala"
git push -u origin master
```

本地新建仓库推送至远程分支

```bash
git remote add origin https://github.com/XiangyunHuang/notesdown.git
git add .
git commit -m "init cos-art"
# 此时远程仓库 notesdown 还没有 cos-art 分支
git push origin master:cos-art
```

使用 zsh

```bash
sudo apt update && sudo apt install zsh
sh -c "$(wget https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh -O -)"
```

位于 [Github](https://github.com/liuhui998/gitbook) [Git Community Book 中译本](http://gitbook.liuhui998.com/)


## PR 

```bash
git pull --rebase git@github.com:yihui/xaringan.git master
# then force push to your master branch
```

参考 <https://github.com/yihui/xaringan/pull/107>

> I don't recommend you to use your master branch for pull requests, because all commits will be squashed before merging, e.g. c2c2055 Then you will have some trouble with syncing your master branch with the master branch here (your choices are (1) delete your repo and fork again; or (2) force push; either option is not good). For pull requests, I recommend that you always use different branches for different pull requests.

<!--chapter:end:Git.Rmd-->

```{r include=FALSE, cache=FALSE}
library(methods)
set.seed(2018)
options(digits = 3)

Pkgs <- c(
  "reticulate",
  "showtext", "sysfonts", "showtextdb",
  "fontcm",
  "tikzDevice", "filehash", "png",
  "xkcd", "extrafontdb", "Rttf2pt1", "extrafont"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}

if (!all(c("source-han-sans-cn", "source-han-serif-cn") %in% showtextdb::font_installed())) {
  showtextdb::font_install(showtextdb::source_han_serif("CN"))
  showtextdb::font_install(showtextdb::source_han_sans("CN"))
}
extrafont::font_install("fontcm")
extrafont::loadfonts()

if (!"xkcd" %in% extrafont::fonts()) {
  path <- path.expand("~/.fonts")
  if (!file.exists(path)) {
    dir.create(path = path.expand("~/.fonts"))
  }
  download.file("http://simonsoftware.se/other/xkcd.ttf", dest = path.expand("~/.fonts/xkcd.ttf"), mode = "wb")
  extrafont::font_import(paths = path.expand("~/.fonts"), pattern = "[X/x]kcd", prompt = FALSE)
  extrafont::loadfonts()
}

extrafont::fonts() # registered with pdfFonts()
sysfonts::font_families() # List available font families

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = TRUE,
  cache = TRUE,
  citation.bibtex.max=999,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  # fig.showtext = TRUE, # too danger
  fig.asp = 0.618, # 1 / phi
  # fig.show = "hold", # not for python matplotlib
  fig.ext = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  dev = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  engine.path = list(
    octave = "/usr/bin/octave-cli"
  )
)
ext <- if (knitr::is_html_output()) ".svg" else if (knitr::is_latex_output()) ".pdf" else ".png"

# knitr::knit_hooks$set(optipng = knitr::hook_optipng, pdfcrop = knitr::hook_pdfcrop)

# https://github.com/yihui/knitr-examples/blob/master/085-pdfcrop.Rnw
# knitr::knit_hooks$set(crop = hook_pdfcrop)
options(
  repos = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/",
  tikzDefaultEngine = "xetex",
  tikzXelatexPackages = c(
    getOption("tikzXelatexPackages"),
    "\\usepackage[colorlinks, breaklinks]{hyperref}",
    "\\usepackage{color}",
    "\\usepackage{tikz}",
    "\\usepackage[active,tightpage,xetex]{preview}",
    "\\PreviewEnvironment{pgfpicture}",
    "\\usepackage{amsmath}",
    "\\usepackage{amsfonts}",
    "\\usepackage{mathrsfs}"
  )
)
# https://github.com/yihui/knitr-examples/blob/master/047-tikz-png.Rnw
# knitr::knit_hooks$set(tikz2png = function(before, options, envir) {
  # use this hook only for dev='tikz' and externalized tikz graphics
  # if (before || options$dev != "tikz" || !options$external || options$fig.num == 0) return()
  # figs <- knitr:::all_figs(options, ext = "pdf") # all figure names
  # note the tikz2png option is the extra parameters passed to 'convert'
  # for (fig in figs) {
    # system(sprintf("convert %s %s %s", options$tikz2png, fig, sub("\\.pdf$", ".png", fig)))
  # }
# })


is_on_travis = identical(Sys.getenv("TRAVIS"), "true")
is_online = curl::has_internet()

library(reticulate)
if(is_on_travis) use_virtualenv("shims") else use_python("/usr/bin/python", required = FALSE)
# Python 环境的描述在附录
# required = FALSE 默认值，如果按照指定的位置没有找到 Python 就会扫描其它版本
# use_python("/opt/pyenv/shims/python")
# use_virtualenv("shims")

# 设置环境变量 RSTUDIO_CONNECT_SERVER 由 travis-ci 设置
connectServer <- Sys.getenv("RSTUDIO_CONNECT_SERVER") # https://bookdown.org
apiKey <- Sys.getenv("RSTUDIO_CONNECT_API_KEY")
```
# 软件工具 {#other-tools}

```{r include=FALSE}
Pkgs <- c(
  "inline"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}

system <- function(...) cat(base::system(..., intern = TRUE), sep = '\n')
system2 <- function(...) cat(base::system2(..., stdout = TRUE), sep = "\n")
```

## Bash

```bash
du -sh * | sort -nr
```

对当前目录下的文件/夹 按大小排序

## Octave

安装新版 Octave，详情请见 <https://wiki.octave.org/Octave_for_Debian_systems>

```bash
sudo apt-add-repository -y ppa:octave/stable
sudo apt-get update
sudo apt-get install -y octave
```

```{r, eval = .Platform$OS.type != "windows"}
Sys.which("octave")
system("octave --version")
```


## Python

Python 版本和位置

```{r}
Sys.which("python")
system2("python", args = "--version", stderr = TRUE)
```


升级 Python

```bash
sudo add-apt-repository ppa:fkrull/deadsnakes-python2.7  
sudo apt-get update  
```

可用的 python 模块

```{python}
help('modules')
```

## Hugo

下载 <https://github.com/gohugoio/hugo/releases>

```bash
wget https://github.com/gohugoio/hugo/releases/download/v0.40.2/hugo_0.40.2_Linux-64bit.deb
sudo dpkg -i hugo_0.40.2_Linux-64bit.deb
```

## LaTeX 

可以考虑打包自定义 TinyTeX 发行版，自定义在于最小的中文支持和最喜爱的英文字体设置 fandol 和 sourceserifpro(XeLaTeX)，mathptmx 和 inconsolata(PDFLaTeX), fibeamer, Pandoc's LaTeX 模板 

在 Windows or MacOS 下需要这行操作

```
tlmgr --repository http://www.preining.info/tlgpg/ install tlgpg
```

## Pandoc

pandoc 在 R Markdown 中是否可用

```{r}
rmarkdown::pandoc_available()
```

pandoc 版本

```{r}
Sys.which("pandoc")
system("pandoc -v")
```

## Rtools

rtools 是否可用

```{r}
devtools::find_rtools()
```

算个小栗子

```{r rtools}
fx <- inline::cxxfunction( signature(x = "integer", y = "numeric" ) , '
	return ScalarReal( INTEGER(x)[0] * REAL(y)[0] ) ;
' )
fx( 2L, 5 ) 
```


## 容器 {#container}

### rocker

- Dockerfile <https://docs.docker.com/develop/develop-images/dockerfile_best-practices/>
- build <https://docs.docker.com/engine/reference/builder/#usage>

### Singularity

- <https://github.com/bwlewis/r-and-singularity>
- <http://singularity.lbl.gov/>

### Kubernetes

Kubernetes 容器集群管理 <https://www.kubernetes.org.cn>
参见高策的博客 <http://gaocegege.com>

## apt

适用于 Debian 和 Ubuntu 的软件包管理器

## yum

适用于 Fedora 和 CentOS 的软件包管理器

## tlmgr

基本使用已包含在 **tinytex** \index{tinytex}包 [@R-tinytex] 内



## 重复 {#reproduce}

重复实现的关键是拉取一个现有的 Docker 镜像，可以免去安装和环境配置的诸多麻烦。

```bash
docker run --rm -it --name book -e \
 DISPLAY=192.168.99.100:0 -d -p 8282:8787 -e ROOT=TRUE \
 -e USER=rstudio -e PASSWORD=cloud rocker/geospatial
```

`DISPLAY=192.168.99.100:0` 用于启用 X11 设备，否则 rgl 等软件包会报显示警告，`--rm -it` 使得 主机和虚拟机时间一致，否则会有警告^[<https://github.com/rocker-org/rocker/wiki/Allowing-GUI-windows>]

```
# 两个与时间有关的警告
Warning message:
running command 'timedatectl' had status 1 
Failed to create bus connection: No such file or directory
```

<https://stackoverflow.com/questions/43907925/ubuntu-timedatectl-fails-in-docker-container>

```r
capabilities()
 jpeg         png        tiff       tcltk         X11        aqua    http/ftp     sockets      libxml 
 TRUE        TRUE        TRUE        TRUE       FALSE       FALSE        TRUE        TRUE        TRUE 
 fifo      cledit       iconv         NLS     profmem       cairo         ICU long.double     libcurl 
 TRUE        TRUE        TRUE       FALSE        TRUE        TRUE        TRUE        TRUE        TRUE 
```
主机端口号 8282，这里可以改成你自己喜欢的，虚拟机端口号 8787 对应 RStudio Server 默认端口，如果你想自己指定，就去修改 RStudio Server的配置文件。拉取的 Docker 镜像取名 book，这是方便以后启动 docker 时方便，只需

```bash
# 启动
docker start book
# 进入
docker exec -it book bash
```

由于要安装 rstan 和 rstanarm 包，编译的过程中需要比较大的内存空间，默认分配给 docker 的内存要增加到 4 Gb，也就装个软件，大一点的基于 stan 实现的模型，还是适合放在大机器上跑，笔电可以跑跑简单的模型，学习一下就可以了。

R包库存放位置

```{r}
.libPaths()
```

查看系统路径，环境变量

```{r}
strsplit(Sys.getenv("PATH"),split = .Platform$path.sep)
```

<!--chapter:end:tools.Rmd-->

```{r include=FALSE, cache=FALSE}
library(methods)
set.seed(2018)
options(digits = 3)

Pkgs <- c(
  "reticulate",
  "showtext", "sysfonts", "showtextdb",
  "fontcm",
  "tikzDevice", "filehash", "png",
  "xkcd", "extrafontdb", "Rttf2pt1", "extrafont"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}

if (!all(c("source-han-sans-cn", "source-han-serif-cn") %in% showtextdb::font_installed())) {
  showtextdb::font_install(showtextdb::source_han_serif("CN"))
  showtextdb::font_install(showtextdb::source_han_sans("CN"))
}
extrafont::font_install("fontcm")
extrafont::loadfonts()

if (!"xkcd" %in% extrafont::fonts()) {
  path <- path.expand("~/.fonts")
  if (!file.exists(path)) {
    dir.create(path = path.expand("~/.fonts"))
  }
  download.file("http://simonsoftware.se/other/xkcd.ttf", dest = path.expand("~/.fonts/xkcd.ttf"), mode = "wb")
  extrafont::font_import(paths = path.expand("~/.fonts"), pattern = "[X/x]kcd", prompt = FALSE)
  extrafont::loadfonts()
}

extrafont::fonts() # registered with pdfFonts()
sysfonts::font_families() # List available font families

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = TRUE,
  cache = TRUE,
  citation.bibtex.max=999,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  # fig.showtext = TRUE, # too danger
  fig.asp = 0.618, # 1 / phi
  # fig.show = "hold", # not for python matplotlib
  fig.ext = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  dev = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  engine.path = list(
    octave = "/usr/bin/octave-cli"
  )
)
ext <- if (knitr::is_html_output()) ".svg" else if (knitr::is_latex_output()) ".pdf" else ".png"

# knitr::knit_hooks$set(optipng = knitr::hook_optipng, pdfcrop = knitr::hook_pdfcrop)

# https://github.com/yihui/knitr-examples/blob/master/085-pdfcrop.Rnw
# knitr::knit_hooks$set(crop = hook_pdfcrop)
options(
  repos = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/",
  tikzDefaultEngine = "xetex",
  tikzXelatexPackages = c(
    getOption("tikzXelatexPackages"),
    "\\usepackage[colorlinks, breaklinks]{hyperref}",
    "\\usepackage{color}",
    "\\usepackage{tikz}",
    "\\usepackage[active,tightpage,xetex]{preview}",
    "\\PreviewEnvironment{pgfpicture}",
    "\\usepackage{amsmath}",
    "\\usepackage{amsfonts}",
    "\\usepackage{mathrsfs}"
  )
)
# https://github.com/yihui/knitr-examples/blob/master/047-tikz-png.Rnw
# knitr::knit_hooks$set(tikz2png = function(before, options, envir) {
  # use this hook only for dev='tikz' and externalized tikz graphics
  # if (before || options$dev != "tikz" || !options$external || options$fig.num == 0) return()
  # figs <- knitr:::all_figs(options, ext = "pdf") # all figure names
  # note the tikz2png option is the extra parameters passed to 'convert'
  # for (fig in figs) {
    # system(sprintf("convert %s %s %s", options$tikz2png, fig, sub("\\.pdf$", ".png", fig)))
  # }
# })


is_on_travis = identical(Sys.getenv("TRAVIS"), "true")
is_online = curl::has_internet()

library(reticulate)
if(is_on_travis) use_virtualenv("shims") else use_python("/usr/bin/python", required = FALSE)
# Python 环境的描述在附录
# required = FALSE 默认值，如果按照指定的位置没有找到 Python 就会扫描其它版本
# use_python("/opt/pyenv/shims/python")
# use_virtualenv("shims")

# 设置环境变量 RSTUDIO_CONNECT_SERVER 由 travis-ci 设置
connectServer <- Sys.getenv("RSTUDIO_CONNECT_SERVER") # https://bookdown.org
apiKey <- Sys.getenv("RSTUDIO_CONNECT_API_KEY")
```
# 书单 {#book-list}

- [Pro Git 中文第二版](https://git-scm.com/book/zh/v2) Scott Chacon, Ben Straub 著
- [Advanced R 第二版](https://adv-r.hadley.nz/) Hadley Wickham 著
- [Geocomputation with R](https://geocompr.robinlovelace.net/) Robin Lovelace, Jakub Nowosad, Jannes Muenchow 著
- [Spatial Microsimulation with R](https://spatial-microsim-book.robinlovelace.net/) Robin Lovelace and Morgane Dumont 著
- [R Markdown: The Definitive Guide](https://bookdown.org/yihui/rmarkdown/) Yihui Xie, J. J. Allaire, Garrett Grolemund 著
- [bookdown: Authoring Books and Technical Documents with R Markdown](https://bookdown.org/yihui/bookdown/) Yihui Xie 著
- [blogdown: Creating Websites with R Markdown](https://bookdown.org/yihui/blogdown/) Yihui Xie, Amber Thomas, Alison Presmanes Hill 著
- [R: A Language and Environment for Statistical Computing](https://xiangyun.netlify.com/pdf/refman.pdf) The R Core Team 著
- [LaTeX2e unofficial reference manual](http://tug.ctan.org/tex-archive/info/latex2e-help-texinfo/latex2e.html) [pdf 版](https://xiangyun.netlify.com/pdf/latex2e.pdf)

- [Statistical Rethinking](http://xcelab.net/rm/statistical-rethinking/)  Richard McElreath 著
- [Regression Modeling Strategies](http://biostat.mc.vanderbilt.edu/wiki/Main/RmS) Frank E Harrell Jr 著
- [Applied Predictive Modeling](http://appliedpredictivemodeling.com/) Max Kuhn and Kjell Johnson 著
- [Forecasting: Principles and Practice](https://www.otexts.org/fpp2/) Rob J Hyndman and George Athanasopoulos 著
- [Applied Regression Analysis and Generalized Linear Models](https://socialsciences.mcmaster.ca/jfox/) 及书评 [JASA-review](https://socialsciences.mcmaster.ca/jfox/Books/Applied-Regression-2E/JASA-review.pdf) 附录、样章和书评位于目录 docs/John-Fox

- [Introduction to Data Science](https://rafalab.github.io/dsbook/) Rafael A. Irizarry 著

- [Feature Engineering and Selection: A Practical Approach for Predictive Models](http://www.feat.engineering) Max Kuhn and Kjell Johnson

<!--chapter:end:books.Rmd-->

```{r include=FALSE, cache=FALSE}
library(methods)
set.seed(2018)
options(digits = 3)

Pkgs <- c(
  "reticulate",
  "showtext", "sysfonts", "showtextdb",
  "fontcm",
  "tikzDevice", "filehash", "png",
  "xkcd", "extrafontdb", "Rttf2pt1", "extrafont"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}

if (!all(c("source-han-sans-cn", "source-han-serif-cn") %in% showtextdb::font_installed())) {
  showtextdb::font_install(showtextdb::source_han_serif("CN"))
  showtextdb::font_install(showtextdb::source_han_sans("CN"))
}
extrafont::font_install("fontcm")
extrafont::loadfonts()

if (!"xkcd" %in% extrafont::fonts()) {
  path <- path.expand("~/.fonts")
  if (!file.exists(path)) {
    dir.create(path = path.expand("~/.fonts"))
  }
  download.file("http://simonsoftware.se/other/xkcd.ttf", dest = path.expand("~/.fonts/xkcd.ttf"), mode = "wb")
  extrafont::font_import(paths = path.expand("~/.fonts"), pattern = "[X/x]kcd", prompt = FALSE)
  extrafont::loadfonts()
}

extrafont::fonts() # registered with pdfFonts()
sysfonts::font_families() # List available font families

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = TRUE,
  cache = TRUE,
  citation.bibtex.max=999,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  # fig.showtext = TRUE, # too danger
  fig.asp = 0.618, # 1 / phi
  # fig.show = "hold", # not for python matplotlib
  fig.ext = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  dev = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  engine.path = list(
    octave = "/usr/bin/octave-cli"
  )
)
ext <- if (knitr::is_html_output()) ".svg" else if (knitr::is_latex_output()) ".pdf" else ".png"

# knitr::knit_hooks$set(optipng = knitr::hook_optipng, pdfcrop = knitr::hook_pdfcrop)

# https://github.com/yihui/knitr-examples/blob/master/085-pdfcrop.Rnw
# knitr::knit_hooks$set(crop = hook_pdfcrop)
options(
  repos = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/",
  tikzDefaultEngine = "xetex",
  tikzXelatexPackages = c(
    getOption("tikzXelatexPackages"),
    "\\usepackage[colorlinks, breaklinks]{hyperref}",
    "\\usepackage{color}",
    "\\usepackage{tikz}",
    "\\usepackage[active,tightpage,xetex]{preview}",
    "\\PreviewEnvironment{pgfpicture}",
    "\\usepackage{amsmath}",
    "\\usepackage{amsfonts}",
    "\\usepackage{mathrsfs}"
  )
)
# https://github.com/yihui/knitr-examples/blob/master/047-tikz-png.Rnw
# knitr::knit_hooks$set(tikz2png = function(before, options, envir) {
  # use this hook only for dev='tikz' and externalized tikz graphics
  # if (before || options$dev != "tikz" || !options$external || options$fig.num == 0) return()
  # figs <- knitr:::all_figs(options, ext = "pdf") # all figure names
  # note the tikz2png option is the extra parameters passed to 'convert'
  # for (fig in figs) {
    # system(sprintf("convert %s %s %s", options$tikz2png, fig, sub("\\.pdf$", ".png", fig)))
  # }
# })


is_on_travis = identical(Sys.getenv("TRAVIS"), "true")
is_online = curl::has_internet()

library(reticulate)
if(is_on_travis) use_virtualenv("shims") else use_python("/usr/bin/python", required = FALSE)
# Python 环境的描述在附录
# required = FALSE 默认值，如果按照指定的位置没有找到 Python 就会扫描其它版本
# use_python("/opt/pyenv/shims/python")
# use_virtualenv("shims")

# 设置环境变量 RSTUDIO_CONNECT_SERVER 由 travis-ci 设置
connectServer <- Sys.getenv("RSTUDIO_CONNECT_SERVER") # https://bookdown.org
apiKey <- Sys.getenv("RSTUDIO_CONNECT_API_KEY")
```
# 主页 {#homepage}

- [Eugene Joh 的博客](https://incidental-ideas.org/)
- [Ilya Kashnitsky 的博客](https://ikashnitsky.github.io/)
- [Max Woolf 的博客](http://minimaxir.com/)
- [Yan Holtz 的 ggplot2 图库](https://www.r-graph-gallery.com/)
- [Jianghao Wang (王江浩)](https://jianghao.github.io)
- [Xinpeng Chen](https://chenxinpeng.github.io/)
- [Arthur Charpentier](https://freakonometrics.github.io) 法语 精算 or [Arthur Charpentier](https://freakonometrics.hypotheses.org)
- [François Husson](https://francoishusson.wordpress.com/) 多元统计分析
- [Jean-Paul Fox](http://www.jean-paulfox.com/) Bayesian response modeling
- [Julian faraway](https://farawaystatistics.wordpress.com) INLA [When Small Data beats Big Data](http://people.bath.ac.uk/jjf23/papers/smallvbig.pdf)
- [Shirin Glander](https://shirinsplayground.netlify.com/)

- [Yihui Xie](https://yihui.name/)
- [Beilei Bian](http://statsjoke.me)
- [Miao Yu](https://yufree.cn/)
- [Ce Gao](http://gaocegege.com/Blog/)
- [Lchiffon](http://langdawei.com/)
- [Nan Xiao](https://nanx.me/)
- [Xuening Zhu](https://xueningzhu.github.io/)
- [Guangchuang YU](https://guangchuangyu.github.io/)
- [Qiang Kou](http://qkou.info/)
- [Yixuan Qiu-cn](https://yixuan.cos.name/cn/) or [Yixuan Qiu-en](https://statr.me/)
- [Tao Gao](https://joegaotao.github.io/)
- [Xunmo Yang](https://tcya.xyz/)
- [Yalei Du](http://yalei.name/)
- [Junchen Feng](http://www.fengjunchen.com/)
- [Sizhe Liu](http://www.bjt.name/)
- [Liyun Chen](http://www.loyhome.com/)
- [Peng Zhao](http://www.pzhao.org/zh/)

## 博客 {#blogger}

- [基于分布式容器和高性能计算的R](https://bwlewis.github.io/r-and-singularity/) R and Singularity
- [利用 R 和 OpenCPU 搭建高可用的 HTTP 服务](http://www.bjt.name/2017/04/opencpu-application)
- [Nearest Neighbor Gaussian Processes (NNGP) based models](https://github.com/LuZhangstat/NNGP_STAN) and [Case study: NNGP based models in Stan](http://mc-stan.org/users/documentation/case-studies/nngp.html)
- [Spatial Models in Stan: Intrinsic Auto-Regressive Models for Areal Data](http://mc-stan.org/users/documentation/case-studies/icar_stan.html) 空间模型之 Stan 实现 [slides](https://github.com/stan-dev/stancon_talks/blob/master/2018/Invited-Talks/Morris.pdf)
- [Conditional autoregressive models in Stan](https://github.com/mbjoseph/CARstan) [网页版](http://mc-stan.org/users/documentation/case-studies/mbjoseph-CARStan.html)

- [Bagging, the perfect solution for model instability](https://insightr.wordpress.com/2017/05/22/bagging-the-perfect-solution-for-model-instability/)
- [How Random Forests improve simple Regression Trees?](https://insightr.wordpress.com/2017/09/23/how-random-forests-improve-simple-regression-trees/)
- [Tuning xgboost in R: Part I](https://insightr.wordpress.com/2018/05/17/tuning-xgboost-in-r-part-i/)
- [Tuning xgboost in R: Part II](https://insightr.wordpress.com/2018/07/28/tuning-xgboost-in-r-part-ii/)

- [Easily Make Multi-tabbed .xlsx Files with openxlsx](https://trinkerrstuff.wordpress.com/2018/02/14/easily-make-multi-tabbed-xlsx-files-with-openxlsx/) Map 函数
- [Deep learning at rstudio::conf 2018](https://rviews.rstudio.com/2018/02/14/deep-learning-rstudio-conf-2018/) 深度学习与R语言,J.J.作为 RStudio 的 CEO 推动 tensorflow 在 R 中的使用，两个幻灯片值得好好看，J.J. 介绍 tensorflow Javier Luraschi介绍tf的部署
- netlify travis-ci blog 搭建 blogdown <https://bookdown.org/yihui/blogdown>
- [An Introduction to Spatial Econometrics in R](http://www.econ.uiuc.edu/~lab/workshop/Spatial_in_R.html) spatial econometric analysis 空间经济分析 可考虑翻译一下 <https://ignaciomsarmiento.github.io/2017/02/07/An-Introduction-to-Spatial-Econometrics-in-R>
- [Data Visualization Shiny Apps](https://ignaciomsarmiento.github.io/software.html) 数据可视化核密度估计 In this app I identify crime hotspots using a bivariate density estimation strategy
- [Putting the Macron in Māori: Accented text in R Graphics](https://www.stat.auckland.ac.nz/~paul/Reports/maori/maori.html) Paul Murrell 图形中嵌入重音字符
- [color in plot](https://www.stat.auckland.ac.nz/~paul/Talks/colour.pdf) Paul Murrell 配色
- [Using Computer Modern Fonts in R Graphics](https://www.stat.auckland.ac.nz/~paul/R/CM/CMR.html) Paul Murrell 图形中嵌入数学字体
- [Lattice Graphics](https://www.stat.auckland.ac.nz/~paul/Talks/dsc2001.pdf) Paul Murrell 介绍 Lattice Graphics
- [Association of Statisticians of American Religious Bodies (ASARB) viridis USA map](http://www.rpubs.com/cgarey/ProjectOneFinal)
- [Mapping unemployment data](http://sharpsightlabs.com/blog/map-unemployment-nov-2016/)
- [when-will-evolution-outperform-local-search](https://blog.evorithmics.org/2016/01/31/when-will-evolution-outperform-local-search/) 进化何时跑赢局部搜索 爱可可爱生活--进化如何跑赢局部搜索
- [Game of Thrones network analysis](https://shirinsplayground.netlify.com/2018/03/got_network/) 权利的游戏 网络
- [Using Git and GitHub with R, Rstudio, and R Markdown](https://github.com/jennybc/happy-git-with-r)
- [如何用Markdown写论文](http://blog.sciencenet.cn/blog-377709-1088215.html)
- [blogdown和Github搭建网站](https://aurora-mareviv.github.io/talesofr/2018/02/r-blogdown-setup-in-github-2/)


- [The R-INLA project and Bayesian computing with INLA](http://www.r-inla.org/)
- [Geographic Data Science in Python](https://data.cdrc.ac.uk/dataset/geographic-data-science-in-python)
- [Spatial](https://data.cdrc.ac.uk/)
- [r-spatial](https://www.r-spatial.org/)
- [Fast GeoSpatial Analysis in Python](http://matthewrocklin.com/blog/work/2017/09/21/accelerating-geopandas-1)
- [Spatial Data in R: New Directions](https://edzer.github.io/UseR2017/) Edzer Pebesma
- [A gentle INLA tutorial](https://www.precision-analytics.ca/blog-1/inla)


> 此节附录最后可以删掉

下面是用一段 Python 代码导出谷歌浏览器的所有书签

```bash
python py-chrome-bookmarks-markdown.py bookmarks.md
```

**Optimization**

- [Hyperparameter Optimization in H2O: Grid Search, Random Search and the Future – H2O blog](http://blog.h2o.ai/2016/06/hyperparameter-optimization-in-h2o-grid-search-random-search-and-the-future/)
- [R Optimization Test - Quantitative Finance Collector](http://www.mathfinance.cn/r-optimization-test/)
- [Research Seminar: Optimization](http://statmath.wu.ac.at/courses/optimization/)
- [Home - Statistics Views](http://www.statisticsviews.com/view/index.html)
- [Vasicek model - Wikiwand](https://www.wikiwand.com/en/Vasicek_model)
- [CIR模型Cox–Ingersoll–Ross model - Wikipedia, the free encyclopedia](https://en.wikipedia.org/wiki/Cox%E2%80%93Ingersoll%E2%80%93Ross_model)
- [BARON Software | Sahinidis](http://archimedes.cheme.cmu.edu/?q=baron)
- [竞赛列表-DataCastle大数据竞赛平台](http://www.pkbigdata.com/static_page/cmpList.html)
- [COIN-OR: Computational Infrastructure for Operations Research | Open-source Software for the Operations Research Community](https://www.coin-or.org/)
- [Portfolio Optimization in R, Part 4 | R-bloggers](https://www.r-bloggers.com/portfolio-optimization-in-r-part-4/)

**时间序列分析**

- [TensorFlow for Foreign Exchange Market: Analyzing Time-Series Data - Blog on All Things Cloud Foundry](https://blog.altoros.com/tensorflow-for-foreign-exchange-market-analyzing-time-series-data.html)
- [Predicting Heavy and Extreme Losses in Real-Time for Portfolio Holders (2) | Quant at Risk](http://www.quantatrisk.com/2015/12/06/predicting-heavy-and-extreme-losses-in-real-time-for-portfolio-holders-2/)
- [Why time series forecasts prediction intervals aren't as good as we'd hope](http://ellisp.github.io/blog/2016/12/07/arima-prediction-intervals)
- [Error, trend, seasonality - ets and its forecast model friends](http://ellisp.github.io/blog/2016/11/27/ets-friends)
- [Dual axes time series plots with various more awkward data](http://ellisp.github.io/blog/2016/08/28/dualaxes2)

R 语言

- [Togaware – Resources for the Data Scientist](https://togaware.com/)
- [ParallelR高性能并行计算与R语言](http://www.parallelr.com/)
- [R-Ladies global tour ](http://www.masalmon.eu/2017/10/06/globalrladiestour/)
- [R-Ladies Global – R-Ladies is a world-wide organization to promote gender diversity in the R community](http://rladies.org/)
- [Shane Lynn - Data science, analytics, and Startups](https://www.shanelynn.ie/)
- [Open Source Projects | NumFOCUS](https://www.numfocus.org/open-source-projects/)
- [DataScience+ An online community for showcasing R & Python tutorials](https://datascienceplus.com/)
- [Latest Posts – So Simple Theme](https://mmistakes.github.io/so-simple-theme/)
- [Video Tutorial of PSO implementation in MATLAB](http://yarpiz.com/440/ytea101-particle-swarm-optimization-pso-in-matlab-video-tutorial)
- [Statistics.com - Course List - Online Courses](http://www.statistics.com/course-catalog/)
- [me nugget](http://menugget.blogspot.jp/)
- [Time Series Analysis and Its Applications: With R Examples - tsa4](http://www.stat.pitt.edu/stoffer/tsa4/)
- [(code实战)机器学习方法和性能比较](http://rpubs.com/m3cinc/Benchmarking_20_Machine_Learning_Models_Accuracy_and_Speed)
- [ggplot2 – The R graph Gallery](http://www.r-graph-gallery.com/portfolio/ggplot2-package/)
- [quantumobject/docker-shiny - Docker Hub](https://hub.docker.com/r/quantumobject/docker-shiny/)
- [ggplot2绘图库](http://www.sthda.com/english/)
- [Highcharter 商业](http://jkunst.com/highcharter/)
- [john-coene.com](http://john-coene.com/)
- [Deep Learning in R – R Blog](http://www.rblog.uni-freiburg.de/2017/02/07/deep-learning-in-r/)
- [Zelig 统计推断方法合集](https://zeligproject.org/)
- [Paul Murrell's Home Page](https://www.stat.auckland.ac.nz/~paul/)
- [Data Science Accelerator for Credit Risk Prediction (Revolutions)](http://blog.revolutionanalytics.com/2017/07/credit-risk-prediction.html)
- [Credit Card Fraud Detection | Kaggle](https://www.kaggle.com/dalpozz/creditcardfraud)

**Python**

- [Jupyter Notebook Viewer](http://nbviewer.jupyter.org/)
- [Pyomo](http://www.pyomo.org/)
- [Bokeh Docs](http://bokeh.pydata.org/en/latest/)
- [NumPy Tutorial: Data analysis with Python](https://www.dataquest.io/blog/numpy-tutorial-python/)
- [scikit-learn: machine learning in Python — scikit-learn 0.18.1 documentation](http://scikit-learn.org/stable/)
- [Introduction to NumPy and Matplotlib - YouTube](https://www.youtube.com/watch?v=3Fp1zn5ao2M&feature=plcp)
- [Data Science, Analytics and Big Data discussions](https://discuss.analyticsvidhya.com/)
- [The Python Graph Gallery – Visualizing data – with Python](https://python-graph-gallery.com/)
- [Data science, data analysis, and data engineering tutorials and articles.](https://www.dataquest.io/blog/)
- [ŷhat | Image Processing with scikit-image](http://blog.yhat.com/posts/image-processing-with-scikit-image.html)

**社交网络**

- [Using the iGraph package to Analyse the Enron Corpus](http://r.prevos.net/analyse-enron-corpus/)
- [Help Us Map TrumpWorld](https://www.buzzfeed.com/johntemplon/help-us-map-trumpworld?utm_term=.rx9NY9Ldb#.ja8P4p9LY)
- [Enron Email Dataset](https://www.cs.cmu.edu/~./enron/)
- [Statnet](http://statnet.org/)
- [Mining Twitter with R](https://sites.google.com/site/miningtwitter/)
- [graphTweets](http://john-coene.com/packages/graphTweets/)
- [Building Wordclouds in R | DataScience+](https://datascienceplus.com/building-wordclouds-in-r/)
- [API - 微博API](http://open.weibo.com/wiki/API%E6%96%87%E6%A1%A3_V2?sudaref=jianl.org&retcode=6102)
- [Introducing tidygraph](http://www.data-imaginist.com/2017/Introducing-tidygraph/)
- [Network analysis of Game of Thrones | DataScience+](https://datascienceplus.com/network-analysis-of-game-of-thrones/)
- [Using R packages and education to scale Data Science at Airbnb – Airbnb Engineering & Data Science – Medium](https://medium.com/airbnb-engineering/using-r-packages-and-education-to-scale-data-science-at-airbnb-906faa58e12d)
- [RPubs - Twitter Coverage of the ISMB/ECCB Conference 2017](http://rpubs.com/neilfws/295865)
- [UCI Network Data Repository](https://networkdata.ics.uci.edu/)

**课程**

- [DS-GA 1003: Machine Learning and Computational Statistics, Spring 2015](http://davidrosenberg.github.io/ml2015/#home)
- [卡内基梅隆大学Machine Learning课程](http://www.cs.cmu.edu/~tom/10701_sp11/hws.shtml)
- [课程列表: Deep Learning](http://eclass.cc/courselists/117_deep_learning)
- [(概率图模型-卡内基梅隆大学) Probabilistic Graphical Models](http://www.cs.cmu.edu/~epxing/Class/10708/lecture.html)
- [Learning Deep Learning课程资料大集合](http://rt.dgyblog.com/ref/ref-learning-deep-learning.html)
- [课程Theoretical Machine Learning](http://www.cs.princeton.edu/courses/archive/spring14/cos511/schedule.html)
- [机器学习算法观](http://people.csail.mit.edu/moitra/409.html)
- [(伯克利大学)机器学习导论课程Introduction to Machine Learning](http://www.cs.berkeley.edu/~jrs/189/)
- [Intro to Apache Spark Training - Part 3 - YouTube](https://www.youtube.com/watch?v=Cxv_ERVKYE4)
- [李宏毅深度学习(2017)_演讲•公开课_科技_bilibili_哔哩哔哩](http://www.bilibili.com/video/av9770302/)
- [1.1 《机器学习中的神经网络》为什么我们需要机器学习？_腾讯视频](https://v.qq.com/x/page/t0384c1p2em.html)
- [In-depth introduction to machine learning in 15 hours of expert videos](http://www.dataschool.io/15-hours-of-expert-machine-learning-videos/)
- [Gephi 中文教程 | Udemy](https://www.udemy.com/gephi/learn/v4/overview)

**Deep Learning**

- [PyTorch](http://pytorch.org/)
- [Caffe 2 | Caffe2](https://caffe2.ai/)
- [[福利] 深入理解 RNNs & LSTM 网络学习资料 - 简书](http://www.jianshu.com/p/c930d61e1f16?from=timeline)
- [TensorFlow中文社区-首页](http://tensorfly.cn/)
- [Deep Learning in Energy Production context (wind, gas and oil)](https://amundtveit.com/)
- [Off the convex path](http://www.offconvex.org/)
- [The Neural Network Zoo - The Asimov Institute](http://www.asimovinstitute.org/neural-network-zoo/)
- [Yann LeCun's Home Page](http://yann.lecun.com/)
- [Yoshua Bengio](http://www.iro.umontreal.ca/~bengioy/yoshua_en/index.html)
- [Ian Goodfellow --- Research Page](http://www.iangoodfellow.com/)
- [Time Series Prediction With Deep Learning in Keras - Machine Learning Mastery](http://machinelearningmastery.com/time-series-prediction-with-deep-learning-in-python-with-keras/)
- [迁移学习 Keras R](https://flovv.github.io/Logo_detection_transfer_learning/)
- [Information Systems Research](https://www.is.uni-freiburg.de/)
- [The Ultimate List of TensorFlow Resources: Books, Tutorials & More - Hacker Lists](https://hackerlists.com/tensorflow-resources/)
- [Neural Networks from Scratch, in R (Revolutions)](http://blog.revolutionanalytics.com/2017/07/nnets-from-scratch.html)
- [[机器学习入门] 李宏毅机器学习笔记](http://blog.csdn.net/soulmeetliang)
- [Center for Machine Learning and Intelligent Systems | University of California, Irvine](http://cml.ics.uci.edu/)
- [(支持向量机算法)LIBSVM -- A Library for Support Vector Machines](http://www.csie.ntu.edu.tw/~cjlin/libsvm/)

**软件测试**

- [Jenkins](https://jenkins.io/)
- [Centos | Docker中文教程](https://letong.gitbooks.io/docker/content/install/centos.html)
- [Ubuntu – Ubuntu Packages Search](https://packages.ubuntu.com/)
- [Pandoc - Pandoc User’s Guide](http://pandoc.org/MANUAL.html#pandocs-markdown)

**LaTeX**

- [始终](https://liam0205.me/)
- [风陵渡](http://wangmurong.org.cn/)
- [fitsir的博客](https://fitsir.me/)
- [Ethlisan | Ethan DENG's Personal Homepage](http://ddswhu.com/)
- [Cyberspace of Shujun LI李树钧](http://www.hooklee.com/)
- [LaTeX写作专栏 – |经常|](http://blog.feieee.com/latex)
- [在线 LaTeX 公式编辑器](http://www.codecogs.com/latex/eqneditor.php)
- [Beamer Matrix](https://mpetroff.net/files/beamer-theme-matrix/)
- [ChinaTeX-Tex&LaTeX are your typesetting friends.](http://www.chinatex.org/)
- [LaTeX Templates](http://www.latextemplates.com/)
- [Overleaf](https://www.overleaf.com/)
- [Introduction | Learning-Markdown (Markdown 入门参考)](http://xianbai.me/learn-md/index.html)
- [MathJax | Beautiful math in all browsers.](https://www.mathjax.org/)
- [Pandoc - About pandoc](https://pandoc.org/)
- [TikZ and PGF | TeXample.net](http://www.texample.net/tikz/)
- [Rants from the Lab](http://liantze.penguinattack.org/)

- [国家企业信用信息公示系统](http://www.gsxt.gov.cn/index.html)
- [Linux命令大全(手册)_Linux常用命令行实例详解_Linux命令学习手册](http://man.linuxde.net/)
- [生命不息 | 张宏伦的个人博客](http://zhanghonglun.cn/blog/)
- [大赛列表页](https://tianchi.aliyun.com/competition/gameList.htm)
- [城市数据派-首页](https://www.udparty.com/index.php)
- [研趣网 - 首个可视化商业价值挖掘和传播社区](http://www.rinterest.cn/)
- [inFERENCe](http://www.inference.vc/)
- [MSDN, 我告诉你](http://msdn.itellyou.cn/)
- [RegExr: Learn, Build, & Test RegEx](https://regexr.com/)
- [rud.is | "In God we trust. All others must bring data"](https://rud.is/b/)
- [北京理工大学 开源软件镜像服务](http://mirror.bit6.edu.cn/web/)
- [Statistics authors/titles recent submissions](http://arxiv.org/list/stat/recent)
- [Wolfram|Alpha: Computational Knowledge Engine](http://www.wolframalpha.com/?source=nav)
- [中国科技论文在线](http://www.paper.edu.cn/)
- [我是菜鸟 | IMCN开源资讯网](https://imcn.me/)

- [USGS.gov](https://www.usgs.gov/)
- [Index of /download/ensembles/data/Grid_0.44deg_rot](http://www.ecad.eu/download/ensembles/data/Grid_0.44deg_rot/)
- [The Stan Forums](http://discourse.mc-stan.org/)
- [论坛 - 六维空间 - 教育科研网分享测试平台](http://bt.neu6.edu.cn/forum.php)
- [免费在线电影-新剧集影院官网-支持手机观看](http://www.xinjuji.com/index.html)
- [CCTV-1 综合频道高清直播](http://tv.cctv.com/live/cctv1/)
- [BYR-IPTV](http://tv.byr.cn/tv-show-detail/78)
- [七牛云-国内领先的企业级云服务商](https://www.qiniu.com/)
- [RStudio Community](https://community.rstudio.com/)
- [电影天堂_免费电影_迅雷电影下载](http://www.dytt8.net/)
- [80s电影网 - 高清手机电影迅雷下载_最新MP4电视剧磁力下载](https://www.80s.tw/)
- [Google](https://www.google.com/)
- [gen.lib.rus.ec](http://gen.lib.rus.ec/)
- [Octave Online · Cloud IDE compatible with MATLAB](https://octave-online.net/#cmd=peaks)

<!--chapter:end:bookmarks.Rmd-->

```{r include=FALSE, cache=FALSE}
library(methods)
set.seed(2018)
options(digits = 3)

Pkgs <- c(
  "reticulate",
  "showtext", "sysfonts", "showtextdb",
  "fontcm",
  "tikzDevice", "filehash", "png",
  "xkcd", "extrafontdb", "Rttf2pt1", "extrafont"
)
if (length(setdiff(Pkgs, .packages(TRUE))) > 0) {
  install.packages(setdiff(Pkgs, .packages(TRUE)))
}

if (!all(c("source-han-sans-cn", "source-han-serif-cn") %in% showtextdb::font_installed())) {
  showtextdb::font_install(showtextdb::source_han_serif("CN"))
  showtextdb::font_install(showtextdb::source_han_sans("CN"))
}
extrafont::font_install("fontcm")
extrafont::loadfonts()

if (!"xkcd" %in% extrafont::fonts()) {
  path <- path.expand("~/.fonts")
  if (!file.exists(path)) {
    dir.create(path = path.expand("~/.fonts"))
  }
  download.file("http://simonsoftware.se/other/xkcd.ttf", dest = path.expand("~/.fonts/xkcd.ttf"), mode = "wb")
  extrafont::font_import(paths = path.expand("~/.fonts"), pattern = "[X/x]kcd", prompt = FALSE)
  extrafont::loadfonts()
}

extrafont::fonts() # registered with pdfFonts()
sysfonts::font_families() # List available font families

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = TRUE,
  cache = TRUE,
  citation.bibtex.max=999,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  # fig.showtext = TRUE, # too danger
  fig.asp = 0.618, # 1 / phi
  # fig.show = "hold", # not for python matplotlib
  fig.ext = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  dev = if (knitr::is_html_output()) "svg" else if (knitr::is_latex_output()) "pdf" else "png",
  engine.path = list(
    octave = "/usr/bin/octave-cli"
  )
)
ext <- if (knitr::is_html_output()) ".svg" else if (knitr::is_latex_output()) ".pdf" else ".png"

# knitr::knit_hooks$set(optipng = knitr::hook_optipng, pdfcrop = knitr::hook_pdfcrop)

# https://github.com/yihui/knitr-examples/blob/master/085-pdfcrop.Rnw
# knitr::knit_hooks$set(crop = hook_pdfcrop)
options(
  repos = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/",
  tikzDefaultEngine = "xetex",
  tikzXelatexPackages = c(
    getOption("tikzXelatexPackages"),
    "\\usepackage[colorlinks, breaklinks]{hyperref}",
    "\\usepackage{color}",
    "\\usepackage{tikz}",
    "\\usepackage[active,tightpage,xetex]{preview}",
    "\\PreviewEnvironment{pgfpicture}",
    "\\usepackage{amsmath}",
    "\\usepackage{amsfonts}",
    "\\usepackage{mathrsfs}"
  )
)
# https://github.com/yihui/knitr-examples/blob/master/047-tikz-png.Rnw
# knitr::knit_hooks$set(tikz2png = function(before, options, envir) {
  # use this hook only for dev='tikz' and externalized tikz graphics
  # if (before || options$dev != "tikz" || !options$external || options$fig.num == 0) return()
  # figs <- knitr:::all_figs(options, ext = "pdf") # all figure names
  # note the tikz2png option is the extra parameters passed to 'convert'
  # for (fig in figs) {
    # system(sprintf("convert %s %s %s", options$tikz2png, fig, sub("\\.pdf$", ".png", fig)))
  # }
# })


is_on_travis = identical(Sys.getenv("TRAVIS"), "true")
is_online = curl::has_internet()

library(reticulate)
if(is_on_travis) use_virtualenv("shims") else use_python("/usr/bin/python", required = FALSE)
# Python 环境的描述在附录
# required = FALSE 默认值，如果按照指定的位置没有找到 Python 就会扫描其它版本
# use_python("/opt/pyenv/shims/python")
# use_virtualenv("shims")

# 设置环境变量 RSTUDIO_CONNECT_SERVER 由 travis-ci 设置
connectServer <- Sys.getenv("RSTUDIO_CONNECT_SERVER") # https://bookdown.org
apiKey <- Sys.getenv("RSTUDIO_CONNECT_API_KEY")
```
`r if (knitr::is_html_output()) '
# 参考文献 {#references .unnumbered}
'`

<!--chapter:end:27-references.Rmd-->

