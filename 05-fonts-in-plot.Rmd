# 字体

```{r setup, include = FALSE}
source("common.R")
library(showtext)
# Install Source Han Sans/Serif font (by default Simplified Chinese)
font_install(source_han_serif("CN")) # 思源宋体
font_install(source_han_sans("CN"))  # 思源黑体
```

字体设置包括自定义中文字体、英文字体和数学公式。

## showtext 

下载和安装 showtext 包[@Qiu2015]，下载并加载思源字体

```{r font-setup, eval= (!"showtext" %in% .packages(TRUE))}
install.packages("showtext",dependencies = TRUE)
```

showtext 包可以调用系统字体，图\@ref(fig:demo-ggplot2)使用5号思源宋体，英文和数字使用 serif 字体。详细的使用文档可以看 [showtext 的开发页面](https://github.com/yixuan/showtext)

```{r demo-ggplot2, fig.showtext = TRUE,fig.cap="showtext包处理图里的中文"}
library(ggplot2)
ggplot(iris, aes(Sepal.Length, Sepal.Width)) +
  geom_point(aes(colour = Species)) +
  scale_colour_brewer(palette = "Set1") +
  labs(
    title = "鸢尾花数据的散点图",
    x = "萼片长度", y = "萼片宽度", colour = "鸢尾花类别"
  ) +
  theme_minimal(base_size = 10.54, base_family = "source-han-serif-cn") +
  theme(
    legend.text = element_text(family = "serif", size = 10.54),
    axis.text = element_text(family = "serif", size = 10.54)
    )
```

用 ggplot2 画个简单地图，地图数据在 mapdata 包 [@R-mapdata]

```{r install-spatial, eval = (!"mapproj" %in% .packages(TRUE))}
install.packages(c("maps", "mapdata", "mapproj"), dependencies = TRUE)
```

如图 \@ref(fig:map-Fiji-earthquake) 所示

```{r map-Fiji-earthquake, fig.showtext=TRUE,fig.cap="斐济地震带"}
library(maps)
library(mapdata)
FijiMap <- map_data("worldHires", region = "Fiji")
ggplot(FijiMap, aes(x = long, y = lat)) +
  geom_map(map = FijiMap, aes(map_id = region), size = .2) +
  geom_point(data = quakes, aes(x = long, y = lat, colour = mag), pch = 16) +
  xlim(160, 195) +
  scale_colour_distiller(palette = "Spectral") +
  scale_y_continuous(breaks = (-18:18) * 5) +
  coord_map("ortho", orientation = c(-10, 180, 0)) +
  labs(colour = "震级", x = "经度", y = "纬度", title = "斐济地震带") +
  theme_minimal() +
  theme(
    title = element_text(family = "source-han-sans-cn"),
    axis.title = element_text(family = "source-han-serif-cn"),
    legend.title = element_text(family = "source-han-sans-cn"),
    legend.position = c(1, 0), legend.justification = c(1, 0)
  )
```

用 base plot 画地图，如图 \@ref(fig:maps-unemp-plot) 所示

```{r maps-unemp-plot, fig.cap="2009年美国各城镇失业率",fig.width=8,fig.height=6}
library(mapproj) 	
data(unemp)
data(county.fips)
colors <- c("#F1EEF6", "#D4B9DA", "#C994C7", "#DF65B0", "#DD1C77", "#980043")
unemp$colorBuckets <- as.numeric(cut(unemp$unemp, c(0, 2, 4, 6, 8, 10, 100)))
leg.txt <- c("<2%", "2-4%", "4-6%", "6-8%", "8-10%", ">10%")
cnty.fips <- county.fips$fips[match(map("county", plot=FALSE)$names,
                                    county.fips$polyname)]
colorsmatched <- unemp$colorBuckets[match(cnty.fips, unemp$fips)]
op <- par(mar=c(0,0,2,0))
# draw map
map("county", col = colors[colorsmatched], fill = TRUE, resolution = 0,
    lty = 0, projection = "polyconic")
map("state", col = "white", fill = FALSE, add = TRUE, lty = 1, lwd = 0.2,
    projection="polyconic")
title("unemployment by county, 2009")
legend("top", leg.txt, horiz = TRUE, fill = colors)
par(op)  
```

## xkcd

这篇文章主要使用 ggplot2 包[@Wickham2016]绘图，为了好玩我们还使用 xkcd 字体，先下载和加载 xkcd 包[@R-xkcd]，它提供一个 gg 风格的图层`theme_xkcd()`

```{r xkcd-setup, eval=(!"xkcd" %in% .packages(TRUE))}
install.packages("xkcd",dependencies = TRUE)
```

下载和注册 xkcd 字体

```{r download-xkcd, eval= (!'xkcd' %in% extrafont::fonts())}
download.file("http://simonsoftware.se/other/xkcd.ttf",
  dest = "xkcd.ttf", mode = "wb"
)
system("mkdir ~/.fonts")
system("cp xkcd.ttf ~/.fonts")
library(extrafont)
font_import(pattern = "[X/x]kcd", prompt = FALSE)
if (.Platform$OS.type != "unix") {
  ## Register fonts for Windows bitmap output
  loadfonts(device = "win")
} else {
  loadfonts() # 加载字体
}
fonts() # 查看可用的字体
```

图 `r ifelse(knitr::is_html_output(),'\\@ref(fig:xkcd-demo)','\\@ref(fig:xkcd-embed)') ` 是一个简单使用 xkcd 字体的例子

```{r xkcd-demo, fig.cap = "xkcd 风的图", eval = knitr::is_html_output()}
# pdf(file = 'figures/xkcd.pdf',width = 6,height = 4)
library(xkcd)
ggplot(aes(mpg, wt), data = mtcars) + geom_point() +
    theme_xkcd()
# dev.off()
# embed_fonts("figures/xkcd.pdf", outfile = "figures/xkcd_embed.pdf")
```

```{r xkcd-embed,fig.cap = "xkcd 风的图", eval= knitr::is_latex_output(), echo=FALSE}
knitr::include_graphics("figures/xkcd_embed.pdf")
```

## fontcm

安装 fontcm 包[@R-fontcm]处理数学公式，下载 fontcm 包^[<https://github.com/wch/fontcm>] 和相关字体

```{r download-fontcm, eval=(!"fontcm" %in% .packages(TRUE))}
library(extrafont)
install.packages("fontcm",dependencies = TRUE)
# 或 font_install('fontcm') 
loadfonts() # 加载字体
```

使用 fontcm 包，一个小 demo 如下

```r
library(fontcm)
p <- qplot(c(1, 5), c(1, 5)) +
  xlab("Made with CM fonts") + ylab("Made with CM fonts") +
  ggtitle("Made with CM fonts")
# Equation
eq <- "italic(sum(frac(1, n*'!'), n==0, infinity) ==
       lim(bgroup('(', 1 + frac(1, n), ')')^n, n %->% infinity))"
# Without the new fonts
p1 <- p + annotate("text", x = 3, y = 3, parse = TRUE, label = eq) # fig 1
# With the new fonts
p2 <- p + annotate("text",
  x = 3, y = 3, parse = TRUE,
  family = "CM Roman", label = eq
) +
  theme(
    text = element_text(size = 16, family = "CM Roman"),
    axis.title.x = element_text(face = "italic"),
    axis.title.y = element_text(face = "bold")
  ) # fig 2
library(gridExtra)
grid.arrange(p1,p2, nrow = 1, ncol = 2)
```

保存成图片

```r
pdf(file = 'figures/ggplot_cm.pdf',width = 8,height = 4)
grid.arrange(p1,p2, nrow = 1, ncol = 2)
dev.off()
```

使用 ghostscript 嵌入数学字体，最终效果如图\@ref(fig:fontcm-ggplot)所示，

```{r embed,eval=FALSE}
# Embed the fonts
embed_fonts("figures/ggplot_cm.pdf", outfile = "figures/ggplot_cm_embed.pdf")
```
```{r fontcm-ggplot, echo=FALSE,fig.cap="fontcm 处理数学公式"}
knitr::include_graphics("figures/ggplot_cm_embed.png")
```

## tikzDevice

tikz 源于 LaTeX 宏包，在 R 语言绘图的世界里，对基础图形有很好的支持，如图 \@ref(fig:tikz-demo)

```{r install-tikzDevice, eval = (!"tikzDevice" %in% .packages(TRUE))}
install.packages("tikzDevice")
```

先测试一下

```{r test-tikz-device}
tikzDevice::tikzTest()
```

坐标轴标签，标题，图例等位置都支持数学公式

```{r tikz-demo, dev='tikz', fig.cap="线性模型"}
x <- rnorm(10)
y <- x + rnorm(5, sd = 0.25)
model <- lm(y ~ x)
rsq <- summary(model)$r.squared
rsq <- signif(rsq, 4)
plot(x, y, main = "Hello \\LaTeX!", xlab = "$x$", ylab = "$y$", 
     sub = "$\\mathcal{N}(\\mathbf{x};\\mu,\\Sigma)$")
abline(model, col = "red")
mtext(paste("Linear model: $R^{2}=", rsq, "$"), line = 0.5)
legend("bottomright", legend = paste0("$y = ", 
                                     round(coef(model)[2], 3),
                                     "x +", 
                                     round(coef(model)[1], 3), 
                                     "$"
                                     ), 
       bty = "n")
```

虽然复杂图片也可直接用 tikz 制作但是，尺寸等细节不好调整（我还没找到合适的方法），比较合适的做法可能是，独立制作图，然后作为图片插入，以一个颇具复杂度的图片为例，如图 \@ref(fig:plot3d-tikz)


```{r plot3d-tikz, dev='tikz',fig.cap="tikz 之复杂公式", fig.asp = 0.85}
# 代码来自  http://www.ejwagenmakers.com/misc/Plotting_3d_in_R.pdf
# 3-D plots
mu1 <- 0 # setting the expected value of x1
mu2 <- 0 # setting the expected value of x2
s11 <- 10 # setting the variance of x1
s12 <- 15 # setting the covariance between x1 and x2
s22 <- 10 # setting the variance of x2
rho <- 0.5 # setting the correlation coefficient between x1 and x2
x1 <- seq(-10, 10, length = 41) # generating the vector series x1
x2 <- x1 # copying x1 to x2
f <- function(x1, x2) {
  term1 <- 1 / (2 * pi * sqrt(s11 * s22 * (1 - rho^2)))
  term2 <- -1 / (2 * (1 - rho^2))
  term3 <- (x1 - mu1)^2 / s11
  term4 <- (x2 - mu2)^2 / s22
  term5 <- -2 * rho * ((x1 - mu1) * (x2 - mu2)) / (sqrt(s11) * sqrt(s22))
  term1 * exp(term2 * (term3 + term4 - term5))
} # setting up the function of the multivariate normal density
z <- outer(x1, x2, f) # calculating the density values
nrz <- nrow(z)
ncz <- ncol(z)
# Create a function interpolating colors in the range of specified colors
# jet.colors <- colorRampPalette( c("blue", "green") )
# Generate the desired number of colors from this palette
nbcol <- 100
# color <- jet.colors(nbcol)
color <- viridisLite::viridis(100)
# Compute the z-value at the facet centres
zfacet <- z[-1, -1] + z[-1, -ncz] + z[-nrz, -1] + z[-nrz, -ncz]
# Recode facet z-values into color indices
facetcol <- cut(zfacet, nbcol)
# persp 坐标轴标签不支持表达式 ?persp

# 使用 tikzDevice 打造出版级的效果图
# library(tikzDevice)
# tf <- file.path(getwd(), "figures/binormal.tex")

# tikz(tf, width = 6, height = 5.5, pointsize = 30, standAlone = TRUE)
op <- par(mar = c(2, 3, 3, 0.5))
persp(x1, x2, z,
  xlab = "$x_{1}$",
  ylab = "$x_{2}$",
  zlab = "$f(\\mathsf{x})$",
  main = "Two dimensional Normal Distribution",
  col = color[facetcol], border = NA, theta = 30, phi = 20,
  r = 50, d = 0.1, expand = 0.5, ltheta = 90, lphi = 180,
  shade = 0.1, ticktype = "detailed", nticks = 5, box = TRUE
) # produces the 3-D plot
# adding a text line to the graph
mtext("$\\mu_1 = 0,\\mu_2 = 0,\\sigma_{11} = 10,\\sigma_{22} = 10,\\sigma_{12} = 15, \\rho = 0.5$", side = 3)
mtext("$f(\\mathsf{x}) = \\frac{1}{2\\pi\\sqrt{\\sigma_{11}\\sigma_{22}(1-\\rho^2)}}\\exp\\big\\{-\\frac{1}{2(1-\\rho^2)}[\\frac{(x_1 - \\mu_1)^2}{\\sigma_{11}} - 2\\rho\\frac{(x_1 - \\mu_1)(x_2 - \\mu_2)}{\\sqrt{\\sigma_{11}}\\sqrt{\\sigma_{22}}} + \\frac{(x_2 - \\mu_2)^2}{\\sigma_{22}}]\\big\\}$", side = 1)
par(op)
# dev.off()

# tinytex::latexmk(file = "figures/binormal.tex")
```

